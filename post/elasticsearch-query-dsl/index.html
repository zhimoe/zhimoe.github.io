<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>理解 Elasticsearch Query DSL 中的 JSON 结构 - 新街记事</title>
<meta property="og:title" content="理解 Elasticsearch Query DSL 中的 JSON 结构 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="理解 ES 搜索中 JSON DSL 有助于自己写 JSON 查询，特别是手写复杂嵌套 json。
[&amp;hellip;] { &amp;#34;mappings&amp;#34;: { &amp;#34;_doc&amp;#34;: { &amp;#34;properties&amp;#34;: { &amp;#34;city&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;text&amp;#34;, &amp;#34;fields&amp;#34;: { &amp;hellip;"><meta property="og:description" content="理解 ES 搜索中 JSON DSL 有助于自己写 JSON 查询，特别是手写复杂嵌套 json。
[&amp;hellip;] { &amp;#34;mappings&amp;#34;: { &amp;#34;_doc&amp;#34;: { &amp;#34;properties&amp;#34;: { &amp;#34;city&amp;#34;: { &amp;#34;type&amp;#34;: &amp;#34;text&amp;#34;, &amp;#34;fields&amp;#34;: { &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>理解 Elasticsearch Query DSL 中的 JSON 结构</h1><h3 class=meta-line><span><span class=date>2019-05-01</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/elasticsearch/ class=term-tag>#elasticsearch</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#没有-string-类型改为-text-和-keyword-2-个类型text-字段可以指定-fields-来不分词如下city-字段被-ingest-为-city-和-cityraw-2-个字段>没有 string 类型，改为 text 和 keyword 2 个类型。text 字段可以指定 fields 来不分词。如下：city 字段被 ingest 为 city 和 city.raw 2 个字段。</a></li><li><a href=#default-double---float>default double -> float</a></li><li><a href=#geo_point>geo_point</a></li></ul><ul><li><a href=#basic-query>basic query</a><ul><li><a href=#multi_match>multi_match</a></li><li><a href=#query_string-和--simple_query_string>query_string 和 simple_query_string</a></li><li><a href=#termterms-完全匹配>term、terms 完全匹配</a></li><li><a href=#prefix>prefix</a></li></ul></li><li><a href=#组合查询>组合查询</a><ul><li><a href=#bool>bool</a></li></ul></li></ul></nav><p>理解 ES 搜索中 JSON DSL 有助于自己写 JSON 查询，特别是手写复杂嵌套 json。</p><ul><li><input checked disabled type=checkbox> diffs in es 2.x and es 5.x</li><li><input checked disabled type=checkbox> query dsl</li><li><input checked disabled type=checkbox> aggr query</li></ul><h1 id=diffs-in-es-2x-and-es-5x>diffs in es 2.x and es 5.x</h1><h2 id=没有-string-类型改为-text-和-keyword-2-个类型text-字段可以指定-fields-来不分词如下city-字段被-ingest-为-city-和-cityraw-2-个字段>没有 string 类型，改为 text 和 keyword 2 个类型。text 字段可以指定 fields 来不分词。如下：city 字段被 ingest 为 city 和 city.raw 2 个字段。</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;mappings&#34;: {
</span></span><span style=display:flex><span>        &#34;_doc&#34;: {
</span></span><span style=display:flex><span>            &#34;properties&#34;: {
</span></span><span style=display:flex><span>                &#34;city&#34;: {
</span></span><span style=display:flex><span>                    &#34;type&#34;: &#34;text&#34;,
</span></span><span style=display:flex><span>                    &#34;fields&#34;: {
</span></span><span style=display:flex><span>                        &#34;raw&#34;: {
</span></span><span style=display:flex><span>                            &#34;type&#34;: &#34;keyword&#34;,
</span></span><span style=display:flex><span>                            &#34;ignore_above&#34;: 256
</span></span><span style=display:flex><span>                        }
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>  
</span></span></code></pre></div><h2 id=default-double---float>default double -> float</h2><h2 id=geo_point>geo_point</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>//2.x
</span></span><span style=display:flex><span>&#34;location&#34;: {
</span></span><span style=display:flex><span>    &#34;type&#34;: &#34;geo_point&#34;,
</span></span><span style=display:flex><span>    &#34;lat_lon&#34;: true,
</span></span><span style=display:flex><span>    &#34;geohash&#34;: true,
</span></span><span style=display:flex><span>    &#34;geohash_prefix&#34;: true,
</span></span><span style=display:flex><span>    &#34;geohash_precision&#34;: &#34;1m&#34;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>//5.x
</span></span><span style=display:flex><span>&#34;location&#34;: {
</span></span><span style=display:flex><span>    &#34;type&#34;: &#34;geo_point&#34;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h1 id=query-dsl>query dsl</h1><h2 id=basic-query>basic query</h2><p>就像砌房子的砖头，基本查询就是 ES 查询的砖头。基本查询是组合查询 (bool 查询等) 的单元。基本查询有：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>//basic query element
</span></span><span style=display:flex><span>match,
</span></span><span style=display:flex><span>multi_match,
</span></span><span style=display:flex><span>common,
</span></span><span style=display:flex><span>geoshape,
</span></span><span style=display:flex><span>ids,
</span></span><span style=display:flex><span>match_all,
</span></span><span style=display:flex><span>query_string,
</span></span><span style=display:flex><span>simple_query_string,
</span></span><span style=display:flex><span>range,
</span></span><span style=display:flex><span>prefix,
</span></span><span style=display:flex><span>regexp,
</span></span><span style=display:flex><span>span_term, 
</span></span><span style=display:flex><span>term,
</span></span><span style=display:flex><span>terms,
</span></span><span style=display:flex><span>wildcard
</span></span></code></pre></div><p>其中<code>common, ids, prefix, span_term, term, terms, wildcard</code> 是不分析搜索 (即不能用于 text 字段) ，<code>match, multi_match, query_string, simple_query_string</code>是全文检索，几乎可以确保可以返回结果。而<code>prefix,regexp,wildcard</code>是模式检索。这里分别给一些例子：</p><h3 id=multi_match>multi_match</h3><blockquote><p>multi_match 查询为能在多个字段上反复执行相同查询提供了一种便捷方式<br>既然是多字段查询，则有 3 中场景:best_fields、most_fields 和 cross_fields（最佳字段、多数字段、跨字段）</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;multi_match&#34;: {
</span></span><span style=display:flex><span>        &#34;query&#34;:                &#34;Quick brown fox&#34;,
</span></span><span style=display:flex><span>        &#34;type&#34;:                 &#34;best_fields&#34;,  //默认的，可不填
</span></span><span style=display:flex><span>        &#34;fields&#34;:               [ &#34;title&#34;, &#34;body&#34; ],
</span></span><span style=display:flex><span>        &#34;tie_breaker&#34;:          0.3,
</span></span><span style=display:flex><span>        &#34;minimum_should_match&#34;: &#34;30%&#34; 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>等价于下面的形式：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#000>&#34;dis_max&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;queries&#34;</span>:  [
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;match&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#000>&#34;title&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#000>&#34;query&#34;</span>: <span style=color:#c41a16>&#34;Quick brown fox&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#000>&#34;minimum_should_match&#34;</span>: <span style=color:#c41a16>&#34;30%&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>      {
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;match&#34;</span>: {
</span></span><span style=display:flex><span>          <span style=color:#000>&#34;body&#34;</span>: {
</span></span><span style=display:flex><span>            <span style=color:#000>&#34;query&#34;</span>: <span style=color:#c41a16>&#34;Quick brown fox&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#000>&#34;minimum_should_match&#34;</span>: <span style=color:#c41a16>&#34;30%&#34;</span>
</span></span><span style=display:flex><span>          }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>      },
</span></span><span style=display:flex><span>    ],
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;tie_breaker&#34;</span>: <span style=color:#1c01ce>0.3</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>还可以使用通配符指定字段，以及给某些字段添加权重。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#000>&#34;multi_match&#34;</span>: {
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;query&#34;</span>:  <span style=color:#c41a16>&#34;Quick brown fox&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>&#34;fields&#34;</span>: [ <span style=color:#c41a16>&#34;*_title&#34;</span>, <span style=color:#c41a16>&#34;chapter_title^2&#34;</span> ] 
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=query_string-和--simple_query_string>query_string 和 simple_query_string</h3><p>非常灵活的一个查询方式：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// GET index_name/_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;query&#34;: {
</span></span><span style=display:flex><span>        &#34;query_string&#34; : {
</span></span><span style=display:flex><span>            &#34;default_field&#34; : &#34;content&#34;,
</span></span><span style=display:flex><span>            &#34;query&#34; : &#34;(new york city) OR (big apple)&#34; 
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面的 query 字段语法可以参考：<a href=https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-query-string-query.html#query-string-syntax>query_string_syntax</a></p><p><code>simple_query_string</code>不会抛出异常，而是直接忽略无效语句。</p><h3 id=termterms-完全匹配>term、terms 完全匹配</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// 不要用于 text 字段
</span></span><span style=display:flex><span>// GET /_search
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    &#34;query&#34;: {
</span></span><span style=display:flex><span>        &#34;term&#34;: {
</span></span><span style=display:flex><span>            &#34;user&#34;: {
</span></span><span style=display:flex><span>                &#34;value&#34;: &#34;Kimchy&#34;,
</span></span><span style=display:flex><span>                &#34;boost&#34;: 1.0
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>//terms 和 term 一样，不过可以指定多个值，&#34;user&#34; : [&#34;kimchy&#34;, &#34;elasticsearch&#34;]// 返回 user 为 kimchy 或 elasticsearch 的文档
</span></span></code></pre></div><h3 id=prefix>prefix</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>// user 字段 (不分词字段) 中以&#34;ki&#34;开头的文档 类似 SQL 中的 like &#39;ki%&#39;
</span></span><span style=display:flex><span>{ &#34;query&#34;: {
</span></span><span style=display:flex><span>    &#34;prefix&#34; : { &#34;user&#34; : &#34;ki&#34; }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=组合查询>组合查询</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>bool, boosting, constant_score, dis_max, function_score, has_child, has_parent, indices, nested, span_first, span_multi,span_first, 
</span></span><span style=display:flex><span>span_multi, span_near, span_not, span_or, span_term, top_children,
</span></span><span style=display:flex><span>filtered(废弃，使用 bool 包含一个 must 和一个 filter 替代)
</span></span></code></pre></div><h3 id=bool>bool</h3><p>bool 查询的外框架结构为：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        &#34;query&#34;: {
</span></span><span style=display:flex><span>            &#34;bool&#34;: {
</span></span><span style=display:flex><span>                &#34;must&#34;: [
</span></span><span style=display:flex><span>                    {}
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                &#34;should&#34;: [
</span></span><span style=display:flex><span>                    {}
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                &#34;must_not&#34;: [
</span></span><span style=display:flex><span>                    {}
</span></span><span style=display:flex><span>                ],
</span></span><span style=display:flex><span>                &#34;filter&#34;: [
</span></span><span style=display:flex><span>                    {}
</span></span><span style=display:flex><span>                ]
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>//some other parameter for bool:
</span></span><span style=display:flex><span>//boost,minimum_should_match,disable_coord
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/learn-clojure-by-example/>通过例子学习 Clojure</a></span>
<span class=post-nav-next><a href=../../post/scala-useful-snippets/>Useful Scala Code Snippets</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Java 并发 2-同步与锁 - 新街记事</title>
<meta property="og:title" content="Java 并发 2-同步与锁 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="这三个方法是在 class Object 上面的，也就是所有对象都有这个方法。这里对象就是上一篇中类比的资源，可以当成一个信号量。
Object.wait() to suspend a thread（等价于sem.wait()）。将当前线程暂停并释放当前对象锁，直到其他线程调用了当前对象的 notify/notifyAll 方法。
Object.notify() to wake a thread &amp;hellip;"><meta property="og:description" content="这三个方法是在 class Object 上面的，也就是所有对象都有这个方法。这里对象就是上一篇中类比的资源，可以当成一个信号量。
Object.wait() to suspend a thread（等价于sem.wait()）。将当前线程暂停并释放当前对象锁，直到其他线程调用了当前对象的 notify/notifyAll 方法。
Object.notify() to wake a thread &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Java 并发 2-同步与锁</h1><h3 class=meta-line><span><span class=date>2016-01-01</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/java/ class=term-tag>#java </a><a href=../../tags/%E5%B9%B6%E5%8F%91/ class=term-tag>#并发</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#objectwaitnotifynotifyall>Object.wait/notify/notifyAll</a></li><li><a href=#synchronized-和-volatile>synchronized 和 volatile</a></li><li><a href=#semaphore>Semaphore</a></li><li><a href=#countdownlatch>CountDownLatch</a></li><li><a href=#cyclicbarrier>CyclicBarrier</a></li><li><a href=#exchanger>Exchanger</a></li><li><a href=#lock>Lock</a></li></ul></nav><h3 id=objectwaitnotifynotifyall>Object.wait/notify/notifyAll</h3><p>这三个方法是在 class Object 上面的，也就是所有对象都有这个方法。这里对象就是上一篇中类比的资源，可以当成一个信号量。<br><code>Object.wait()</code> to suspend a thread（等价于<code>sem.wait()</code>）。将当前线程暂停并释放当前对象锁，直到其他线程调用了当前对象的 notify/notifyAll 方法。<br><code>Object.notify()</code> to wake a thread up（等价<code>sem.signal()</code>）。唤醒一个在等待当前对象锁的线程。<br>以前用 wait/notify 的地方，现在可以用 CyclicBarrier 和 CountDownLatch 同步工具代替</p><p>wait 方法使用模板：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>synchronized</span> (<span style=color:#000>obj</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>while</span> (<span style=color:#000>condition</span> <span style=color:#000>does</span> <span style=color:#000>not</span> <span style=color:#000>hold</span>){ <span style=color:#177500>// 这里即使线程被虚假唤醒，条件还是不满足，则继续 wait</span>
</span></span><span style=display:flex><span>        <span style=color:#000>obj</span>.<span style=color:#836c28>wait</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#177500>//... Perform action appropriate to condition</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>为什么 wait 方法必须在 synchronized 保护的同步代码中使用？因为需要保证 while 判断和 wait 两个操作是一个原子操作。</p><p>两个线程交替打印 A/B</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(<span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>PrintTask</span> <span style=color:#000>pt</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>PrintTask</span>(<span style=color:#c41a16>&#34;A&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>new</span> <span style=color:#000>Thread</span>(<span style=color:#000>pt</span>::<span style=color:#000>print</span>).<span style=color:#836c28>start</span>();
</span></span><span style=display:flex><span>            <span style=color:#a90d91>new</span> <span style=color:#000>Thread</span>(<span style=color:#000>pt</span>::<span style=color:#000>print</span>).<span style=color:#836c28>start</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>static</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>PrintTask</span> {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>private</span> <span style=color:#000>String</span> <span style=color:#000>currentChar</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>PrintTask</span>(<span style=color:#000>String</span> <span style=color:#000>initialChar</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>this</span>.<span style=color:#836c28>currentChar</span> <span style=color:#000>=</span> <span style=color:#000>initialChar</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>print</span>() {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>synchronized</span> (<span style=color:#a90d91>this</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a90d91>while</span> (<span style=color:#a90d91>true</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>Thread</span>.<span style=color:#836c28>currentThread</span>().<span style=color:#836c28>getId</span>() <span style=color:#000>+</span><span style=color:#c41a16>&#34; &#34;</span><span style=color:#000>+</span><span style=color:#000>currentChar</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>if</span> (<span style=color:#c41a16>&#34;A&#34;</span>.<span style=color:#836c28>equals</span>(<span style=color:#000>currentChar</span>)) {
</span></span><span style=display:flex><span>                        <span style=color:#000>currentChar</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;B&#34;</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>                        <span style=color:#000>currentChar</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;A&#34;</span>;
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>this</span>.<span style=color:#836c28>notifyAll</span>();
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>this</span>.<span style=color:#836c28>wait</span>();
</span></span><span style=display:flex><span>                    } <span style=color:#a90d91>catch</span> (<span style=color:#000>InterruptedException</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>RuntimeException</span>(<span style=color:#000>e</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><h3 id=synchronized-和-volatile>synchronized 和 volatile</h3><p>volatile 比较简单，可以理解为将一个变量强制同步给所有线程可见，但是不能解决并发写的问题。</p><p>java 的每个对象都有内在锁（或者叫监视器锁，intrinsic lock or monitor lock），涉及两个 JVM 指令：monitorenter、monitorexit。</p><p>synchronized method 和 synchronized block 的区别：<br>如果是 synchronized(this),那么和 synchronized 方法没有任何区别，锁定对象都是方法所在的对象。<br>但是 synchronized block 可以锁定其他对象，而且 synchronized block 的范围是可以控制更灵活，synchronized 方法的边界只能是整个方法</p><p>使用 ReentrantLock 场景：<br>需要以下高级特性时：可定时的，可轮询的，可中断的锁，公平队列，非块结构。<br><a href=https://stackoverflow.com/questions/4201713/synchronization-vs-lock>Synchronization vs Lock-stackoverflow</a></p><h3 id=semaphore>Semaphore</h3><p>可以理解为资源的许可证数量。<br>sem.acquire(2): 获取两个许可证。<br>sem.release() 释放资源的一个许可证。<br>信号量非常有用，也是基础，基于信号量，可以构建出很多其他的同步工具：turnstile 和 rendezvous，barrier，mutex，Multiplex</p><h3 id=countdownlatch>CountDownLatch</h3><p>CountDownLatch 是管理一组线程和一个主线程的先后。主线程 wait 后就阻塞，直到所有的 CountDownLatch 调用 countDown 后主线程接着开始。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>zhimoe.intrview.concurrent</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.CountDownLatch</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.concurrent.TimeUnit</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>CountDownLatchTest</span> {
</span></span><span style=display:flex><span>	<span style=color:#177500>// 这个方法将启动多个任务，并让它们同时执行，计算完成的时间</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>long</span> <span style=color:#000>timer</span>(<span style=color:#a90d91>int</span> <span style=color:#000>taskNums</span>) <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>CountDownLatch</span> <span style=color:#000>startLatch</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CountDownLatch</span>(<span style=color:#000>1</span>);
</span></span><span style=display:flex><span>		<span style=color:#000>CountDownLatch</span> <span style=color:#000>finishLatch</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CountDownLatch</span>(<span style=color:#000>taskNums</span>);
</span></span><span style=display:flex><span>		<span style=color:#a90d91>for</span> (<span style=color:#a90d91>int</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span>; <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>taskNums</span>; <span style=color:#000>i</span><span style=color:#000>++</span>) {
</span></span><span style=display:flex><span>			<span style=color:#000>Task</span> <span style=color:#000>task</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Task</span>(<span style=color:#000>startLatch</span>, <span style=color:#000>finishLatch</span>, <span style=color:#000>i</span>);
</span></span><span style=display:flex><span>			<span style=color:#a90d91>new</span> <span style=color:#000>Thread</span>(<span style=color:#000>task</span>).<span style=color:#836c28>start</span>();
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>long</span> <span style=color:#000>start</span> <span style=color:#000>=</span> <span style=color:#000>System</span>.<span style=color:#836c28>nanoTime</span>();
</span></span><span style=display:flex><span>		<span style=color:#000>startLatch</span>.<span style=color:#836c28>countDown</span>();<span style=color:#177500>// 准备好线程后开始同时启动所有任务</span>
</span></span><span style=display:flex><span>		<span style=color:#000>finishLatch</span>.<span style=color:#836c28>await</span>();<span style=color:#177500>// 等待任务完成</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>long</span> <span style=color:#000>end</span> <span style=color:#000>=</span> <span style=color:#000>System</span>.<span style=color:#836c28>nanoTime</span>();
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#000>end</span> <span style=color:#000>-</span> <span style=color:#000>start</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(<span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>CountDownLatchTest</span> <span style=color:#000>ct</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>CountDownLatchTest</span>();
</span></span><span style=display:flex><span>		<span style=color:#a90d91>long</span> <span style=color:#000>time</span> <span style=color:#000>=</span> <span style=color:#000>ct</span>.<span style=color:#836c28>timer</span>(<span style=color:#000>100</span>);
</span></span><span style=display:flex><span>		<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(
</span></span><span style=display:flex><span>			<span style=color:#000>TimeUnit</span>.<span style=color:#836c28>NANOSECONDS</span>.<span style=color:#836c28>toSeconds</span>(<span style=color:#000>time</span>) <span style=color:#000>+</span> <span style=color:#c41a16>&#34; SENCODS&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>Task</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Runnable</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>CountDownLatch</span> <span style=color:#000>startLatch</span>;
</span></span><span style=display:flex><span>	<span style=color:#000>CountDownLatch</span> <span style=color:#000>finishLatch</span>;
</span></span><span style=display:flex><span>	<span style=color:#a90d91>int</span> <span style=color:#000>time</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>Task</span>(<span style=color:#000>CountDownLatch</span> <span style=color:#000>startLatch</span>, <span style=color:#000>CountDownLatch</span> <span style=color:#000>finishLatch</span>, <span style=color:#a90d91>int</span> <span style=color:#000>time</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>this</span>.<span style=color:#836c28>startLatch</span> <span style=color:#000>=</span> <span style=color:#000>startLatch</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>this</span>.<span style=color:#836c28>finishLatch</span> <span style=color:#000>=</span> <span style=color:#000>finishLatch</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>this</span>.<span style=color:#836c28>time</span> <span style=color:#000>=</span> <span style=color:#000>time</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span>() {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>startLatch</span>.<span style=color:#836c28>await</span>();<span style=color:#177500>// 等待主线程通知任务开始</span>
</span></span><span style=display:flex><span>			<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;doing the task!&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#000>Thread</span>.<span style=color:#836c28>sleep</span>(<span style=color:#000>time</span> <span style=color:#000>*</span> <span style=color:#000>100</span>); <span style=color:#177500>// 模拟任务过程</span>
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>catch</span> (<span style=color:#000>InterruptedException</span> <span style=color:#000>e1</span>) {
</span></span><span style=display:flex><span>			<span style=color:#177500>// TODO Auto-generated catch block</span>
</span></span><span style=display:flex><span>			<span style=color:#000>e1</span>.<span style=color:#836c28>printStackTrace</span>();
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>finally</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;task done&#34;</span>);
</span></span><span style=display:flex><span>			<span style=color:#000>finishLatch</span>.<span style=color:#836c28>countDown</span>();<span style=color:#177500>// 告诉主线程任务完成</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=cyclicbarrier>CyclicBarrier</h3><p>TBD</p><h3 id=exchanger>Exchanger</h3><p>TBD</p><h3 id=lock>Lock</h3><p>TBD</p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java-concurrency-1-thread/>Java 并发 1-线程与任务</a></span>
<span><a href=../../post/java-concurrency-3-threadlocal/>Java 并发 3-ThreadLocal</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>Categories</a> <a href=../../tags/>Tags</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 OpenPyXL 读写 excel 大文件 - 新街记事</title>
<meta property="og:title" content="使用 OpenPyXL 读写 excel 大文件 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="使用 python OpenPyXL 读写 excel 大文件时，有专门的 read_only write-only 模式来提升读写效率。
[&amp;hellip;] from openpyxl import load_workbook wb = load_workbook(filename=&amp;#39;large_file.xlsx&amp;#39;, read_only=True) ws = &amp;hellip;"><meta property="og:description" content="使用 python OpenPyXL 读写 excel 大文件时，有专门的 read_only write-only 模式来提升读写效率。
[&amp;hellip;] from openpyxl import load_workbook wb = load_workbook(filename=&amp;#39;large_file.xlsx&amp;#39;, read_only=True) ws = &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>使用 OpenPyXL 读写 excel 大文件</h1><h3 class=meta-line><span><span class=date>2023-05-07</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/python/ class=term-tag>#python</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#openpyxl-read_only-mode>openpyxl read_only mode</a></li><li><a href=#openpyxl-write_only-mode>openpyxl write_only mode</a></li><li><a href=#官方文档>官方文档</a></li><li><a href=#openpyxl-vs-xlsxwriter>openpyxl vs xlsxwriter</a></li><li><a href=#使用-polars>使用 polars</a></li></ul></nav><p>使用 python OpenPyXL 读写 excel 大文件时，有专门的 read_only write-only 模式来提升读写效率。</p><h3 id=openpyxl-read_only-mode>openpyxl read_only mode</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>from</span> <span style=color:#000>openpyxl</span> <span style=color:#a90d91>import</span> <span style=color:#000>load_workbook</span>
</span></span><span style=display:flex><span><span style=color:#000>wb</span> <span style=color:#000>=</span> <span style=color:#000>load_workbook</span>(<span style=color:#000>filename</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;large_file.xlsx&#39;</span>, <span style=color:#000>read_only</span><span style=color:#000>=</span><span style=color:#a90d91>True</span>)
</span></span><span style=display:flex><span><span style=color:#000>ws</span> <span style=color:#000>=</span> <span style=color:#000>wb</span>[<span style=color:#c41a16>&#39;big_data&#39;</span>]
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># min_col&amp;max_col: 只处理 B 列，min_row=2: 从第二行开始，只读取值</span>
</span></span><span style=display:flex><span><span style=color:#000>col_index_B</span> <span style=color:#000>=</span> <span style=color:#000>openpyxl</span><span style=color:#000>.</span><span style=color:#000>utils</span><span style=color:#000>.</span><span style=color:#000>column_index_from_string</span>(<span style=color:#c41a16>&#39;B&#39;</span>) 
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> <span style=color:#000>cell_value</span> <span style=color:#000>in</span> <span style=color:#000>ws</span><span style=color:#000>.</span><span style=color:#000>iter_rows</span>(<span style=color:#000>min_row</span><span style=color:#000>=</span><span style=color:#1c01ce>2</span>, <span style=color:#000>min_col</span><span style=color:#000>=</span><span style=color:#000>col_index_B</span>, <span style=color:#000>max_col</span><span style=color:#000>=</span><span style=color:#000>col_index_B</span>, <span style=color:#000>values_only</span><span style=color:#000>=</span><span style=color:#a90d91>True</span>):
</span></span><span style=display:flex><span>    <span style=color:#a90d91>print</span>(<span style=color:#000>cell_value</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># Close the workbook after reading</span>
</span></span><span style=display:flex><span><span style=color:#000>wb</span><span style=color:#000>.</span><span style=color:#000>close</span>()
</span></span></code></pre></div><h4 id=只读取第一行的错误>只读取第一行的错误</h4><p>如果你的 excel 文件是通过第三方软件 (数据库客户端) 或者代码生成的，很容易遇到一个问题就是上面的<code>ws.iter_rows</code>或<code>ws.rows</code>遍历只会读取第一行。这是因为 read only 模式在 load_workbook 时只读取了文件的元信息，在遍历时也依赖 worksheet 的元信息，很多非 office 生成的 excel 没有正确设置元信息。你可以通过<code>ws.calculate_dimension()</code>检查 excel 行列信息，如果返回的是<code>A1:A1</code>等与实际大小不一致的情况，可以通过<code>ws.reset_dimensions()</code>来重置<code>ws</code>的<code>max_row</code> and <code>max_column</code>属性。<br>注意，<code>ws.reset_dimensions()</code>会读取整个文件，效率会降低到非 read_only 模式一样。</p><p>哎，这个坑花了一下午的排查，就是不认真看一下<a href=https://openpyxl.readthedocs.io/en/latest/optimized.html#worksheet-dimensions>文档</a></p><h3 id=openpyxl-write_only-mode>openpyxl write_only mode</h3><ol><li>确保安装了<code>lxml</code> <code>openpyxl</code>两个库</li><li>使用 write_only 写大数据</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>from</span> <span style=color:#000>openpyxl</span> <span style=color:#a90d91>import</span> <span style=color:#000>Workbook</span>
</span></span><span style=display:flex><span><span style=color:#000>wb</span> <span style=color:#000>=</span> <span style=color:#000>Workbook</span>(<span style=color:#000>write_only</span><span style=color:#000>=</span><span style=color:#a90d91>True</span>)
</span></span><span style=display:flex><span><span style=color:#000>ws</span> <span style=color:#000>=</span> <span style=color:#000>wb</span><span style=color:#000>.</span><span style=color:#000>create_sheet</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># now we&#39;ll fill it with 100 rows x 200 columns</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> <span style=color:#000>irow</span> <span style=color:#000>in</span> <span style=color:#a90d91>range</span>(<span style=color:#1c01ce>100</span>):
</span></span><span style=display:flex><span>    <span style=color:#000>ws</span><span style=color:#000>.</span><span style=color:#000>append</span>([<span style=color:#c41a16>&#39;</span><span style=color:#c41a16>%d</span><span style=color:#c41a16>&#39;</span> <span style=color:#000>%</span> <span style=color:#000>i</span> <span style=color:#a90d91>for</span> <span style=color:#000>i</span> <span style=color:#000>in</span> <span style=color:#a90d91>range</span>(<span style=color:#1c01ce>200</span>)])
</span></span><span style=display:flex><span>   
</span></span><span style=display:flex><span><span style=color:#177500># save the file</span>
</span></span><span style=display:flex><span><span style=color:#000>wb</span><span style=color:#000>.</span><span style=color:#000>save</span>(<span style=color:#c41a16>&#39;new_big_file.xlsx&#39;</span>) <span style=color:#177500># doctest: +SKIP</span>
</span></span></code></pre></div><h3 id=官方文档>官方文档</h3><p><a href=https://openpyxl.readthedocs.io/en/latest/optimized.html>openpyxl Optimised Modes</a></p><h3 id=openpyxl-vs-xlsxwriter>openpyxl vs xlsxwriter</h3><ol><li>两个常用功能和性能上差别不大，部分样式设置有差别。</li><li>pandas 支持两个，可以通过 engine 参数切换。</li></ol><h3 id=使用-polars>使用 polars</h3><p>polars 是使用 rust 语言编写的 DataFrame 库，基于 arrow 格式，提供 rust、python、nodejs 三种编程语言接口。目前 polars 支持读取整个 excel 文件，但是写文件不行，只能通过转换成 pandas 的 df 再处理。本地测试一下 polars 读取整个 excel 文件，速度大约是 pandas 普通模式的两倍，内存使用是 pandas 的 2/3，这个性能和内存，感觉在 python 领域希望不大，看 rust 那边的发展了。</p><p>polars 的 API 一般是尽可能和 pandas 保持一致，所以使用起来也比较简单，遇到 API 缺失的，可以直接转换成 pandas 的 df 使用<code>df.to_pandas()</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>pandas</span> <span style=color:#a90d91>as</span> <span style=color:#000>pd</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>polars</span> <span style=color:#a90d91>as</span> <span style=color:#000>pl</span>  <span style=color:#177500># read_excel 还需要 xlsx2csv lib</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>df</span> <span style=color:#000>=</span> <span style=color:#000>pl</span><span style=color:#000>.</span><span style=color:#000>read_excel</span>(
</span></span><span style=display:flex><span>    <span style=color:#c41a16>&#34;test.xlsx&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>sheet_id</span><span style=color:#000>=</span><span style=color:#1c01ce>1</span>,
</span></span><span style=display:flex><span>    <span style=color:#000>xlsx2csv_options</span><span style=color:#000>=</span>{<span style=color:#c41a16>&#34;skip_empty_lines&#34;</span>: <span style=color:#a90d91>True</span>},
</span></span><span style=display:flex><span>    <span style=color:#000>read_csv_options</span><span style=color:#000>=</span>{<span style=color:#c41a16>&#34;has_header&#34;</span>: <span style=color:#a90d91>True</span>},
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>{</span><span style=color:#a90d91>type</span>(<span style=color:#000>df</span>)<span style=color:#c41a16>=}</span><span style=color:#c41a16>&#39;</span>)  <span style=color:#177500># class &#39;polars.dataframe.frame.DataFrame&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>{</span><span style=color:#000>df</span><span style=color:#000>.</span><span style=color:#000>shape</span><span style=color:#c41a16>=}</span><span style=color:#c41a16>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>{</span><span style=color:#000>df</span><span style=color:#000>.</span><span style=color:#000>head</span>()<span style=color:#c41a16>=}</span><span style=color:#c41a16>&#39;</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> <span style=color:#000>cell</span> <span style=color:#000>in</span> <span style=color:#000>df</span>[<span style=color:#c41a16>&#39;Courses&#39;</span>]:
</span></span><span style=display:flex><span>    <span style=color:#a90d91>print</span>(<span style=color:#c41a16>f</span><span style=color:#c41a16>&#39;</span><span style=color:#c41a16>{</span><span style=color:#000>cell</span><span style=color:#c41a16>=}</span><span style=color:#c41a16>&#39;</span>)
</span></span></code></pre></div><p>polars 的输出格式比 pandas 的好看多了，使用了 box-drawing 相关的 unicode 字符打印表格，不过需要编程字体支持才能对齐。</p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/rust-error-handling-notes/>Rust Error Handling Notes</a></span>
<span class=post-nav-next><a href=../../post/kotlin-coroutine/>Kotlin Coroutine</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/ol-id.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
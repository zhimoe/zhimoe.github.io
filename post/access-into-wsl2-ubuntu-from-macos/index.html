<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>在 macOS 通过 SSH 访问 Windows 的 WSL2 Ubuntu - 新街记事</title>
<meta property="og:title" content="在 macOS 通过 SSH 访问 Windows 的 WSL2 Ubuntu - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="配置 Windows 和 WSL2，使得能通过其他电脑远程 SSH 到 WSL2 Ubuntu。
[&amp;hellip;] 之前的电脑配置是 LinuxMint 台式机 + M1 macbook 笔记本。使用 Linux 主要原因是命令行和 Docker. 最近由于二十大，工作 VPN 在 macOS 不让用，只能将台式机安装上 Win10，发现 docker 在 WSL2 运行非常丝滑，这样正好可以 &amp;hellip;"><meta property="og:description" content="配置 Windows 和 WSL2，使得能通过其他电脑远程 SSH 到 WSL2 Ubuntu。
[&amp;hellip;] 之前的电脑配置是 LinuxMint 台式机 + M1 macbook 笔记本。使用 Linux 主要原因是命令行和 Docker. 最近由于二十大，工作 VPN 在 macOS 不让用，只能将台式机安装上 Win10，发现 docker 在 WSL2 运行非常丝滑，这样正好可以 &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>在 macOS 通过 SSH 访问 Windows 的 WSL2 Ubuntu</h1><h3 class=meta-line><span><span class=date>2022-10-30</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/macos/ class=term-tag>#macOS </a><a href=../../tags/wsl2/ class=term-tag>#WSL2</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#1-win10-安装-wsl2-ubuntu>1 Win10 安装 WSL2 Ubuntu</a></li><li><a href=#2-配置-ssh-server在-ubuntu-执行>2 配置 SSH server（在 Ubuntu 执行）</a></li><li><a href=#3-win10-防火墙设置>3 Win10 防火墙设置</a></li><li><a href=#4-本地验证-ssh-访问-ubuntu>4 本地验证 SSH 访问 Ubuntu</a></li><li><a href=#5-ubuntu-ssh-服务开机自动启动>5 Ubuntu ssh 服务开机自动启动</a></li><li><a href=#6-网卡映射>6 网卡映射</a></li></ul></nav><p>配置 Windows 和 WSL2，使得能通过其他电脑远程 SSH 到 WSL2 Ubuntu。</p><h3 id=背景>背景</h3><p>之前的电脑配置是 LinuxMint 台式机 + M1 macbook 笔记本。使用 Linux 主要原因是命令行和 Docker. 最近由于二十大，工作 VPN 在 macOS 不让用，只能将台式机安装上 Win10，发现 docker 在 WSL2 运行非常丝滑，这样正好可以当作 macbook 的 Docker 服务器。切换到 Windows 还有一个原因就是，Linux 的桌面真的不行，最近三年各种版本的桌面使用一圈，Budgie，Gnome，Cinnamon，Xfce 这些桌面总是偶尔界面失去响应，KDE 用的不多，卡顿没遇到但是启动总是慢半秒。Win10 除了没有 Bash/Zsh，中文字体垃圾点，其他的都完胜 Linux。</p><p>下面的教程主要参考：<a href=https://jmmv.dev/2022/02/wsl-ssh-access.html>Configuring SSH access into WSL 1 and WSL 2</a></p><h3 id=1-win10-安装-wsl2-ubuntu>1 Win10 安装 WSL2 Ubuntu</h3><p>注意，是安装 WSL2，方法参考这个<a href=https://learn.microsoft.com/zh-cn/windows/wsl/install-manual#step-3---enable-virtual-machine-feature>enable-virtual-machine-feature</a>：</p><ol><li>以管理员身份打开 PowerShell（“开始”菜单 >“PowerShell” >单击右键 >“以管理员身份运行”），然后输入以下命令：<br><code>dism.exe /online /enable-feature /featurename:VirtualMachinePlatform /all /norestart</code>；</li><li>安装 &ldquo;适用于 x64 计算机的 WSL2 Linux 内核更新包&rdquo;；</li><li>将 WSL 设置默认 version 2，in PowerShell: <code>wsl --set-default-version 2</code>；</li><li>安装 Ubuntu，in PowerShell: <code>wsl --install -d Ubuntu-22.04</code>。</li></ol><p><a href=https://learn.microsoft.com/zh-cn/windows/wsl/install>更多参考</a></p><h3 id=2-配置-ssh-server在-ubuntu-执行>2 配置 SSH server（在 Ubuntu 执行）</h3><p>进入 Ubuntu</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#177500>#修改软件源</span>
</span></span><span style=display:flex><span>sudo sed -i <span style=color:#c41a16>&#34;s@http://.*archive.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list
</span></span><span style=display:flex><span>sudo sed -i <span style=color:#c41a16>&#34;s@http://.*security.ubuntu.com@https://mirrors.tuna.tsinghua.edu.cn@g&#34;</span> /etc/apt/sources.list
</span></span><span style=display:flex><span>sudo apt update <span style=color:#000>&amp;&amp;</span> sudo apt upgrade -y
</span></span></code></pre></div><p>安装配置 ssh 服务</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>sudo apt install openssh-server
</span></span><span style=display:flex><span>sudo vim /etc/ssh/sshd_config
</span></span><span style=display:flex><span><span style=color:#177500># 修改下面几个配置</span>
</span></span><span style=display:flex><span><span style=color:#177500># Port 2222</span>
</span></span><span style=display:flex><span><span style=color:#177500># AddressFamily any</span>
</span></span><span style=display:flex><span><span style=color:#177500># ListenAddress 0.0.0.0</span>
</span></span><span style=display:flex><span><span style=color:#177500># PasswordAuthentication yes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 如果启动遇到这个错误 请执行下面命令: sshd: no hostkeys available -- exiting</span>
</span></span><span style=display:flex><span>sudo ssh-keygen -A
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 启动ssh服务</span>
</span></span><span style=display:flex><span>sudo /usr/sbin/service ssh start
</span></span></code></pre></div><h3 id=3-win10-防火墙设置>3 Win10 防火墙设置</h3><p>打开控制面板\系统和安全\Windows Defender 防火墙。</p><ul><li>最左边有高级设置</li><li>右键点击入站规则</li><li>新建入站规则</li><li>点击端口，特定端口设置 2222</li><li>然后命名之后一路下一步就行</li></ul><p>或者通过 shell 设置，以管理员身份打开 PowerShell:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-PowerShell data-lang=PowerShell><span style=display:flex><span><span style=color:#a90d91>New-NetFirewallRule</span> <span style=color:#000>-Name</span> <span style=color:#000>sshd</span> <span style=color:#000>-DisplayName</span> <span style=color:#c41a16>&#39;sshd for WSL&#39;</span> <span style=color:#000>-Enabled</span> <span style=color:#000>True</span> <span style=color:#000>-Direction</span> <span style=color:#000>Inbound</span> <span style=color:#000>-Protocol</span> <span style=color:#000>TCP</span> <span style=color:#000>-Action</span> <span style=color:#000>Allow</span> <span style=color:#000>-LocalPort</span> <span style=color:#1c01ce>2222</span>
</span></span></code></pre></div><h3 id=4-本地验证-ssh-访问-ubuntu>4 本地验证 SSH 访问 Ubuntu</h3><p>打开 Windows Terminal，尝试 ssh 访问 Ubuntu</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>ssh -p 2222 wsluser@localhost
</span></span></code></pre></div><p>如果连接上说明 ssh 配置已经完成。</p><h3 id=5-ubuntu-ssh-服务开机自动启动>5 Ubuntu ssh 服务开机自动启动</h3><p>WSL2 Ubuntu 的 ssh 服务不是跟着 Win10 开机自动启动的。在 Win10 的<code>%USERPROFILE%</code>目录下面新建文件<code>sshd.bat</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>rem sshd.bat
</span></span><span style=display:flex><span>@echo off
</span></span><span style=display:flex><span>setlocal
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>C:\Windows\System32\bash.exe -c &#34;sudo /usr/sbin/service ssh start&#34;
</span></span><span style=display:flex><span>rem C:\Windows\System32\wsl.exe -e &#34;sudo /usr/sbin/service ssh start&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>endlocal
</span></span></code></pre></div><p>注意上面 <code>bash.exe -c</code> 和 <code>wsl.exe -e</code> 两个功能是一样的。bash 后面不维护了，wsl 是官方推荐命令，但是 bash 有输出。</p><p>接下来把上面的脚本配置成开机自动执行：</p><ul><li>按下 Win 键，搜索“任务计划程序”，右边点击“创建任务”。</li><li>常规：设置任务名字“Start WSL SSH”，勾选上“使用最高权限运行”（这是给后面网卡映射命令的权限）</li><li>触发器：新建，选择“启动时”</li><li>操作：选择上面的 sshd.bat 脚本文件。</li></ul><p>保存，重启电脑，打开 Terminal，重新试试<code>ssh -p 2222 wsluser@localhost</code></p><h3 id=6-网卡映射>6 网卡映射</h3><p>到目前为止，在 Win10 本地已经可以在开机后直接通过 SSH 访问 Ubuntu 了，但是你如果在局域网内的其他电脑访问，还是连不上的。这是因为 WSL2 是个虚拟机。</p><blockquote><p>WSL 2 is a well-hidden virtual machine, but it is still a virtual machine—and the consequences of this design are leaky. The network interface we see within WSL is a virtual interface that does not match the physical interface that Windows manages. Windows does a good job at hiding this fact when operating directly on the local machine (e.g. you can SSH into WSL from localhost and it will work), but attempts to reach WSL from a separate machine will fail.</p></blockquote><p>设置开机自动执行网卡映射命令，将上面的 sshd.bat 文件改成如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bat data-lang=bat><span style=display:flex><span><span style=color:#177500>rem sshd.bat</span>
</span></span><span style=display:flex><span>@<span style=color:#a90d91>echo</span> off
</span></span><span style=display:flex><span><span style=color:#a90d91>setlocal</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>C:<span style=color:#000>\Windows\System32\bash.exe</span><span style=color:#177500> -c &#34;sudo /usr/sbin/service ssh start&#34;</span>
</span></span><span style=display:flex><span><span style=color:#177500>rem C:\Windows\System32\wsl.exe -e &#34;sudo /usr/sbin/service ssh start&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>C:<span style=color:#000>\Windows\System32\netsh.exe</span><span style=color:#177500> interface portproxy delete v4tov4 listenport=2222 listenaddress=0.0.0.0 protocol=tcp</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> <span style=color:#a90d91>/f</span> <span style=color:#c41a16>%%</span>i <span style=color:#a90d91>in</span> (<span style=color:#c41a16>&#39;wsl hostname -I&#39;</span>) <span style=color:#a90d91>do</span> <span style=color:#a90d91>set</span> <span style=color:#000>IP</span>=<span style=color:#c41a16>%%</span>i
</span></span><span style=display:flex><span>C:<span style=color:#000>\Windows\System32\netsh.exe</span><span style=color:#177500> interface portproxy add v4tov4 listenport=2222 listenaddress=0.0.0.0 connectport=2222 connectaddress=%IP%</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>endlocal</span>
</span></span></code></pre></div><p>保存后启动，在 macbook 试试，成功。</p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/kotlin-coroutine/>Kotlin Coroutine</a></span>
<span><a href=../../post/java-quarkus-notes/>云原生 Java 开发框架 Quarkus 学习笔记</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/ol-id.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>Categories</a> <a href=../../tags/>Tags</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
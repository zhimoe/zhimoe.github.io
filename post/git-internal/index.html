<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Git 内部原理-对象、分支以及底层命令[翻译] - 新街记事</title>
<meta property="og:title" content="Git 内部原理-对象、分支以及底层命令[翻译] - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="我们中的许多人每天都在使用 git，但是有多少人知道它的内部是怎么运作的呢？
[&amp;hellip;] 例如我们使用 git commit 时发生了什么？提交（commit）与提交之间保存的是什么？两次提交之间难道只是文件的差异（diff）吗？如果是，这个差异是如何编码的？还是说每次提交都会保存一个当前仓库的完整快照（snapshot）呢？我们使用 git init 时到底发生了什么？ &amp;hellip;"><meta property="og:description" content="我们中的许多人每天都在使用 git，但是有多少人知道它的内部是怎么运作的呢？
[&amp;hellip;] 例如我们使用 git commit 时发生了什么？提交（commit）与提交之间保存的是什么？两次提交之间难道只是文件的差异（diff）吗？如果是，这个差异是如何编码的？还是说每次提交都会保存一个当前仓库的完整快照（snapshot）呢？我们使用 git init 时到底发生了什么？ &amp;hellip;"><meta name=twitter:image content="https://jsd.cdn.zzko.cn/gh/zhimoe/zhimoe.pic@main/pic/git-objects.1pz0i807ve0w.webp"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Git 内部原理-对象、分支以及底层命令[翻译]</h1><h3 class=meta-line><span><span class=date>2023-08-06</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/git/ class=term-tag>#git </a><a href=../../tags/%E7%BF%BB%E8%AF%91/ class=term-tag>#翻译</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#git-对象>Git 对象</a></li><li><a href=#分支>分支</a></li><li><a href=#git-如何记录变化>git 如何记录变化</a></li><li><a href=#git-底层命令-plumbing-和上层命令-porcelain>git 底层命令 (plumbing) 和上层命令 (porcelain)</a></li><li><a href=#git-目录>.git 目录</a></li><li><a href=#参考>参考</a></li></ul></nav><p>我们中的许多人每天都在使用 git，但是有多少人知道它的内部是怎么运作的呢？</p><p>例如我们使用 git commit 时发生了什么？提交（commit）与提交之间保存的是什么？两次提交之间难道只是文件的差异（diff）吗？如果是，这个差异是如何编码的？还是说每次提交都会保存一个当前仓库的完整快照（snapshot）呢？我们使用 git init 时到底发生了什么？</p><p>发现一篇非常精彩的 Git 内部原理文章<a href=https://medium.com/swimm/a-visualized-intro-to-git-internals-objects-and-branches-68df85864037>Git 内部原理图解——对象、分支以及如何从零开始建仓库</a>，<a href=https://www.freecodecamp.org/chinese/news/git-internals-objects-branches-create-repo/>中文翻译</a>。文章作者甚至制作了<a href="https://www.youtube.com/playlist?list=PL9lx0DXCC4BNUby5H58y6s2TQVLadV8v7">配套讲解视频</a></p><h3 id=git-对象>Git 对象</h3><p>git 内部有三种对象：</p><ol><li>blob: 文件的内容，不包含 metadata 信息（创建时间，修改时间，作者等）</li><li>tree: 一个目录，包含 blobs 或者 trees</li><li>commit: a snapshot of the working tree，一个 tree 的快照</li></ol><p>三种 git 对象都是通过 SHA-1 哈希值来唯一标识，如下图所示。每个 commit 对象中，对于 tree 里面那些没有改动的内容，继续通过原 hash 引用。</p><p><img src=https://jsd.cdn.zzko.cn/gh/zhimoe/zhimoe.pic@main/pic/git-objects.1pz0i807ve0w.webp alt="git 对象以及关系示意图"></p><h3 id=分支>分支</h3><p>A branch is just a named reference to a commit.</p><p>在上面的图片中，可以通过哈希值来引用一个 commit，但是不方便，所以分支用来引用 commit。可以理解为分支是一个指针，指向一个 commit，一般默认是指向最后一个 commit（也可以不是最后一个 commit）。</p><p>git 通过<code>HEAD</code>指针来确认当前所在分支。<code>HEAD</code>指针其实是<code>.git</code>目录下的一个<code>HEAD文件</code>，内容如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>&gt; cat .git/HEAD
</span></span><span style=display:flex><span>ref: refs/heads/master
</span></span></code></pre></div><h3 id=git-如何记录变化>git 如何记录变化</h3><ol><li>repository 是一系列 commit 的集合</li><li>working dir 是一个包含<code>.git</code>的目录</li><li>staging area 是存放那些被 git 跟踪但是没有 commit 的内容</li></ol><p>三者的关系如下图所示<br><img src=https://jsd.cdn.zzko.cn/gh/zhimoe/zhimoe.pic@main/pic/git-repo-workingdir.39ykllsr2to0.webp alt=git-repo-workingdir></p><h3 id=git-底层命令-plumbing-和上层命令-porcelain>git 底层命令 (plumbing) 和上层命令 (porcelain)</h3><p>区分 底层（plumbing）和 上层（porcelain）两类 git 命令会对你很有帮助。这两个术语的应用奇怪地来自于马桶（没错，就是🚽）。马桶通常是用陶瓷（porcelain）做的，它的基本结构是管道（plumbing，上水道和下水道）。<br>上层命令就是<code>git init、git add、 git commit</code>等，下面介绍一下底层命令。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span><span style=color:#177500># 创建git对象</span>
</span></span><span style=display:flex><span>&gt;echo <span style=color:#c41a16>&#34;git is awesome&#34;</span> | git hash-object --stdin -w
</span></span><span style=display:flex><span><span style=color:#177500># 查看.git目录的变化</span>
</span></span><span style=display:flex><span>&gt;tree .git
</span></span><span style=display:flex><span><span style=color:#177500># 查看一个git object类型 -t type</span>
</span></span><span style=display:flex><span>&gt;git cat-file -t <span style=color:#000>[</span>obj-hash<span style=color:#000>]</span>
</span></span><span style=display:flex><span><span style=color:#177500># blob|tree|commit</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 查看一个git object内容 -p pretty-print</span>
</span></span><span style=display:flex><span>&gt;git cat-file -p <span style=color:#000>[</span>obj-hash<span style=color:#000>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 添加object到staging area</span>
</span></span><span style=display:flex><span>&gt;git update-index --add --cacheinfo <span style=color:#1c01ce>100644</span> &lt;blob-hash&gt; &lt;filename&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 创建一个tree对象 在tree对象中记录index内容</span>
</span></span><span style=display:flex><span>&gt;git write-tree
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 为tree对象创建一个commit对象</span>
</span></span><span style=display:flex><span>&gt;git commit-tree &lt;tree-hash&gt; -m &lt;commit message&gt;
</span></span></code></pre></div><p>git 实际上是使用 SHA-1 哈希值的前两个字符作为目录的名字，剩余字符用作 blob 所在文件的文件名。</p><h3 id=git-目录>.git 目录</h3><p>一个<code>.git</code>目录至少包含三个内容</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>✔ tree .git
</span></span><span style=display:flex><span>.git
</span></span><span style=display:flex><span>├── HEAD        当前指向分支，默认内容是 ref: refs/heads/main
</span></span><span style=display:flex><span>├── objects     git对象 blob、tree、commit的一种，其中对象的hash值前两个字符用于目录名，剩余的用于对象名
</span></span><span style=display:flex><span>└── refs        分支和tag
</span></span><span style=display:flex><span>    └── heads   当前working dir所有分支 默认分支不展示，只有多于一个分支才会展示 
</span></span></code></pre></div><p>添加一个文件并 commit，然后创建一个新分支，再次检查.git 目录</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>✔ tree .git
</span></span><span style=display:flex><span>.git
</span></span><span style=display:flex><span>├── HEAD
</span></span><span style=display:flex><span>├── index
</span></span><span style=display:flex><span>├── objects
</span></span><span style=display:flex><span>│        ├── 8d
</span></span><span style=display:flex><span>│        │   └── 0e41234f24b6da002d962a26c2495ea16a425f
</span></span><span style=display:flex><span>│        ├── af
</span></span><span style=display:flex><span>│        │   └── 7e0d93b83f49f601f5ef35edf5f9330fb4d7fd
</span></span><span style=display:flex><span>│        └── c8
</span></span><span style=display:flex><span>│            └── bcfef1da123a980537a5fa4cf9b7c4f387d451
</span></span><span style=display:flex><span>└── refs
</span></span><span style=display:flex><span>    └── heads
</span></span><span style=display:flex><span>        ├── main
</span></span><span style=display:flex><span>        └── test_branch
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1c01ce>7</span> directories, <span style=color:#1c01ce>7</span> files
</span></span></code></pre></div><p>上面删除了 logs 目录，index 文件保存的是 staging area 信息。打印 objects 目录下的三个文件</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>✔ git cat-file -p 8d0e41234f24b6da002d962a26c2495ea16a425f
</span></span><span style=display:flex><span>hello git
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> :~/code/temp <span style=color:#000>(</span>main<span style=color:#000>)</span>
</span></span><span style=display:flex><span>✔ git cat-file -p c8bcfef1da123a980537a5fa4cf9b7c4f387d451
</span></span><span style=display:flex><span><span style=color:#1c01ce>100644</span> blob 8d0e41234f24b6da002d962a26c2495ea16a425f	file.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span> :~/code/temp <span style=color:#000>(</span>main<span style=color:#000>)</span>
</span></span><span style=display:flex><span>✔ git cat-file -p af7e0d93b83f49f601f5ef35edf5f9330fb4d7fd
</span></span><span style=display:flex><span>tree c8bcfef1da123a980537a5fa4cf9b7c4f387d451
</span></span><span style=display:flex><span>author zhimoe &lt;xx@gmail.com&gt; <span style=color:#1c01ce>1691313901</span> +0800
</span></span><span style=display:flex><span>committer zhimoe &lt;xx@gmail.com&gt; <span style=color:#1c01ce>1691313901</span> +0800
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>first commit
</span></span></code></pre></div><p>可以看到分别是一个 blob 对象（file.txt)、一个 tree 对象和一个 commit 对象，后者依次引用前者。</p><h3 id=参考>参考</h3><p>文章里面提到了很多 git 内部原理和概念：<br><a href=https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-%E5%BA%95%E5%B1%82%E5%91%BD%E4%BB%A4%E4%B8%8E%E4%B8%8A%E5%B1%82%E5%91%BD%E4%BB%A4>Git 内部原理 - 底层命令与上层命令</a><br><a href=https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-Git-%E5%AF%B9%E8%B1%A1>Git 内部原理 - Git 对象</a></p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java-concurrency-5-virtualthread/>Java 并发 5-虚拟线程（VirtualThread）</a></span>
<span><a href=../../post/rust-error-handling-notes/>Rust Error Handling Notes</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/alt-title.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/ol-id.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
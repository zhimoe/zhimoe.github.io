<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scala Python 文件读取跳过转义字符 - 香取海</title>
<meta property="og:title" content="Scala Python 文件读取跳过转义字符 - 香取海"><meta name=twitter:card content="summary"><meta property="description" content="在文件读取的时候，会遇到非法转义字符，导致文件按行读取失败。此时可以通过忽略转义字符来解决。本文记录了 scala 和 python 的方法。
[&amp;hellip;] 有 50G 的服务器日志，拆分为几千个 txt 文件，编码是 utf8，使用 scala 和 python 按行处理：
[&amp;hellip;] def main(args: Array[String]): Unit = { for &amp;hellip;"><meta property="og:description" content="在文件读取的时候，会遇到非法转义字符，导致文件按行读取失败。此时可以通过忽略转义字符来解决。本文记录了 scala 和 python 的方法。
[&amp;hellip;] 有 50G 的服务器日志，拆分为几千个 txt 文件，编码是 utf8，使用 scala 和 python 按行处理：
[&amp;hellip;] def main(args: Array[String]): Unit = { for &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>香取海</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Scala Python 文件读取跳过转义字符</h1><h3 class=meta-line><span><span class=date>2020-06-04</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/scala/ class=term-tag>#scala </a><a href=../../tags/python/ class=term-tag>#python</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#背景>背景</a><ul><li><a href=#scala>scala</a></li><li><a href=#python>python</a></li></ul></li><li><a href=#方案>方案</a><ul><li><a href=#scala-1>scala</a></li><li><a href=#python-1>python</a></li></ul></li></ul></nav><p>在文件读取的时候，会遇到非法转义字符，导致文件按行读取失败。此时可以通过忽略转义字符来解决。本文记录了 scala 和 python 的方法。</p><h2 id=背景>背景</h2><p>有 50G 的服务器日志，拆分为几千个 txt 文件，编码是 utf8，使用 scala 和 python 按行处理：</p><h3 id=scala>scala</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a90d91>def</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#a90d91>:</span> <span style=color:#a90d91>Array</span><span style=color:#000>[</span><span style=color:#a90d91>String</span><span style=color:#000>])</span><span style=color:#a90d91>:</span> <span style=color:#a90d91>Unit</span> <span style=color:#000>=</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>line</span> <span style=color:#a90d91>&lt;-</span> <span style=color:#3f6e75>Source</span><span style=color:#000>.</span><span style=color:#000>fromFile</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;./txt1.log&#34;</span><span style=color:#000>,</span><span style=color:#c41a16>&#34;UTF8&#34;</span><span style=color:#000>).</span><span style=color:#000>getLines</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>line</span><span style=color:#000>.</span><span style=color:#000>contains</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ABC&#34;</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>//do something      
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></div><h3 id=python>python</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#a90d91>open</span>(<span style=color:#c41a16>&#39;./txt1.log&#39;</span>,<span style=color:#c41a16>&#39;r&#39;</span>,<span style=color:#000>encoding</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;utf-8&#39;</span>) <span style=color:#a90d91>as</span> <span style=color:#000>f</span>:
</span></span><span style=display:flex><span>    <span style=color:#a90d91>for</span> <span style=color:#000>line</span> <span style=color:#000>in</span> <span style=color:#000>f</span>:
</span></span><span style=display:flex><span>        <span style=color:#a90d91>pass</span> <span style=color:#177500>#do something</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><p>但是文本中有一些行包含非法的转义字符，例如：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>http://bbc.com/search.html \xa3\xa9 404 \r\n 李晓明
</span></span></code></pre></div><p>导致程序异常：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>#scala
</span></span><span style=display:flex><span>java.nio.charset.MalformedInputException: Input length = 1
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>#python
</span></span><span style=display:flex><span>&#39;utf-8&#39; codec can&#39;t decode byte 0xa3 in position 168: invalid start byte
</span></span></code></pre></div><h2 id=方案>方案</h2><p>一般遇到这种非法转义字符，可以跳过这个错误，看成 raw string 来处理。</p><h3 id=scala-1>scala</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.nio.charset.CodingErrorAction</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>scala.io.</span><span style=color:#000>{</span><span style=color:#3f6e75>Codec</span><span style=color:#000>,</span> <span style=color:#3f6e75>Source</span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>implicit</span> <span style=color:#a90d91>val</span> <span style=color:#000>codec</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Codec</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;UTF-8&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>codec</span><span style=color:#000>.</span><span style=color:#000>onMalformedInput</span><span style=color:#000>(</span><span style=color:#3f6e75>CodingErrorAction</span><span style=color:#000>.</span><span style=color:#3f6e75>REPLACE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>codec</span><span style=color:#000>.</span><span style=color:#000>onUnmappableCharacter</span><span style=color:#000>(</span><span style=color:#3f6e75>CodingErrorAction</span><span style=color:#000>.</span><span style=color:#3f6e75>REPLACE</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// 注意，fromFile 方法没有提供&#34;UTF8&#34;参数
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>def</span> <span style=color:#000>main</span><span style=color:#000>(</span><span style=color:#000>args</span><span style=color:#a90d91>:</span> <span style=color:#a90d91>Array</span><span style=color:#000>[</span><span style=color:#a90d91>String</span><span style=color:#000>])</span><span style=color:#a90d91>:</span> <span style=color:#a90d91>Unit</span> <span style=color:#000>=</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>for</span> <span style=color:#000>(</span><span style=color:#000>line</span> <span style=color:#a90d91>&lt;-</span> <span style=color:#3f6e75>Source</span><span style=color:#000>.</span><span style=color:#000>fromFile</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;./test.file&#34;</span><span style=color:#000>).</span><span style=color:#000>getLines</span><span style=color:#000>())</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>line</span><span style=color:#000>.</span><span style=color:#000>contains</span><span style=color:#000>(</span><span style=color:#c41a16>&#34;ABC&#34;</span><span style=color:#000>))</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#177500>//do something
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></div><h3 id=python-1>python</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#a90d91>open</span>(<span style=color:#c41a16>&#39;./txt1.log&#39;</span>,<span style=color:#c41a16>&#39;r&#39;</span>,<span style=color:#000>encoding</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;utf-8&#39;</span>,<span style=color:#000>errors</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;ignore&#39;</span>) <span style=color:#a90d91>as</span> <span style=color:#000>f</span>:
</span></span><span style=display:flex><span>    <span style=color:#a90d91>for</span> <span style=color:#000>line</span> <span style=color:#000>in</span> <span style=color:#000>f</span>:
</span></span><span style=display:flex><span>        <span style=color:#a90d91>pass</span> <span style=color:#177500>#do something</span>
</span></span><span style=display:flex><span>    
</span></span></code></pre></div><p>如果确认文本中没有中文的话，也可以使用下面的方式直接将其转义掉</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#a90d91>open</span>(<span style=color:#c41a16>&#39;./txt1.log&#39;</span>,<span style=color:#c41a16>&#39;r&#39;</span>,<span style=color:#000>encoding</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;unicode_escape&#39;</span>) <span style=color:#a90d91>as</span> <span style=color:#000>f</span>:
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/python-interview-questions/>Python 4 道笔试题</a></span>
<span class=post-nav-next><a href=../../post/python-matplotlib-chinese-garbled-solution/>Matplotlib 图例中文乱码解决方案</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
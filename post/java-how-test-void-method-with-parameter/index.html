<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>java 单元测试如何 Mock 有参数的 void 方法 - 新街记事</title>
<meta property="og:title" content="java 单元测试如何 Mock 有参数的 void 方法 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="测试中如果遇到被测试方法调用 void 方法，在 Mockito 中改如何处理？
[&amp;hellip;] 假设有如下的服务依赖：
[&amp;hellip;] @Service class DepositSvc { @Autowired private AccountSvc accSvc; public List&amp;lt;Account&amp;gt; dps(String user) { &amp;hellip;"><meta property="og:description" content="测试中如果遇到被测试方法调用 void 方法，在 Mockito 中改如何处理？
[&amp;hellip;] 假设有如下的服务依赖：
[&amp;hellip;] @Service class DepositSvc { @Autowired private AccountSvc accSvc; public List&amp;lt;Account&amp;gt; dps(String user) { &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>java 单元测试如何 Mock 有参数的 void 方法</h1><h3 class=meta-line><span><span class=date>2017-04-23</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/java/ class=term-tag>#java </a><a href=../../tags/test/ class=term-tag>#test</a></span></h3></div><div class=main><p>测试中如果遇到被测试方法调用 void 方法，在 Mockito 中改如何处理？</p><p>假设有如下的服务依赖：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@Service</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>DepositSvc</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>AccountSvc</span> <span style=color:#000>accSvc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>dps</span>(<span style=color:#000>String</span> <span style=color:#000>user</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>accounts</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ArrayList</span>();
</span></span><span style=display:flex><span>        <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>banks</span> <span style=color:#000>=</span> <span style=color:#000>getBanks</span>();
</span></span><span style=display:flex><span>        <span style=color:#000>accSvc</span>.<span style=color:#836c28>addLinkedAccounts</span>(<span style=color:#000>user</span>, <span style=color:#000>accounts</span>, <span style=color:#000>banks</span>);<span style=color:#177500>//accounts 被改动了如何 mock?</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>accounts</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@Service</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>AccountSvc</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Autowired</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>RestClient</span> <span style=color:#000>restClient</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>addLinkedAccounts</span>(<span style=color:#000>String</span> <span style=color:#000>user</span>, <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>accounts</span>, <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>banks</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>acc</span> <span style=color:#000>=</span> <span style=color:#000>restClient</span>.<span style=color:#836c28>getAcc</span>(<span style=color:#000>user</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>accounts</span>.<span style=color:#836c28>add</span>(<span style=color:#000>acc</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这里的 AccountSvc 只是提供了一个 void 方法处理了入参 accounts，虽然修改入参是被我所不齿的，但是有时改写这类方法挺麻烦的，特别如果方法修改了两个入参的话。<br>这种情况下如何测试 DepositSvc.dps 方法呢？mockito 的 <code>doAnswer</code>就是用于模拟 void 方法回调的。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>class</span> <span style=color:#3f6e75>DepositSvcTest</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@InjectMocks</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>DepositSvc</span> <span style=color:#000>depositSvc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Mock</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>AccountSvc</span> <span style=color:#000>accountSvc</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>void</span> <span style=color:#000>test_dps</span>() {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// ... arrange</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// mock void method with arguments</span>
</span></span><span style=display:flex><span>        <span style=color:#000>doAnswer</span>((<span style=color:#000>invocation</span>) <span style=color:#000>-&gt;</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span> <span style=color:#000>=</span> <span style=color:#000>invocation</span>.<span style=color:#836c28>getArguments</span>();
</span></span><span style=display:flex><span>            <span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span> <span style=color:#000>accounts</span> <span style=color:#000>=</span> (<span style=color:#000>List</span><span style=color:#000>&lt;</span><span style=color:#000>Account</span><span style=color:#000>&gt;</span>) <span style=color:#000>args</span><span style=color:#000>[</span><span style=color:#000>1</span><span style=color:#000>]</span>; <span style=color:#177500>//这里可以拿到入参</span>
</span></span><span style=display:flex><span>            <span style=color:#000>accounts</span>.<span style=color:#836c28>add</span>(<span style=color:#a90d91>new</span> <span style=color:#000>Account</span>(<span style=color:#000>911</span>); <span style=color:#177500>//修改入参</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span>;
</span></span><span style=display:flex><span>        }).<span style=color:#836c28>when</span>(<span style=color:#000>accountSvc</span>).<span style=color:#836c28>addLinkedAccounts</span>(<span style=color:#000>any</span>(), <span style=color:#000>anyList</span>(), <span style=color:#000>anyList</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#177500>// ...assert</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/spark-basic/>Spark Basic</a></span>
<span><a href=../../post/java-generic/>java generic</a> &rarr;</span></nav></div><footer class=small><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Git 的 detatched Head 模式和解决问题方法 - 新街记事</title>
<meta property="og:title" content="Git 的 detatched Head 模式和解决问题方法 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="有时候 commit 完代码后git push会遇到下面的错误
[&amp;hellip;] To push the history leading to the current (detached HEAD) 错误提示说当前 HEAD 没有指向任何分支，但是你记得明明有指向一个分支的
[&amp;hellip;] 1、假设你当前在 master 分支，且有两次提交
[&amp;hellip;] Prj on  &amp;hellip;"><meta property="og:description" content="有时候 commit 完代码后git push会遇到下面的错误
[&amp;hellip;] To push the history leading to the current (detached HEAD) 错误提示说当前 HEAD 没有指向任何分支，但是你记得明明有指向一个分支的
[&amp;hellip;] 1、假设你当前在 master 分支，且有两次提交
[&amp;hellip;] Prj on  &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Git 的 detatched Head 模式和解决问题方法</h1><h3 class=meta-line><span><span class=date>2022-03-09</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/git/ class=term-tag>#git</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#复现问题>复现问题</a></li><li><a href=#真实场景复现>真实场景复现</a></li><li><a href=#解决方法>解决方法</a></li></ul></nav><p>有时候 commit 完代码后<code>git push</code>会遇到下面的错误</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>To push the <span style=color:#a90d91>history</span> leading to the current <span style=color:#000>(</span>detached HEAD<span style=color:#000>)</span>
</span></span></code></pre></div><p>错误提示说当前 HEAD 没有指向任何分支，但是你记得明明有指向一个分支的</p><h3 id=复现问题>复现问题</h3><p>1、假设你当前在 master 分支，且有两次提交</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Prj on  master
</span></span><span style=display:flex><span>❯ git log --oneline --graph --decorate
</span></span><span style=display:flex><span>* 314c9df <span style=color:#000>(</span>HEAD -&gt; master<span style=color:#000>)</span> 2nd commit
</span></span><span style=display:flex><span>* ae15845 initial commit
</span></span></code></pre></div><p>2、切回到第一次提交</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Prj on  master
</span></span><span style=display:flex><span>❯ git checkout ae15845
</span></span><span style=display:flex><span>Note: switching to <span style=color:#c41a16>&#39;ae15845&#39;</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>You are in <span style=color:#c41a16>&#39;detached HEAD&#39;</span> state. You can look around, make experimental
</span></span><span style=display:flex><span>changes and commit them, and you can discard any commits you make in this
</span></span><span style=display:flex><span>state without impacting any branches by switching back to a branch.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you want to create a new branch to retain commits you create, you may
</span></span><span style=display:flex><span><span style=color:#a90d91>do</span> so <span style=color:#000>(</span>now or later<span style=color:#000>)</span> by using -c with the switch command. Example:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  git switch -c &lt;new-branch-name&gt;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Or undo this operation with:
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  git switch -
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Turn off this advice by setting config variable advice.detachedHead to <span style=color:#a90d91>false</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>HEAD is now at ae15845 initial commit
</span></span></code></pre></div><p>git 直接会提示你当前 HEAD 已经 detached。这是因为当 HEAD 离开当前分支（master）的末端 commit 时，Git 会默认你想要离开当前分支，但是 Git 不会自动创建一个新分支（因为没有提供分支名称）。<br>所以 HEAD 变成没有指向任何分支的窘境，即使你再次回到刚才那个分支的末端 commit，还是处于 detached 状态。</p><p>3、切回 master 分支的末端 commit 并提交新内容</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Prj <span style=color:#000>(</span>ae15845<span style=color:#000>)</span> <span style=color:#177500># 注意 zsh配置这里展示的是当前HEAD，下面也给了提示</span>
</span></span><span style=display:flex><span>❯ git checkout 314c9df
</span></span><span style=display:flex><span>Previous HEAD position was ae15845 initial commit
</span></span><span style=display:flex><span>HEAD is now at 314c9df 2nd commit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 提交点新东西</span>
</span></span><span style=display:flex><span>Prj <span style=color:#000>(</span>314c9df<span style=color:#000>)</span>
</span></span><span style=display:flex><span>❯  <span style=color:#a90d91>echo</span> <span style=color:#c41a16>&#34;3nd file &#34;</span> &gt; 3.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj <span style=color:#000>(</span>314c9df<span style=color:#000>)</span> <span style=color:#000>[</span>?<span style=color:#000>]</span>
</span></span><span style=display:flex><span>❯ git add . <span style=color:#000>&amp;&amp;</span> git commit -m <span style=color:#c41a16>&#34;3nd commit&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>[</span>detached HEAD 09fb4a5<span style=color:#000>]</span> 3nd commit
</span></span><span style=display:flex><span> <span style=color:#1c01ce>1</span> file changed, <span style=color:#1c01ce>1</span> insertion<span style=color:#000>(</span>+<span style=color:#000>)</span>
</span></span><span style=display:flex><span> create mode <span style=color:#1c01ce>100644</span> 3.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj <span style=color:#000>(</span>09fb4a5<span style=color:#000>)</span>
</span></span><span style=display:flex><span>❯ git log --oneline --graph --decorate
</span></span><span style=display:flex><span>* 09fb4a5 <span style=color:#000>(</span>HEAD<span style=color:#000>)</span> 3nd commit
</span></span><span style=display:flex><span>* 314c9df <span style=color:#000>(</span>master<span style=color:#000>)</span> 2nd commit
</span></span><span style=display:flex><span>* ae15845 initial commit
</span></span></code></pre></div><p>可以看到此时 HEAD 和 master 分支还是分离的。</p><h3 id=真实场景复现>真实场景复现</h3><p>上面复现的方式很刻意，毕竟极少情况你会 checkout 一个具体的 commit 而不手动创建一个分支。日常工作中最可能遇到这个 detached HEAD 的场景是你使用<code>Git submodule</code>的时候。<br>敢说每个新手在使用 submodule 都会碰到 detached HEAD 问题。<br>原因是你的 submodule 没有记录正确的分支，即你在使用<code>git submodule add</code>时没有指定<code>-b &lt;branch></code>参数。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>git submodule add -b main https://github.com/zhimoe/hugo-theme-next.git themes/next
</span></span></code></pre></div><p>或者直接在项目根目录下的<code>.gitmodules</code>文件中加上一行</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>branch = main
</span></span><span style=display:flex><span># or branch = master
</span></span></code></pre></div><h3 id=解决方法>解决方法</h3><p>1、预防的方法就是没有 commit 的时候及时切回一个具体分支<code>git checkout master</code></p><p>2、如果已经提交了的话，给当前游离的 commit 创建一个分支，切换到该分支</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Prj <span style=color:#000>(</span>09fb4a5<span style=color:#000>)</span>
</span></span><span style=display:flex><span>❯ git branch oops 09fb4a5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj <span style=color:#000>(</span>09fb4a5<span style=color:#000>)</span>
</span></span><span style=display:flex><span>❯  git log --oneline --graph --decorate
</span></span><span style=display:flex><span>* 09fb4a5 <span style=color:#000>(</span>HEAD, oops<span style=color:#000>)</span> 3nd commit
</span></span><span style=display:flex><span>* 314c9df <span style=color:#000>(</span>master<span style=color:#000>)</span> 2nd commit
</span></span><span style=display:flex><span>* ae15845 initial commit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj <span style=color:#000>(</span>09fb4a5<span style=color:#000>)</span>
</span></span><span style=display:flex><span>❯ git checkout oops
</span></span><span style=display:flex><span>Switched to branch <span style=color:#c41a16>&#39;oops&#39;</span>
</span></span></code></pre></div><p>接着使用 rebase 将 oops 分支接在 master 分支的末尾 commit 之后</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>Prj on  oops
</span></span><span style=display:flex><span>❯ git rebase master
</span></span><span style=display:flex><span>Current branch oops is up to date.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj on  oops
</span></span><span style=display:flex><span>❯ git log --oneline --graph --decorate
</span></span><span style=display:flex><span>* 09fb4a5 <span style=color:#000>(</span>HEAD -&gt; oops<span style=color:#000>)</span> 3nd commit
</span></span><span style=display:flex><span>* 314c9df <span style=color:#000>(</span>master<span style=color:#000>)</span> 2nd commit
</span></span><span style=display:flex><span>* ae15845 initial commit
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj on  oops
</span></span><span style=display:flex><span>❯ git checkout master <span style=color:#000>&amp;&amp;</span> git merge oops
</span></span><span style=display:flex><span>Switched to branch <span style=color:#c41a16>&#39;master&#39;</span>
</span></span><span style=display:flex><span>Updating 314c9df..09fb4a5
</span></span><span style=display:flex><span>Fast-forward
</span></span><span style=display:flex><span> 3.txt | <span style=color:#1c01ce>1</span> +
</span></span><span style=display:flex><span> <span style=color:#1c01ce>1</span> file changed, <span style=color:#1c01ce>1</span> insertion<span style=color:#000>(</span>+<span style=color:#000>)</span>
</span></span><span style=display:flex><span> create mode <span style=color:#1c01ce>100644</span> 3.txt
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Prj on  master
</span></span><span style=display:flex><span>❯ git log --oneline --graph --decorate
</span></span><span style=display:flex><span>* 09fb4a5 <span style=color:#000>(</span>HEAD -&gt; master, oops<span style=color:#000>)</span> 3nd commit
</span></span><span style=display:flex><span>* 314c9df 2nd commit
</span></span><span style=display:flex><span>* ae15845 initial commit
</span></span></code></pre></div><p>最后删除 oops 分支：<code>git branch -d oops</code>.</p><p>参考<a href=http://matrixzk.github.io/blog/20141104/git-flow-model/>一个完美的 GitFlow 模型</a></p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java-quarkus-notes/>云原生 Java 开发框架 Quarkus 学习笔记</a></span>
<span class=post-nav-next><a href=../../post/scala3-indent-syntax/>Scala3 缩进语法总结表</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
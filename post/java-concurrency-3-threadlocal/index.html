<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Java 并发 3-ThreadLocal - zhimoe</title>
<meta property="og:title" content="Java 并发 3-ThreadLocal - zhimoe"><meta name=twitter:card content="summary"><meta property="description" content="在通常的业务开发中，ThreadLocal 有两种典型的使用场景。
[&amp;hellip;] 场景 1，ThreadLocal 用作保存每个线程独享的对象，为每个线程都创建一个副本，这样每个线程都可以修改自己所拥有的副本，而不会影响其他线程的副本，确保了线程安全。
[&amp;hellip;] 场景 2，ThreadLocal 用作每个线程内需要独立保存信息，以便供其他方法更方便地获取该信息的场景。每个线程获 &amp;hellip;"><meta property="og:description" content="在通常的业务开发中，ThreadLocal 有两种典型的使用场景。
[&amp;hellip;] 场景 1，ThreadLocal 用作保存每个线程独享的对象，为每个线程都创建一个副本，这样每个线程都可以修改自己所拥有的副本，而不会影响其他线程的副本，确保了线程安全。
[&amp;hellip;] 场景 2，ThreadLocal 用作每个线程内需要独立保存信息，以便供其他方法更方便地获取该信息的场景。每个线程获 &amp;hellip;"><link rel=stylesheet href=https://zhimoe.github.io/css/style.css><link rel=stylesheet href=https://zhimoe.github.io/css/fonts.css><link rel=stylesheet href=https://zhimoe.github.io/css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=https://zhimoe.github.io/>新街记事</a></div><div class=menu><span class=active><a href=https://zhimoe.github.io/post/>博客</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=https://zhimoe.github.io/categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=https://zhimoe.github.io/search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Java 并发 3-ThreadLocal</h1><h3 class=meta-line><span><span class=date>2016-01-01</span>
</span><span class=term><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=https://zhimoe.github.io/tags/java/ class=term-tag>#java </a><a href=https://zhimoe.github.io/tags/%E5%B9%B6%E5%8F%91/ class=term-tag>#并发</a></span></h3></div><div class=main><p>在通常的业务开发中，ThreadLocal 有两种典型的使用场景。</p><p>场景 1，ThreadLocal 用作保存每个线程独享的对象，为每个线程都创建一个副本，这样每个线程都可以修改自己所拥有的副本，而不会影响其他线程的副本，确保了线程安全。</p><p>场景 2，ThreadLocal 用作每个线程内需要独立保存信息，以便供其他方法更方便地获取该信息的场景。每个线程获取到的信息可能都是不一样的，前面执行的方法保存了信息后，后续方法可以通过 ThreadLocal 直接获取到，避免了传参，类似于全局变量的概念。</p><h3 id=场景-1保存线程不安全的工具类>场景 1：保存线程不安全的工具类</h3><p>注意：实际开发中使用 DateTimeFormatter 代替 SimpleDateFormat.</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.text.SimpleDateFormat</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.Random</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ThreadLocalExample</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Runnable</span>{
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// SimpleDateFormat is not thread-safe, so give one to each thread</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#000>&lt;</span><span style=color:#000>SimpleDateFormat</span><span style=color:#000>&gt;</span> <span style=color:#000>formatter</span> <span style=color:#000>=</span> 
</span></span><span style=display:flex><span>        <span style=color:#000>ThreadLocal</span>.<span style=color:#836c28>withInitial</span>(() <span style=color:#000>-&gt;</span> <span style=color:#a90d91>new</span> <span style=color:#000>SimpleDateFormat</span>(<span style=color:#c41a16>&#34;yyyyMMdd HHmm&#34;</span>));
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(<span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) <span style=color:#a90d91>throws</span> <span style=color:#000>InterruptedException</span> {
</span></span><span style=display:flex><span>        <span style=color:#000>ThreadLocalExample</span> <span style=color:#000>obj</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ThreadLocalExample</span>();
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span>(<span style=color:#a90d91>int</span> <span style=color:#000>i</span><span style=color:#000>=</span><span style=color:#000>0</span> ; <span style=color:#000>i</span><span style=color:#000>&lt;</span><span style=color:#000>10</span>; <span style=color:#000>i</span><span style=color:#000>++</span>){
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span> <span style=color:#000>t</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Thread</span>(<span style=color:#000>obj</span>, <span style=color:#c41a16>&#34;&#34;</span><span style=color:#000>+</span><span style=color:#000>i</span>);
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span>.<span style=color:#836c28>sleep</span>(<span style=color:#a90d91>new</span> <span style=color:#000>Random</span>().<span style=color:#836c28>nextInt</span>(<span style=color:#000>1000</span>));
</span></span><span style=display:flex><span>            <span style=color:#000>t</span>.<span style=color:#836c28>start</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>run</span>() {
</span></span><span style=display:flex><span>        <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;Thread Name= &#34;</span><span style=color:#000>+</span><span style=color:#000>Thread</span>.<span style=color:#836c28>currentThread</span>().<span style=color:#836c28>getName</span>()<span style=color:#000>+</span><span style=color:#c41a16>&#34; default Formatter = &#34;</span><span style=color:#000>+</span><span style=color:#000>formatter</span>.<span style=color:#836c28>get</span>().<span style=color:#836c28>toPattern</span>());
</span></span><span style=display:flex><span>        <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>Thread</span>.<span style=color:#836c28>sleep</span>(<span style=color:#a90d91>new</span> <span style=color:#000>Random</span>().<span style=color:#836c28>nextInt</span>(<span style=color:#000>1000</span>));
</span></span><span style=display:flex><span>        } <span style=color:#a90d91>catch</span> (<span style=color:#000>InterruptedException</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>e</span>.<span style=color:#836c28>printStackTrace</span>();
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#177500>//formatter pattern is changed here by thread, but it won&#39;t reflect to other threads</span>
</span></span><span style=display:flex><span>        <span style=color:#000>formatter</span>.<span style=color:#836c28>set</span>(<span style=color:#a90d91>new</span> <span style=color:#000>SimpleDateFormat</span>());
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>        <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;Thread Name= &#34;</span><span style=color:#000>+</span><span style=color:#000>Thread</span>.<span style=color:#836c28>currentThread</span>().<span style=color:#836c28>getName</span>()<span style=color:#000>+</span><span style=color:#c41a16>&#34; formatter = &#34;</span><span style=color:#000>+</span><span style=color:#000>formatter</span>.<span style=color:#836c28>get</span>().<span style=color:#836c28>toPattern</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=场景-2不同线程保存独立信息>场景 2：不同线程保存独立信息</h3><p>例如需要记录 mysql 的 SQL 执行耗时以及其他相关信息</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MysqlQueryInterceptor</span> <span style=color:#a90d91>implements</span> <span style=color:#000>com</span>.<span style=color:#836c28>mysql</span>.<span style=color:#836c28>cj</span>.<span style=color:#836c28>interceptors</span>.<span style=color:#836c28>QueryInterceptor</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>ThreadLocal</span><span style=color:#000>&lt;</span><span style=color:#000>LocalDateTime</span><span style=color:#000>&gt;</span> <span style=color:#000>startTimeHolder</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ThreadLocal</span><span style=color:#000>&lt;&gt;</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>&lt;</span><span style=color:#000>T</span> <span style=color:#a90d91>extends</span> <span style=color:#000>Resultset</span><span style=color:#000>&gt;</span> <span style=color:#000>T</span> <span style=color:#000>preProcess</span>(<span style=color:#000>Supplier</span><span style=color:#000>&lt;</span><span style=color:#000>String</span><span style=color:#000>&gt;</span> <span style=color:#000>supplier</span>, <span style=color:#000>Query</span> <span style=color:#000>query</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>startTimeHolder</span>.<span style=color:#836c28>set</span>(<span style=color:#000>LocalDateTime</span>.<span style=color:#836c28>now</span>());
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面的 ThreadLocal 也可以使用 slf4j 的 MDC(Mapped Diagnostic Context)。</p><nav class="post-nav fullwidth"><span>&larr; <a href=https://zhimoe.github.io/post/java-concurrency-2-control/>Java 并发 2-同步与锁</a></span>
<span><a href=https://zhimoe.github.io/post/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>Java 动态代理</a> &rarr;</span></nav></div><footer class=small><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=https://zhimoe.github.io/categories/>Categories</a> <a href=https://zhimoe.github.io/tags/>Tags</a>
<a href=https://zhimoe.github.io/post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Java Vector Api 和 Elasticsearch 性能提升 - zhimoe</title>
<meta property="og:title" content="Java Vector Api 和 Elasticsearch 性能提升 - zhimoe"><meta name=twitter:card content="summary"><meta property="description" content="OpenJDK project panama 中一个重点功能就是 vector api，可以显著提升矩阵计算密集型程序的性能，例如在图形计算、机器学习、大规模计算（Lucene）等。
[&amp;hellip;] CPU 的每个处理单元一次运算只能计算一个值，这个值成为标量值（scalar value）。处理单元需要 0 或多个周期（即 CPU 频率）完成一次操作计算。现代 CPU 包含多个核心，每个核心 &amp;hellip;"><meta property="og:description" content="OpenJDK project panama 中一个重点功能就是 vector api，可以显著提升矩阵计算密集型程序的性能，例如在图形计算、机器学习、大规模计算（Lucene）等。
[&amp;hellip;] CPU 的每个处理单元一次运算只能计算一个值，这个值成为标量值（scalar value）。处理单元需要 0 或多个周期（即 CPU 频率）完成一次操作计算。现代 CPU 包含多个核心，每个核心 &amp;hellip;"><link rel=stylesheet href=https://zhimoe.github.io/css/style.css><link rel=stylesheet href=https://zhimoe.github.io/css/fonts.css><link rel=stylesheet href=https://zhimoe.github.io/css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=https://zhimoe.github.io/>新街记事</a></div><div class=menu><span class=active><a href=https://zhimoe.github.io/post/>博客</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=https://zhimoe.github.io/categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=https://zhimoe.github.io/search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Java Vector Api 和 Elasticsearch 性能提升</h1><h3 class=meta-line><span><span class=date>2023-11-18</span>
</span><span class=term><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=https://zhimoe.github.io/tags/code/ class=term-tag>#code </a><a href=https://zhimoe.github.io/tags/java/ class=term-tag>#java</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#什么是-simd>什么是 SIMD</a></li><li><a href=#java-vector-api>Java Vector API</a></li><li><a href=#lanes-shapes-and-species>Lanes, Shapes and Species</a></li><li><a href=#elasticsearch-中-vector-api-的使用>Elasticsearch 中 vector api 的使用</a></li></ul></nav><p>OpenJDK project panama 中一个重点功能就是 vector api，可以显著提升矩阵计算密集型程序的性能，例如在图形计算、机器学习、大规模计算（Lucene）等。</p><h3 id=什么是-simd>什么是 SIMD</h3><p>CPU 的每个处理单元一次运算只能计算一个值，这个值成为标量值（scalar value）。处理单元需要 0 或多个周期（即 CPU 频率）完成一次操作计算。现代 CPU 包含多个核心，每个核心包含很多处理单元，这样就提供了并行在处理单元上面执行操作的能力。</p><p>当进行大规模计算时，例如从海量数据源中添加大量数字，程序可以将数据分割成更小的数据块并将它们分布在多个线程中，能够获得更快的处理速度。这是进行并行计算的方法之一。但是即便如此，这些操作还是属于 SISD，即单指令单数据。</p><p>SIMD(Single Instruction Multiple Data) 表示单指令多数据。SIMD 处理器是特殊的处理器，它没有多线程的概念，依赖多个处理单元，能够在一个 CPU 周期中执行相同的操作，但是每个处理单元的数据不相同，因此得名。SIMD 在现实中有很多实际的例子，比如两个数组相加。</p><p>与处理器从内存加载标量值的方式不同，SIMD 机器在操作之前将内存中的整数数组加载到寄存器中。SIMD 硬件的组织方式使得值数组的加载操作能够在单个周期内进行。SIMD 机器允许我们并行地对数组执行计算，而无需实际依赖并发编程。</p><p>由于 SIMD 机器将内存视为数组或一系列值，因此我们将其称为向量，并且 SIMD 机器执行的任何操作都成为向量操作。因此，这是一种利用 SIMD 架构原理来执行并行处理任务的非常强大且高效的方法。</p><h3 id=java-vector-api>Java Vector API</h3><p>Vector API 希望让开发人员能够以与平台无关的方式编写数据并行软件，充分利用 SIMD 处理器的优势但是不用接触 CPU 架构（AMD or Intel）。<br>还是以数组相加为例子：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>moe.zhi.boot.app</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>jdk.incubator.vector.IntVector</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>jdk.incubator.vector.VectorSpecies</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.Arrays</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import static</span> <span style=color:#000>java.lang.StringTemplate.STR</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>VectorDemo</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(<span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>a</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[]</span>{<span style=color:#000>1</span>, <span style=color:#000>2</span>, <span style=color:#000>3</span>, <span style=color:#000>4</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>1</span>, <span style=color:#000>1</span>};
</span></span><span style=display:flex><span>        <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>b</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[]</span>{<span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>, <span style=color:#000>9</span>, <span style=color:#000>8</span>, <span style=color:#000>7</span>, <span style=color:#000>6</span>};
</span></span><span style=display:flex><span>        <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>c</span> <span style=color:#000>=</span> <span style=color:#000>simpleSum</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>Arrays</span>.<span style=color:#836c28>toString</span>(<span style=color:#000>c</span>));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>d</span> <span style=color:#000>=</span> <span style=color:#000>vectorSum</span>(<span style=color:#000>a</span>, <span style=color:#000>b</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>Arrays</span>.<span style=color:#836c28>toString</span>(<span style=color:#000>d</span>));
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>simpleSum</span>(<span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>a</span>, <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>b</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>c</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[</span><span style=color:#000>a</span>.<span style=color:#836c28>length</span><span style=color:#000>]</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> (<span style=color:#a90d91>var</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span>; <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>a</span>.<span style=color:#836c28>length</span>; <span style=color:#000>i</span><span style=color:#000>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>c</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>=</span> <span style=color:#000>a</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>+</span> <span style=color:#000>b</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>c</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>VectorSpecies</span><span style=color:#000>&lt;</span><span style=color:#000>Integer</span><span style=color:#000>&gt;</span> <span style=color:#000>SPECIES</span> <span style=color:#000>=</span> <span style=color:#000>IntVector</span>.<span style=color:#836c28>SPECIES_PREFERRED</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>vectorSum</span>(<span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>a</span>, <span style=color:#a90d91>int</span><span style=color:#000>[]</span> <span style=color:#000>b</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>c</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#a90d91>int</span><span style=color:#000>[</span><span style=color:#000>a</span>.<span style=color:#836c28>length</span><span style=color:#000>]</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>upperBound</span> <span style=color:#000>=</span> <span style=color:#000>SPECIES</span>.<span style=color:#836c28>loopBound</span>(<span style=color:#000>a</span>.<span style=color:#836c28>length</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>STR</span>. <span style=color:#c41a16>&#34;upperBound = \{ upperBound }&#34;</span> );
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>i</span> <span style=color:#000>=</span> <span style=color:#000>0</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> (; <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>upperBound</span>; <span style=color:#000>i</span> <span style=color:#000>+=</span> <span style=color:#000>SPECIES</span>.<span style=color:#836c28>length</span>()) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>var</span> <span style=color:#000>va</span> <span style=color:#000>=</span> <span style=color:#000>IntVector</span>.<span style=color:#836c28>fromArray</span>(<span style=color:#000>SPECIES</span>, <span style=color:#000>a</span>, <span style=color:#000>i</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>var</span> <span style=color:#000>vb</span> <span style=color:#000>=</span> <span style=color:#000>IntVector</span>.<span style=color:#836c28>fromArray</span>(<span style=color:#000>SPECIES</span>, <span style=color:#000>b</span>, <span style=color:#000>i</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>var</span> <span style=color:#000>vc</span> <span style=color:#000>=</span> <span style=color:#000>va</span>.<span style=color:#836c28>add</span>(<span style=color:#000>vb</span>);
</span></span><span style=display:flex><span>            <span style=color:#000>vc</span>.<span style=color:#836c28>intoArray</span>(<span style=color:#000>c</span>, <span style=color:#000>i</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#177500>// Compute elements not fitting in the vector alignment.</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> (; <span style=color:#000>i</span> <span style=color:#000>&lt;</span> <span style=color:#000>a</span>.<span style=color:#836c28>length</span>; <span style=color:#000>i</span><span style=color:#000>++</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>STR</span>. <span style=color:#c41a16>&#34;current i is \{ i }&#34;</span> );
</span></span><span style=display:flex><span>            <span style=color:#000>c</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>=</span> <span style=color:#000>a</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span> <span style=color:#000>+</span> <span style=color:#000>b</span><span style=color:#000>[</span><span style=color:#000>i</span><span style=color:#000>]</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>c</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 运行</span>
</span></span><span style=display:flex><span><span style=color:#177500>//❯ java --enable-preview --source 21 --add-modules jdk.incubator.vector VectorDemo.java</span>
</span></span><span style=display:flex><span><span style=color:#177500>//WARNING: Using incubator modules: jdk.incubator.vector</span>
</span></span><span style=display:flex><span><span style=color:#177500>//注：VectorDemo.java 使用 Java SE 21 的预览功能。</span>
</span></span><span style=display:flex><span><span style=color:#177500>//注：有关详细信息，请使用 -Xlint:preview 重新编译。</span>
</span></span><span style=display:flex><span><span style=color:#177500>//[10, 10, 10, 10, 18, 16, 14, 12, 18, 16, 14, 12, 18, 16, 14, 12, 10, 9]</span>
</span></span><span style=display:flex><span><span style=color:#177500>//upperBound = 16</span>
</span></span><span style=display:flex><span><span style=color:#177500>//current i is 16</span>
</span></span><span style=display:flex><span><span style=color:#177500>//current i is 17</span>
</span></span><span style=display:flex><span><span style=color:#177500>//[10, 10, 10, 10, 18, 16, 14, 12, 18, 16, 14, 12, 18, 16, 14, 12, 10, 9]</span>
</span></span></code></pre></div><p>可以看到 vector api 相对更加复杂，包含了一个位宽移动和扫尾操作。简单的 for 循环使用 i++ 将索引加一；但是在 vector api 中，需要根据 SIMD 寄存器的数据宽度进行移位。最后，还需要处理未在数据宽度内对齐的所有剩余项目。</p><h3 id=lanes-shapes-and-species>Lanes, Shapes and Species</h3><p>CPU 的 SIMD 处理器位数一般为 64 到 512 位，一个 int 向量每个 int 值是 32 bits，对于 64 位的 SIMD 处理器，则有 2 个分量，在 vector api 中称为通道（lane）。这里 64 称为 vector 的 shape。vector 的 shape 和数据类型称为 species &ndash; 通过<code>class VectorSpecies&lt;E></code>表示。</p><p>vector 的运算分为通道运算和跨通道运算（lane-wise operations and cross-lane operations）。是不是和线性代数的知识联系起来了？</p><p><code>class Vector</code> 对于六种支持类型中的每一种都有六个抽象子类：<code>ByteVector、ShortVector、IntVector、LongVector、FloatVector 和 DoubleVector</code>。对于 SIMD 机器来说，特定的实现非常重要，这就是为什么形状特定的子类进一步扩展了每种类型的这些类。例如 <code>Int128Vector、Int512Vector</code> 等。</p><h3 id=elasticsearch-中-vector-api-的使用>Elasticsearch 中 vector api 的使用</h3><p>ES 在 JDK20 以上已经可以使用 vector api，具体 PR:<a href=https://github.com/elastic/elasticsearch/pull/96453>Enable the Panama Vector module #96453</a>。关于性能提升的一点<a href=https://github.com/elastic/elasticsearch/issues/96370>参考</a>：</p><blockquote><p>indexing-throughput improved by 30%<br>merge-time decreased by 40%<br>script-score-query-java-latency improved by 40%</p></blockquote><p><a href=https://www.elastic.co/cn/blog/accelerating-vector-search-simd-instructions>作者更加详细的博客：Accelerating vector search with SIMD instructions</a><br>需要注意的是 SIMD 严重依赖 CPU 架构，而且 API 当前还是 incubator 阶段，上面的结果只是参考。</p><p>具体使用 vector api 参考 <a href=https://github.com/apache/lucene/blob/b3ef869681a5cbabc7e6ae3b497c88bdec057b71/lucene/core/src/java20/org/apache/lucene/internal/vectorization/PanamaVectorUtilSupport.java#L29>org.apache.lucene.internal.vectorization.PanamaVectorUtilSupport</a></p><nav class="post-nav fullwidth"><span></span>
<span><a href=https://zhimoe.github.io/post/python-contextlib/>Python @contextlib.contextmanager 的使用</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=https://zhimoe.github.io/categories/>Categories</a> <a href=https://zhimoe.github.io/tags/>Tags</a>
<a href=https://zhimoe.github.io/post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
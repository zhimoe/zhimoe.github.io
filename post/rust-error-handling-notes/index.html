<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Rust Error Handling Notes - 香取海</title>
<meta property="og:title" content="Rust Error Handling Notes - 香取海"><meta name=twitter:card content="summary"><meta property="description" content="初学 rust 的时候，上手写代码总是遇到很多不一样的 rust 的Result类型，不同 crate 中的函数返回的Result&amp;lt;T, E&amp;gt;的E都不一样，刚开始都是unwrap或者expect来处理。如果使用try!或者?的话总是编译不通过，还是对 Error 转换和处理不熟练。
[&amp;hellip;] 在一个方法中，调用不同的函数会返回不同的 error 类型，需要你将这些类型转换成 &amp;hellip;"><meta property="og:description" content="初学 rust 的时候，上手写代码总是遇到很多不一样的 rust 的Result类型，不同 crate 中的函数返回的Result&amp;lt;T, E&amp;gt;的E都不一样，刚开始都是unwrap或者expect来处理。如果使用try!或者?的话总是编译不通过，还是对 Error 转换和处理不熟练。
[&amp;hellip;] 在一个方法中，调用不同的函数会返回不同的 error 类型，需要你将这些类型转换成 &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>香取海</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Rust Error Handling Notes</h1><h3 class=meta-line><span><span class=date>2023-07-22</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/rust/ class=term-tag>#rust </a><a href=../../tags/notes/ class=term-tag>#notes</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#error-转换>Error 转换</a></li><li><a href=#使用-map_err>使用 map_err</a></li><li><a href=#thiserror>thiserror</a></li><li><a href=#anyhow>anyhow</a></li></ul></nav><p>初学 rust 的时候，上手写代码总是遇到很多不一样的 rust 的<code>Result</code>类型，不同 crate 中的函数返回的<code>Result&lt;T, E></code>的<code>E</code>都不一样，刚开始都是<code>unwrap</code>或者<code>expect</code>来处理。如果使用<code>try!</code>或者<code>?</code>的话总是编译不通过，还是对 Error 转换和处理不熟练。</p><h3 id=error-转换>Error 转换</h3><p>在一个方法中，调用不同的函数会返回不同的 error 类型，需要你将这些类型转换成统一的自定义 error 类型再返回。你有以下几种途径</p><h3 id=使用-map_err>使用 map_err</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>cook_pasta</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span><span style=color:#000>Pasta</span>, <span style=color:#000>CookingError</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>water</span> <span style=color:#000>=</span> <span style=color:#000>boil_water</span>().<span style=color:#000>map_err</span>(<span style=color:#000>|</span><span style=color:#000>_</span><span style=color:#000>|</span> <span style=color:#000>CookingError</span>::<span style=color:#000>BoilWaterError</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>pasta</span> <span style=color:#000>=</span> <span style=color:#000>add_pasta</span>(<span style=color:#000>&amp;</span><span style=color:#000>water</span>).<span style=color:#000>map_err</span>(<span style=color:#000>|</span><span style=color:#000>_</span><span style=color:#000>|</span> <span style=color:#000>CookingError</span>::<span style=color:#000>AddPastaError</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>Ok</span>(<span style=color:#000>pasta</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 通过 map_err 将 boil_water() 和 add_pasta(&amp;water) 返回的 error 都转换成了 CookingError 类型
</span></span></span></code></pre></div><h4 id=使用-stderrorerrorfrom-trait>使用 std::error::Error+From trait</h4><p>定义自己的 Error 类型并实现 From trait。From trait 用于将 boil_water() 和 add_pasta(&amp;water) 的 error 转换成自定义的 Error。其实就是将<code>map_err</code>的逻辑移动到 From trait 中实现，使得方法调用处看起来更简洁。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a90d91>pub</span> <span style=color:#a90d91>enum</span> <span style=color:#3f6e75>CookingError</span>{
</span></span><span style=display:flex><span>    <span style=color:#000>BoilWaterError</span>(<span style=color:#a90d91>String</span>),
</span></span><span style=display:flex><span>    <span style=color:#000>AddPastaError</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>impl</span> <span style=color:#000>std</span>::<span style=color:#000>error</span>::<span style=color:#000>Error</span> <span style=color:#a90d91>for</span> <span style=color:#000>CookingError</span>{
</span></span><span style=display:flex><span>    <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span><span style=display:flex><span><span style=color:#a90d91>impl</span> <span style=color:#000>Display</span> <span style=color:#a90d91>for</span> <span style=color:#000>CookingError</span>{
</span></span><span style=display:flex><span>    <span style=color:#177500>// ...
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 假设 boil_water 返回的 error 是 NoWaterError
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>impl</span> <span style=color:#a90d91>From</span><span style=color:#000>&lt;</span><span style=color:#000>NoWaterError</span><span style=color:#000>&gt;</span> <span style=color:#a90d91>for</span> <span style=color:#000>CookingError</span> {
</span></span><span style=display:flex><span> <span style=color:#a90d91>fn</span> <span style=color:#000>from</span>(<span style=color:#000>s</span>: <span style=color:#3f6e75>NoWaterError</span>) -&gt; <span style=color:#3f6e75>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#000>CookingError</span>::<span style=color:#000>BoilWaterError</span>(<span style=color:#000>s</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 假设 add_pasta 返回的 error 是 IoError
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>impl</span> <span style=color:#a90d91>From</span><span style=color:#000>&lt;</span><span style=color:#000>IoError</span><span style=color:#000>&gt;</span> <span style=color:#a90d91>for</span> <span style=color:#000>CustomError</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>fn</span> <span style=color:#000>from</span>(<span style=color:#000>s</span>: <span style=color:#3f6e75>std</span>::<span style=color:#000>io</span>::<span style=color:#000>Error</span>) -&gt; <span style=color:#3f6e75>Self</span> {
</span></span><span style=display:flex><span>        <span style=color:#000>CookingError</span>::<span style=color:#000>AddPastaError</span>(<span style=color:#000>s</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#177500>// 无需 map_err
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>fn</span> <span style=color:#000>cook_pasta</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span><span style=color:#000>Pasta</span>, <span style=color:#000>CookingError</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>water</span> <span style=color:#000>=</span> <span style=color:#000>boil_water</span>()<span style=color:#000>?</span>; <span style=color:#177500>// 如果抛出 NoWaterError，自动转成 CookingError::BoilWaterError，下面同理
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#a90d91>let</span> <span style=color:#000>pasta</span> <span style=color:#000>=</span> <span style=color:#000>add_pasta</span>(<span style=color:#000>&amp;</span><span style=color:#000>water</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>Ok</span>(<span style=color:#000>pasta</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=thiserror>thiserror</h3><p>thiserror 可以看作是定义 Error 的一个工具，它只帮你生成一些定义 Error 的代码，别的什么都不做，相当纯粹。如果你在开发一个 crate，那么建议使用 thiserror。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>render</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span><span style=color:#a90d91>String</span>, <span style=color:#000>std</span>::<span style=color:#000>io</span>::<span style=color:#000>Error</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>let</span> <span style=color:#000>file</span> <span style=color:#000>=</span> <span style=color:#000>std</span>::<span style=color:#000>env</span>::<span style=color:#000>var</span>(<span style=color:#c41a16>&#34;MARKDOWN&#34;</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>let</span> <span style=color:#000>source</span> <span style=color:#000>=</span> <span style=color:#000>read_to_string</span>(<span style=color:#000>file</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>Ok</span>(<span style=color:#000>source</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>上面的代码无法通过编译，因为<code>env::var()</code> 返回的是 <code>std::env::VarError</code>，而 <code>read_to_string()</code> 返回的是 <code>std::io::Error</code>。<br>为了满足 render 函数的签名，我们就需要将 env::VarError 和 io::Error 归一化为同一种错误类型。要实现这个目的有三种方式：</p><ul><li>使用特征对象 <code>Box&lt;dyn Error></code>。实际上就是错误类型泛化，失去了具体错误类型的信息，类似于在 Java 中使用<code>Object</code>类型。</li><li>自定义错误类型。比较繁琐，上面的例子在自定义 Error 类型后，需要分别为<code>env::VarError</code> 和 <code>io::Error</code>实现<code>From</code> trait 才行。</li><li>使用 <code>thiserror</code>。简化自定义错误类型的繁琐：</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a90d91>use</span> <span style=color:#000>std</span>::<span style=color:#000>fs</span>::<span style=color:#000>read_to_string</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>main</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span>(), <span style=color:#000>MyError</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>let</span> <span style=color:#000>html</span> <span style=color:#000>=</span> <span style=color:#000>render</span>()<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#000>println!</span>(<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>{}</span><span style=color:#c41a16>&#34;</span>, <span style=color:#000>html</span>);
</span></span><span style=display:flex><span>  <span style=color:#a90d91>Ok</span>(())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>render</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span><span style=color:#a90d91>String</span>, <span style=color:#000>MyError</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>  <span style=color:#a90d91>let</span> <span style=color:#000>file</span> <span style=color:#000>=</span> <span style=color:#000>std</span>::<span style=color:#000>env</span>::<span style=color:#000>var</span>(<span style=color:#c41a16>&#34;MARKDOWN&#34;</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>let</span> <span style=color:#000>source</span> <span style=color:#000>=</span> <span style=color:#000>read_to_string</span>(<span style=color:#000>file</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>Ok</span>(<span style=color:#000>source</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#633820>#[derive(thiserror::Error, Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>enum</span> <span style=color:#3f6e75>MyError</span> {
</span></span><span style=display:flex><span>  <span style=color:#633820>#[error(</span><span style=color:#c41a16>&#34;Environment variable not found&#34;</span><span style=color:#633820>)]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>EnvironmentVariableNotFound</span>(<span style=color:#633820>#[from]</span> <span style=color:#000>std</span>::<span style=color:#000>env</span>::<span style=color:#000>VarError</span>),
</span></span><span style=display:flex><span>  <span style=color:#633820>#[error(transparent)]</span>
</span></span><span style=display:flex><span>  <span style=color:#000>IOError</span>(<span style=color:#633820>#[from]</span> <span style=color:#000>std</span>::<span style=color:#000>io</span>::<span style=color:#000>Error</span>),
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>thiserror</code>提供<code>#[from]</code> <code>#[error]</code>等注解简化错误类型自定义工作。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#633820>#[derive(Error)]</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>    <span style=color:#177500>// Attributes available to this derive:
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#633820>#[backtrace]</span> <span style=color:#177500>// 
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    <span style=color:#633820>#[error]</span>
</span></span><span style=display:flex><span>    <span style=color:#633820>#[from]</span>
</span></span><span style=display:flex><span>    <span style=color:#633820>#[source]</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p><code>error(transparent)</code> 表示转发底层 error 的相关信息，不修改 source 和 Display 相关方法。</p><h3 id=anyhow>anyhow</h3><p>anyhow 为你定义好了一个 Error 类型，基本可以看作是一个 Box<dyn error> ，同时还提供了一些如 context 等扩展功能，用起来更加无脑。如果你在开发一个业务 app，建议使用 anyhow 更加方便。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#a90d91>use</span> <span style=color:#000>anyhow</span>::<span style=color:#a90d91>Result</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>main</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span>()<span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>html</span> <span style=color:#000>=</span> <span style=color:#000>render</span>()<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#000>println!</span>(<span style=color:#c41a16>&#34;</span><span style=color:#c41a16>{}</span><span style=color:#c41a16>&#34;</span>, <span style=color:#000>html</span>);
</span></span><span style=display:flex><span>    <span style=color:#a90d91>Ok</span>(())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fn</span> <span style=color:#000>render</span>() -&gt; <span style=color:#a90d91>Result</span><span style=color:#000>&lt;</span><span style=color:#a90d91>String</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>file</span> <span style=color:#000>=</span> <span style=color:#000>std</span>::<span style=color:#000>env</span>::<span style=color:#000>var</span>(<span style=color:#c41a16>&#34;MARKDOWN&#34;</span>)<span style=color:#000>?</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>source</span> <span style=color:#000>=</span> <span style=color:#000>read_to_string</span>(<span style=color:#000>file</span>).<span style=color:#000>with_context</span>(<span style=color:#000>||</span> <span style=color:#000>format!</span>(<span style=color:#c41a16>&#34;read string from </span><span style=color:#c41a16>{}</span><span style=color:#c41a16> failed&#34;</span>, <span style=color:#000>&amp;</span><span style=color:#000>file</span>))<span style=color:#000>?</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>Ok</span>(<span style=color:#000>source</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以看到这里使用的是<code>Result&lt;String></code>,实际上这是<code>anyhow</code>的 type alias：<code>pub type Result&lt;T, E = Error> = core::result::Result&lt;T, E>;</code></p><p><code>anyhow</code> 还提供了<code>with_context</code>给 error 添加信息，看上去和 expect 类似，只不过那是 panic。</p><p>对于一个 app 服务，一些核心登录等功能可能也需要自定义 error 类型，这时可以将<code>anyhow::Error</code>作为其中一种 error 类型，即 thiserror + anyhow：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#633820>#[derive(Error, Debug)]</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>pub</span> <span style=color:#a90d91>enum</span> <span style=color:#3f6e75>AppError</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>..</span>.
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#633820>#[error(transparent)]</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Other</span>(<span style=color:#633820>#[from]</span> <span style=color:#000>anyhow</span>::<span style=color:#000>Error</span>),  <span style=color:#177500>// source and Display delegate to anyhow::Error
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span></code></pre></div><p>参考：<br><a href=https://rustwiki.org/zh-CN/rust-by-example/error/multiple_error_types.html>rust by example - 处理多种错误类型</a><br><a href=https://zyfjeff.github.io/%E5%8D%9A%E5%AE%A2/doc/rust/rust-error-handle/>Option 和 Result 的一些方法</a><br><a href=https://doc.rust-lang.org/book/ch09-00-error-handling.html>rust doc Error Handling</a><br><a href=https://lotabout.me/2017/rust-error-handling/>简谈 Rust 中的错误处理</a><br><a href=https://baoyachi.github.io/Rust/rust_error_handle.html#%E7%BB%86%E8%AF%B4rust%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86>细说 rust 错误处理</a><br><a href=https://doc.rust-lang.org/rust-by-example/std/result/question_mark.html>?在 Result 中的使用</a><br><a href=https://rustmagazine.github.io/rust_magazine_2021/chapter_2/rust_error_handle.html>蚂蚁集团 CeresDB 团队 | 关于 Rust 错误处理的思考</a></p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/git-internal/>Git 内部原理-对象、分支以及底层命令[翻译]</a></span>
<span class=post-nav-next><a href=../../post/python-read-large-excel-file/>使用 OpenPyXL 读写 excel 大文件</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>SpringBoot 应用和 Rust 应用的 Dockerfile 最佳实践 - 新街记事</title>
<meta property="og:title" content="SpringBoot 应用和 Rust 应用的 Dockerfile 最佳实践 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="记录 spring boot 和 rust 项目的 Dockerfile 的最佳实践。
[&amp;hellip;] spring.io 提供了一个 boot 应用的Dockerfile指导。
不过有个问题，这个 Dockerfile 使用的 maven 是项目源码里面 copy 过去的。在一般企业项目中这么做显然不规范，直接使用 maven 基础镜像更合理。
[&amp;hellip;] Dockerfile  &amp;hellip;"><meta property="og:description" content="记录 spring boot 和 rust 项目的 Dockerfile 的最佳实践。
[&amp;hellip;] spring.io 提供了一个 boot 应用的Dockerfile指导。
不过有个问题，这个 Dockerfile 使用的 maven 是项目源码里面 copy 过去的。在一般企业项目中这么做显然不规范，直接使用 maven 基础镜像更合理。
[&amp;hellip;] Dockerfile  &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>SpringBoot 应用和 Rust 应用的 Dockerfile 最佳实践</h1><h3 class=meta-line><span><span class=date>2020-02-03</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/docker/ class=term-tag>#docker </a><a href=../../tags/spring/ class=term-tag>#spring </a><a href=../../tags/rust/ class=term-tag>#rust</a></span></h3></div><div class=main><p>记录 spring boot 和 rust 项目的 Dockerfile 的最佳实践。</p><h2 id=spring-boot-应用-dockerfile>spring boot 应用 Dockerfile</h2><p>spring.io 提供了一个 boot 应用的<a href=https://spring.io/guides/topicals/spring-boot-docker>Dockerfile</a>指导。<br>不过有个问题，这个 Dockerfile 使用的 maven 是项目源码里面 copy 过去的。在一般企业项目中这么做显然不规范，直接使用 maven 基础镜像更合理。</p><p>Dockerfile 的最终版：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#177500># syntax=docker/Dockerfile:experimental</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> maven:3-jdk-8-alpine as build</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> /workspace/app</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> pom.xml .<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> src src<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> --mount<span style=color:#000>=</span><span style=color:#000>type</span><span style=color:#000>=</span>cache,target<span style=color:#000>=</span>/root/.m2  mvn package -DskipTests<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># app base image</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> openjdk:8-jdk-alpine</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>VOLUME</span><span style=color:#c41a16> /tmp</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>ARG</span> <span style=color:#000>BUILD</span><span style=color:#000>=</span>/workspace/app/target<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> /app</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --from<span style=color:#000>=</span>build <span style=color:#c41a16>${</span><span style=color:#000>BUILD</span><span style=color:#c41a16>}</span>/*.jar .<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> jar -xf  ./*.jar<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> rm ./*.jar<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>ENTRYPOINT</span> [<span style=color:#c41a16>&#34;java&#34;</span>,<span style=color:#c41a16>&#34;-cp&#34;</span>,<span style=color:#c41a16>&#34;/app&#34;</span>,<span style=color:#c41a16>&#34;org.springframework.boot.loader.JarLauncher&#34;</span>]<span style=color:#000>
</span></span></span></code></pre></div><p>要点：</p><ol><li><code># syntax=docker/Dockerfile:experimental</code>表示启用 docker 实验特性 BuildKit 的 mount cache 功能，这样可以利用 maven lib 的 cache 提高镜像构建速度。可以搜索 docker BuildKit 了解。<br>如果没有这一行，那么下面的<code>--mount=type=cache,target=/root/.m2</code>就是非法的。由于是实验特性，构建镜像的时候需要设置一个环境变量<code>DOCKER_BUILDKIT=1</code>才能运行：<code> DOCKER_BUILDKIT=1 docker build -t zhimoe/boot-app .</code></li><li>spring.io 的教程里面使用的 build 镜像是<code>openjdk:8-jdk-alpine</code>，这个镜像是没有 maven 的，因为教程中的 Dockerfile 从源码复制了<code>mvnw和.mvn/</code>到镜像去。所以这里替换为<code>maven:3-jdk-8-alpine</code></li><li>使用了 docker 的<a href=https://docs.docker.com/develop/develop-images/multistage-build/>multi-stage build</a>功能，<code>openjdk:8-jdk-alpine</code>由于没有 maven，所以会比<code>maven</code>镜像少 20M.</li><li>spring.io 的教程里面在 ENTRYPOINT 里面是直接设置 main class 启动应用的。这种硬编码方式不通用也不利于维护 (修改 main class name 后 Dockerfile 也要修改).只要将应用的 jar 包解压出来的 org 目录 (即 org.springframework.boot.loader.jar 解压内容，不到 1M) 保留，即可通过<code>org.springframework.boot.loader.JarLauncher</code>启动应用。</li><li>注意<code>java -cp /app</code>中的 classpath:<code>/app</code> 一定是绝对路径，否则 java 找不到 main class，报错：<code>Error: Could not find or load main class org.springframework.boot.loader.JarLauncher</code></li></ol><h2 id=rust-应用-dockerfile>rust 应用 Dockerfile</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Dockerfile data-lang=Dockerfile><span style=display:flex><span><span style=color:#177500># pull the latest version of Rust</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> rust:latest AS builder</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># create a new empty shell project</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> <span style=color:#000>USER</span><span style=color:#000>=</span>root cargo new --bin prj<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>WORKDIR</span><span style=color:#c41a16> /prj</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># copy the manifests to WORKDIR/src</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> ./Cargo.lock ./Cargo.toml ./<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># change the crate.io source url if in China mainland</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> ./config <span style=color:#000>$CARGO_HOME</span>/<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># build without project source code</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># this build step will cache your dependencies</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> cargo build --release<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># remove the WORKDIR/src</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> rm -r src/*<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># copy your source files to WORKDIR/src</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> ./src ./src<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> ./static ./static<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># build for release, </span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># note! the Cargo.toml package name in deps is _, not -</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> rm ./target/release/deps/rs_notes*<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> cargo build --release<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>RUN</span> mv ./target/release/rs-notes .<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500>## 2 stage build</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># our final base</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>FROM</span><span style=color:#c41a16> debian:stretch-slim AS app</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># for connecting to postgres and TLS hosts</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># RUN apt update -y &amp;&amp; apt install -y libpq-dev openssl libssl1.0-dev ca-certificates</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># copy the build artifact and static resources from the build stage</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --from<span style=color:#000>=</span>builder /prj/rs-notes ./<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>COPY</span> --from<span style=color:#000>=</span>builder /prj/static ./static<span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#177500># set the startup command to run your binary</span><span style=color:#000>
</span></span></span><span style=display:flex><span><span style=color:#000></span><span style=color:#a90d91>CMD</span> [<span style=color:#c41a16>&#34;./rs-notes&#34;</span>]<span style=color:#000>
</span></span></span></code></pre></div><p>要点：</p><ol><li>如果使用 scratch 或者 alpine 镜像，那么需要将编译目标设置为<code>MUSL</code>，网络上有教程，感觉不需要考虑这个体积问题。rust 应用使用 debian-slim 基本在 60M 左右，只有 spring boot 应用镜像的一半大小。</li><li>在国内由于网络问题，所以修改了 cargo 的 crate.io mirror 地址：<code>COPY ./config $CARGO_HOME/</code>. config 内容如下：</li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=display:flex><span><span style=color:#a90d91>[source.crates-io]</span>
</span></span><span style=display:flex><span><span style=color:#836c28>registry</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;https://github.com/rust-lang/crates.io-index&#34;</span>
</span></span><span style=display:flex><span><span style=color:#836c28>replace-with</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#39;ustc&#39;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>[source.ustc]</span>
</span></span><span style=display:flex><span><span style=color:#836c28>registry</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;git://mirrors.ustc.edu.cn/crates.io-index&#34;</span>
</span></span></code></pre></div><ol start=3><li>build 中使用了 cargo 缓存，即先将项目 Cargo.toml 和 Cargo.lock 复制到一个空项目中编译，然后再将源码复制进去编译。</li><li><code>RUN rm ./target/release/deps/rs_notes*</code>，注意这里的<code>rs_notes</code>是下划线，是 cargo 中 package name 转换为 crate name 的默认规则。</li></ol><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/rust-ownership-lifetimes/>Rust Ownerships Lifetimes 教程</a></span>
<span class=post-nav-next><a href=../../post/docker-cmd-entrypoint-diff/>Docker CMD ENTRYPOINT 区别</a> &rarr;</span></nav></div><footer class=small><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/ol-id.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
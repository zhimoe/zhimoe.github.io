<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Java 动态代理 - 新街记事</title>
<meta property="og:title" content="Java 动态代理 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="Java 动态代理机制分析及扩展，更深入的一篇：java 设计模式 - 动态代理模式
[&amp;hellip;] 相比 静态代理，动态代理具有更强的 灵活性，因为它不用在我们设计实现的时候就指定 某一个代理类来代理哪一个被代理对象，我们可以把这种指定延迟到程序运行时由 JVM 来实现。
[&amp;hellip;] 动态代理类接口，接口规范方法。
[&amp;hellip;] package &amp;hellip;"><meta property="og:description" content="Java 动态代理机制分析及扩展，更深入的一篇：java 设计模式 - 动态代理模式
[&amp;hellip;] 相比 静态代理，动态代理具有更强的 灵活性，因为它不用在我们设计实现的时候就指定 某一个代理类来代理哪一个被代理对象，我们可以把这种指定延迟到程序运行时由 JVM 来实现。
[&amp;hellip;] 动态代理类接口，接口规范方法。
[&amp;hellip;] package &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Java 动态代理</h1><h3 class=meta-line><span><span class=date>2016-01-01</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/java/ class=term-tag>#java </a><a href=../../tags/code/ class=term-tag>#code</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#好文>好文</a></li><li><a href=#优势>优势</a></li><li><a href=#实例>实例</a></li><li><a href=#源码分析>源码分析</a></li></ul></nav><h3 id=好文>好文</h3><p><a href=http://www.ibm.com/developerworks/cn/java/j-lo-proxy1/>Java 动态代理机制分析及扩展</a>，更深入的一篇：<a href=http://nemotan.github.io/2015/11/java%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F-%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%A8%A1%E5%BC%8F/>java 设计模式 - 动态代理模式</a></p><h3 id=优势>优势</h3><p>相比 静态代理，动态代理具有更强的 灵活性，因为它不用在我们设计实现的时候就指定 某一个代理类来代理哪一个被代理对象，我们可以把这种指定延迟到程序运行时由 JVM 来实现。</p><h3 id=实例>实例</h3><p>动态代理类接口，接口规范方法。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>angus.interview.proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>interface</span> <span style=color:#3f6e75>Subject</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>request</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>需要被代理的真实的类：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>angus.interview.proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>SubjectImpl</span> <span style=color:#a90d91>implements</span> <span style=color:#000>Subject</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>void</span> <span style=color:#000>request</span>() {
</span></span><span style=display:flex><span>		<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34; subject request&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>先创建一个代理类。然后利用反射创建一个用真实类加载器创建的一个对象。该对象调用 request 方法实际上调用的是代理类的 invoke 方法。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>angus.interview.proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.InvocationHandler</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.Method</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.Proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>DynamicProxy</span> <span style=color:#a90d91>implements</span> <span style=color:#000>InvocationHandler</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>private</span> <span style=color:#000>Object</span> <span style=color:#000>target</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>bind</span>(<span style=color:#000>Object</span> <span style=color:#000>target</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>this</span>.<span style=color:#836c28>target</span> <span style=color:#000>=</span> <span style=color:#000>target</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#000>Proxy</span>.<span style=color:#836c28>newProxyInstance</span>(<span style=color:#000>target</span>.<span style=color:#836c28>getClass</span>().<span style=color:#836c28>getClassLoader</span>(),
</span></span><span style=display:flex><span>                                              <span style=color:#000>target</span>.<span style=color:#836c28>getClass</span>().<span style=color:#836c28>getInterfaces</span>(), 
</span></span><span style=display:flex><span>                                              <span style=color:#a90d91>this</span>); 
</span></span><span style=display:flex><span>		<span style=color:#177500>// 要绑定接口 this(这是一个缺陷，cglib 弥补了这一缺陷)</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>invoke</span>(<span style=color:#000>Object</span> <span style=color:#000>proxy</span>, <span style=color:#000>Method</span> <span style=color:#000>method</span>, <span style=color:#000>Object</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) <span style=color:#a90d91>throws</span> <span style=color:#000>Throwable</span> {
</span></span><span style=display:flex><span>		<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;------------------before------------------&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#000>Object</span> <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#000>method</span>.<span style=color:#836c28>invoke</span>(<span style=color:#000>target</span>, <span style=color:#000>args</span>);
</span></span><span style=display:flex><span>		<span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;-------------------after------------------&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#000>result</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(){
</span></span><span style=display:flex><span>    <span style=color:#000>DynamicProxy</span> <span style=color:#000>proxy</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DynamicProxy</span>();
</span></span><span style=display:flex><span>    <span style=color:#000>Subject</span> <span style=color:#000>subject</span><span style=color:#000>=</span> <span style=color:#000>proxy</span>.<span style=color:#836c28>bind</span>(<span style=color:#000>SubjectImpl</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>subject</span>.<span style=color:#836c28>request</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>和静态代理模式比较的好处</p><p>在静态代理模式时，一个真实角色必须对应一个代理角色，如果大量使用会导致类的急剧膨胀;而动态代理则不会有这个问题，我们将接口中的方法委托给 invoke 方法，并在 invoke 中实现拦截。</p><h3 id=源码分析>源码分析</h3><p>参考:http://rejoy.iteye.com/blog/1627405 主要原来：生成了一个代理类的 class 文件。Proxy.newProInstance() 方法</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#000>Object</span> <span style=color:#000>newProxyInstance</span>(<span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span>,<span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span>,<span style=color:#000>InvocationHandler</span> <span style=color:#000>h</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>throws</span> <span style=color:#000>IllegalArgumentException</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>h</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NullPointerException</span>();
</span></span><span style=display:flex><span>    }  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;[]</span> <span style=color:#000>intfs</span> <span style=color:#000>=</span> <span style=color:#000>interfaces</span>.<span style=color:#836c28>clone</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>final</span> <span style=color:#000>SecurityManager</span> <span style=color:#000>sm</span> <span style=color:#000>=</span> <span style=color:#000>System</span>.<span style=color:#836c28>getSecurityManager</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>sm</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>checkProxyAccess</span>(<span style=color:#000>Reflection</span>.<span style=color:#836c28>getCallerClass</span>(), <span style=color:#000>loader</span>, <span style=color:#000>intfs</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 这里是生成 class 的地方  </span>
</span></span><span style=display:flex><span>    <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>cl</span> <span style=color:#000>=</span> <span style=color:#000>getProxyClass0</span>(<span style=color:#000>loader</span>, <span style=color:#000>intfs</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// 使用我们实现的 InvocationHandler 作为参数调用构造方法来获得代理类的实例  </span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>final</span> <span style=color:#000>Constructor</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>cons</span> <span style=color:#000>=</span> <span style=color:#000>cl</span>.<span style=color:#836c28>getConstructor</span>(<span style=color:#000>constructorParams</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>final</span> <span style=color:#000>InvocationHandler</span> <span style=color:#000>ih</span> <span style=color:#000>=</span> <span style=color:#000>h</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>sm</span> <span style=color:#000>!=</span> <span style=color:#a90d91>null</span> <span style=color:#000>&amp;&amp;</span> <span style=color:#000>ProxyAccessHelper</span>.<span style=color:#836c28>needsNewInstanceCheck</span>(<span style=color:#000>cl</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#000>AccessController</span>.<span style=color:#836c28>doPrivileged</span>(<span style=color:#a90d91>new</span> <span style=color:#000>PrivilegedAction</span><span style=color:#000>&lt;</span><span style=color:#000>Object</span><span style=color:#000>&gt;</span>() {
</span></span><span style=display:flex><span>                <span style=color:#a90d91>public</span> <span style=color:#000>Object</span> <span style=color:#000>run</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>return</span> <span style=color:#000>newInstance</span>(<span style=color:#000>cons</span>, <span style=color:#000>ih</span>);
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span> <span style=color:#000>newInstance</span>(<span style=color:#000>cons</span>, <span style=color:#000>ih</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    } <span style=color:#a90d91>catch</span> (<span style=color:#000>NoSuchMethodException</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>InternalError</span>(<span style=color:#000>e</span>.<span style=color:#836c28>toString</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}  
</span></span></code></pre></div><p>其中 newInstance 只是调用 Constructor.newInstance 来构造相应的代理类实例，这里重点是看 getProxyClass0 这个方法的实现：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>getProxyClass0</span>(<span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span>,
</span></span><span style=display:flex><span>                                          <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span>... <span style=color:#000>interfaces</span>) {
</span></span><span style=display:flex><span>        <span style=color:#177500>// 代理的接口数量不能超过 65535，这是 class 文件格式决定的</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>interfaces</span>.<span style=color:#836c28>length</span> <span style=color:#000>&gt;</span> <span style=color:#000>65535</span>) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span>(<span style=color:#c41a16>&#34;interface limit exceeded&#34;</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#177500>// JDK 对代理进行了缓存，如果已经存在相应的代理类，则直接返回，否则才会通过 ProxyClassFactory 来创建代理</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>proxyClassCache</span>.<span style=color:#836c28>get</span>(<span style=color:#000>loader</span>, <span style=color:#000>interfaces</span>);
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>其中代理缓存是使用 WeakCache 实现的，如下</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>WeakCache</span><span style=color:#000>&lt;</span><span style=color:#000>ClassLoader</span>, <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;[]</span>, <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;&gt;</span>
</span></span><span style=display:flex><span>        <span style=color:#000>proxyClassCache</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>WeakCache</span><span style=color:#000>&lt;&gt;</span>(<span style=color:#a90d91>new</span> <span style=color:#000>KeyFactory</span>(), <span style=color:#a90d91>new</span> <span style=color:#000>ProxyClassFactory</span>());
</span></span></code></pre></div><p>具体的缓存逻辑这里暂不关心，只需要关心 ProxyClassFactory 是如何生成代理类的，ProxyClassFactory 是 Proxy 的一个静态内部类，实现了 WeakCache 的内部接口 BiFunction 的 apply 方法：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ProxyClassFactory</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>implements</span> <span style=color:#000>BiFunction</span><span style=color:#000>&lt;</span><span style=color:#000>ClassLoader</span>, <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;[]</span>, <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;&gt;</span> {
</span></span><span style=display:flex><span>        <span style=color:#177500>// 所有代理类名字的前缀</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>proxyClassNamePrefix</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;$Proxy&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#177500>// 用于生成代理类名字的计数器</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#000>AtomicLong</span> <span style=color:#000>nextUniqueNumber</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>AtomicLong</span>();
</span></span><span style=display:flex><span>        <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>public</span> <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>apply</span>(<span style=color:#000>ClassLoader</span> <span style=color:#000>loader</span>, <span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;[]</span> <span style=color:#000>interfaces</span>) {
</span></span><span style=display:flex><span>            <span style=color:#177500>// 省略验证代理接口的代码……</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>proxyPkg</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span>;     <span style=color:#177500>// 生成的代理类的包名</span>
</span></span><span style=display:flex><span>            <span style=color:#177500>// 对于非公共接口，代理类的包名与接口的相同</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>for</span> (<span style=color:#000>Class</span><span style=color:#000>&lt;?&gt;</span> <span style=color:#000>intf</span> : <span style=color:#000>interfaces</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a90d91>int</span> <span style=color:#000>flags</span> <span style=color:#000>=</span> <span style=color:#000>intf</span>.<span style=color:#836c28>getModifiers</span>();
</span></span><span style=display:flex><span>                <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>Modifier</span>.<span style=color:#836c28>isPublic</span>(<span style=color:#000>flags</span>)) {
</span></span><span style=display:flex><span>                    <span style=color:#000>String</span> <span style=color:#000>name</span> <span style=color:#000>=</span> <span style=color:#000>intf</span>.<span style=color:#836c28>getName</span>();
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>int</span> <span style=color:#000>n</span> <span style=color:#000>=</span> <span style=color:#000>name</span>.<span style=color:#836c28>lastIndexOf</span>(<span style=color:#2300ce>&#39;.&#39;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#000>String</span> <span style=color:#000>pkg</span> <span style=color:#000>=</span> ((<span style=color:#000>n</span> <span style=color:#000>==</span> <span style=color:#000>-</span><span style=color:#000>1</span>) <span style=color:#000>?</span> <span style=color:#c41a16>&#34;&#34;</span> : <span style=color:#000>name</span>.<span style=color:#836c28>substring</span>(<span style=color:#000>0</span>, <span style=color:#000>n</span> <span style=color:#000>+</span> <span style=color:#000>1</span>));
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>if</span> (<span style=color:#000>proxyPkg</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#000>proxyPkg</span> <span style=color:#000>=</span> <span style=color:#000>pkg</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#a90d91>else</span> <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>pkg</span>.<span style=color:#836c28>equals</span>(<span style=color:#000>proxyPkg</span>)) {
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span>(
</span></span><span style=display:flex><span>                            <span style=color:#c41a16>&#34;non-public interfaces from different packages&#34;</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#177500>// 对于公共接口的包名，默认为 com.sun.proxy[源码](http://hg.openjdk.java.net/jdk6/jdk6/jdk/rev/695dd7ceb9e3)</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>proxyPkg</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>proxyPkg</span> <span style=color:#000>=</span> <span style=color:#000>ReflectUtil</span>.<span style=color:#836c28>PROXY_PACKAGE</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;.&#34;</span>;
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>            <span style=color:#177500>// 获取计数</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>long</span> <span style=color:#000>num</span> <span style=color:#000>=</span> <span style=color:#000>nextUniqueNumber</span>.<span style=color:#836c28>getAndIncrement</span>();
</span></span><span style=display:flex><span>            <span style=color:#177500>// 默认情况下，代理类的完全限定名为:com.sun.proxy.$Proxy0,com.sun.proxy.$Proxy1……依次递增</span>
</span></span><span style=display:flex><span>            <span style=color:#000>String</span> <span style=color:#000>proxyName</span> <span style=color:#000>=</span> <span style=color:#000>proxyPkg</span> <span style=color:#000>+</span> <span style=color:#000>proxyClassNamePrefix</span> <span style=color:#000>+</span> <span style=color:#000>num</span>;
</span></span><span style=display:flex><span>            <span style=color:#177500>// 这里才是真正的生成代理类的字节码的地方</span>
</span></span><span style=display:flex><span>            <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>proxyClassFile</span> <span style=color:#000>=</span> <span style=color:#000>ProxyGenerator</span>.<span style=color:#836c28>generateProxyClass</span>(
</span></span><span style=display:flex><span>                <span style=color:#000>proxyName</span>, <span style=color:#000>interfaces</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>                <span style=color:#177500>// 根据二进制字节码返回相应的 Class 实例</span>
</span></span><span style=display:flex><span>                <span style=color:#a90d91>return</span> <span style=color:#000>defineClass0</span>(<span style=color:#000>loader</span>, <span style=color:#000>proxyName</span>,
</span></span><span style=display:flex><span>                                    <span style=color:#000>proxyClassFile</span>, <span style=color:#000>0</span>, <span style=color:#000>proxyClassFile</span>.<span style=color:#836c28>length</span>);
</span></span><span style=display:flex><span>            } <span style=color:#a90d91>catch</span> (<span style=color:#000>ClassFormatError</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>                <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IllegalArgumentException</span>(<span style=color:#000>e</span>.<span style=color:#836c28>toString</span>());
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>ProxyGenerator 是 sun.misc 包中的类，它没有开源，但是可以反编译来一探究竟：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>generateProxyClass</span>(<span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>var0</span>, <span style=color:#000>Class</span><span style=color:#000>[]</span> <span style=color:#000>var1</span>) {
</span></span><span style=display:flex><span>        <span style=color:#000>ProxyGenerator</span> <span style=color:#000>var2</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>ProxyGenerator</span>(<span style=color:#000>var0</span>, <span style=color:#000>var1</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>final</span> <span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>var3</span> <span style=color:#000>=</span> <span style=color:#000>var2</span>.<span style=color:#836c28>generateClassFile</span>();
</span></span><span style=display:flex><span>        <span style=color:#177500>// 这里根据参数配置，决定是否把生成的字节码（.class 文件）保存到本地磁盘，</span>
</span></span><span style=display:flex><span>        <span style=color:#177500>//我们可以通过把相应的 class 文件保存到本地，再反编译来看看具体的实现，这样更直观</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span>(<span style=color:#000>saveGeneratedFiles</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>AccessController</span>.<span style=color:#836c28>doPrivileged</span>(<span style=color:#a90d91>new</span> <span style=color:#000>PrivilegedAction</span>() {
</span></span><span style=display:flex><span>                <span style=color:#a90d91>public</span> <span style=color:#000>Void</span> <span style=color:#000>run</span>() {
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>                        <span style=color:#000>FileOutputStream</span> <span style=color:#000>var1</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileOutputStream</span>(<span style=color:#000>ProxyGenerator</span>.<span style=color:#836c28>dotToSlash</span>(<span style=color:#000>var0</span>) <span style=color:#000>+</span> <span style=color:#c41a16>&#34;.class&#34;</span>);
</span></span><span style=display:flex><span>                        <span style=color:#000>var1</span>.<span style=color:#836c28>write</span>(<span style=color:#000>var3</span>);
</span></span><span style=display:flex><span>                        <span style=color:#000>var1</span>.<span style=color:#836c28>close</span>();
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>return</span> <span style=color:#a90d91>null</span>;
</span></span><span style=display:flex><span>                    } <span style=color:#a90d91>catch</span> (<span style=color:#000>IOException</span> <span style=color:#000>var2</span>) {
</span></span><span style=display:flex><span>                        <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>InternalError</span>(<span style=color:#c41a16>&#34;I/O exception saving generated file: &#34;</span> <span style=color:#000>+</span> <span style=color:#000>var2</span>);
</span></span><span style=display:flex><span>                    }
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            });
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#000>var3</span>;
</span></span><span style=display:flex><span>    }
</span></span></code></pre></div><p>saveGeneratedFiles 这个属性的值从哪里来呢：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>saveGeneratedFiles</span> <span style=color:#000>=</span> ((<span style=color:#000>Boolean</span>)<span style=color:#000>AccessController</span>.<span style=color:#836c28>doPrivileged</span>(
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>GetBooleanAction</span>(<span style=color:#c41a16>&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span>))).<span style=color:#836c28>booleanValue</span>();
</span></span></code></pre></div><p>GetBooleanAction 实际上是调用 Boolean.getBoolean(propName) 来获得的，而 Boolean.getBoolean(propName) 调用了 System.getProperty(name),所以我们可以设置 sun.misc.ProxyGenerator.saveGeneratedFiles 这个系统属性为 true 来把生成的 class 保存到本地文件来查看。</p><p>反编译 class 文件</p><p>自己创建文件写入生成的动态代理类：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>angus.interview.proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.io.FileOutputStream</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.io.IOException</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>sun.misc.ProxyGenerator</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@SuppressWarnings</span>(<span style=color:#c41a16>&#34;restriction&#34;</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>ProxyGeneratorUtils</span> {
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>writeProxyClassToHardDisk</span>(<span style=color:#000>String</span> <span style=color:#000>path</span>) {
</span></span><span style=display:flex><span>		<span style=color:#177500>// 获取代理类的字节码</span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>byte</span><span style=color:#000>[]</span> <span style=color:#000>classFile</span> <span style=color:#000>=</span> <span style=color:#000>ProxyGenerator</span>.<span style=color:#836c28>generateProxyClass</span>(<span style=color:#c41a16>&#34;$Proxy11&#34;</span>, <span style=color:#000>SubjectImpl</span>.<span style=color:#836c28>class</span>.<span style=color:#836c28>getInterfaces</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#000>FileOutputStream</span> <span style=color:#000>out</span> <span style=color:#000>=</span> <span style=color:#a90d91>null</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>			<span style=color:#000>out</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>FileOutputStream</span>(<span style=color:#000>path</span>);
</span></span><span style=display:flex><span>			<span style=color:#000>out</span>.<span style=color:#836c28>write</span>(<span style=color:#000>classFile</span>);
</span></span><span style=display:flex><span>			<span style=color:#000>out</span>.<span style=color:#836c28>flush</span>();
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>catch</span> (<span style=color:#000>Exception</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>			<span style=color:#000>e</span>.<span style=color:#836c28>printStackTrace</span>();
</span></span><span style=display:flex><span>		} <span style=color:#a90d91>finally</span> {
</span></span><span style=display:flex><span>			<span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>				<span style=color:#000>out</span>.<span style=color:#836c28>close</span>();
</span></span><span style=display:flex><span>			} <span style=color:#a90d91>catch</span> (<span style=color:#000>IOException</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>				<span style=color:#000>e</span>.<span style=color:#836c28>printStackTrace</span>();
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>测试我们的工具类：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>angus.interview.proxy</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>TestProxy</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>static</span> <span style=color:#a90d91>void</span> <span style=color:#000>main</span>(<span style=color:#000>String</span><span style=color:#000>[]</span> <span style=color:#000>args</span>) {
</span></span><span style=display:flex><span>		<span style=color:#000>System</span>.<span style=color:#836c28>getProperties</span>().<span style=color:#836c28>put</span>(<span style=color:#c41a16>&#34;sun.misc.ProxyGenerator.saveGeneratedFiles&#34;</span>, <span style=color:#c41a16>&#34;true&#34;</span>);
</span></span><span style=display:flex><span>		<span style=color:#000>DynamicProxy</span> <span style=color:#000>proxy</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>DynamicProxy</span>();
</span></span><span style=display:flex><span>		<span style=color:#000>Subject</span> <span style=color:#000>sproxy</span> <span style=color:#000>=</span> (<span style=color:#000>Subject</span>) <span style=color:#000>proxy</span>.<span style=color:#836c28>bind</span>(<span style=color:#a90d91>new</span> <span style=color:#000>SubjectImpl</span>());
</span></span><span style=display:flex><span>		<span style=color:#000>sproxy</span>.<span style=color:#836c28>request</span>();
</span></span><span style=display:flex><span>		<span style=color:#000>ProxyGeneratorUtils</span>.<span style=color:#836c28>writeProxyClassToHardDisk</span>(<span style=color:#c41a16>&#34;$Proxy11.class&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>刷新目录，得到一个$Proxy11.class，反编译使用 Java Decompiler,GUI 傻瓜式，支持最新语法，编译慢，效果好：<br>可以看到<br>$Proxy11 继承 Proxy，并实现了 Subject，同时我们写的那个 InvocationHandler 的子类 DynamicProxy 也被传递进去了。<br>重点看 request 方法的代码，只有一行 <code>this.h.invoke(this, m3, null);</code>其中 h 的引用就是<code>DynamicProxy</code>.<br>m3 就是<code> m3 = Class.forName("angus.interview.proxy.Subject").getMethod("request", new Class[0]);</code></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>angus.interview.proxy.Subject</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.InvocationHandler</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.Method</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.Proxy</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.reflect.UndeclaredThrowableException</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>$Proxy11</span> <span style=color:#a90d91>extends</span> <span style=color:#000>Proxy</span>  <span style=color:#a90d91>implements</span> <span style=color:#000>Subject</span>
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Method</span> <span style=color:#000>m1</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Method</span> <span style=color:#000>m2</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Method</span> <span style=color:#000>m3</span>;
</span></span><span style=display:flex><span>  <span style=color:#a90d91>private</span> <span style=color:#a90d91>static</span> <span style=color:#000>Method</span> <span style=color:#000>m0</span>;
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#000>$Proxy11</span>(<span style=color:#000>InvocationHandler</span> <span style=color:#000>paramInvocationHandler</span>)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>super</span>(<span style=color:#000>paramInvocationHandler</span>);
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>equals</span>(<span style=color:#000>Object</span> <span style=color:#000>paramObject</span>)
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> ((<span style=color:#000>Boolean</span>)<span style=color:#a90d91>this</span>.<span style=color:#836c28>h</span>.<span style=color:#836c28>invoke</span>(<span style=color:#a90d91>this</span>, <span style=color:#000>m1</span>, <span style=color:#a90d91>new</span> <span style=color:#000>Object</span><span style=color:#000>[]</span> { <span style=color:#000>paramObject</span> })).<span style=color:#836c28>booleanValue</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Error</span><span style=color:#000>|</span><span style=color:#000>RuntimeException</span> <span style=color:#000>localError</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#000>localError</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Throwable</span> <span style=color:#000>localThrowable</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>UndeclaredThrowableException</span>(<span style=color:#000>localThrowable</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>toString</span>()
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> (<span style=color:#000>String</span>)<span style=color:#a90d91>this</span>.<span style=color:#836c28>h</span>.<span style=color:#836c28>invoke</span>(<span style=color:#a90d91>this</span>, <span style=color:#000>m2</span>, <span style=color:#a90d91>null</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Error</span><span style=color:#000>|</span><span style=color:#000>RuntimeException</span> <span style=color:#000>localError</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#000>localError</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Throwable</span> <span style=color:#000>localThrowable</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>UndeclaredThrowableException</span>(<span style=color:#000>localThrowable</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>void</span> <span style=color:#000>request</span>()
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>this</span>.<span style=color:#836c28>h</span>.<span style=color:#836c28>invoke</span>(<span style=color:#a90d91>this</span>, <span style=color:#000>m3</span>, <span style=color:#a90d91>null</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Error</span><span style=color:#000>|</span><span style=color:#000>RuntimeException</span> <span style=color:#000>localError</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#000>localError</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Throwable</span> <span style=color:#000>localThrowable</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>UndeclaredThrowableException</span>(<span style=color:#000>localThrowable</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>public</span> <span style=color:#a90d91>final</span> <span style=color:#a90d91>int</span> <span style=color:#000>hashCode</span>()
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span> ((<span style=color:#000>Integer</span>)<span style=color:#a90d91>this</span>.<span style=color:#836c28>h</span>.<span style=color:#836c28>invoke</span>(<span style=color:#a90d91>this</span>, <span style=color:#000>m0</span>, <span style=color:#a90d91>null</span>)).<span style=color:#836c28>intValue</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Error</span><span style=color:#000>|</span><span style=color:#000>RuntimeException</span> <span style=color:#000>localError</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#000>localError</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>Throwable</span> <span style=color:#000>localThrowable</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>UndeclaredThrowableException</span>(<span style=color:#000>localThrowable</span>);
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#a90d91>static</span>
</span></span><span style=display:flex><span>  {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#000>m1</span> <span style=color:#000>=</span> <span style=color:#000>Class</span>.<span style=color:#836c28>forName</span>(<span style=color:#c41a16>&#34;java.lang.Object&#34;</span>).<span style=color:#836c28>getMethod</span>(<span style=color:#c41a16>&#34;equals&#34;</span>, <span style=color:#a90d91>new</span> <span style=color:#000>Class</span><span style=color:#000>[]</span> { <span style=color:#000>Class</span>.<span style=color:#836c28>forName</span>(<span style=color:#c41a16>&#34;java.lang.Object&#34;</span>) });
</span></span><span style=display:flex><span>      <span style=color:#000>m2</span> <span style=color:#000>=</span> <span style=color:#000>Class</span>.<span style=color:#836c28>forName</span>(<span style=color:#c41a16>&#34;java.lang.Object&#34;</span>).<span style=color:#836c28>getMethod</span>(<span style=color:#c41a16>&#34;toString&#34;</span>, <span style=color:#a90d91>new</span> <span style=color:#000>Class</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>m3</span> <span style=color:#000>=</span> <span style=color:#000>Class</span>.<span style=color:#836c28>forName</span>(<span style=color:#c41a16>&#34;angus.interview.proxy.Subject&#34;</span>).<span style=color:#836c28>getMethod</span>(<span style=color:#c41a16>&#34;request&#34;</span>, <span style=color:#a90d91>new</span> <span style=color:#000>Class</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]</span>);
</span></span><span style=display:flex><span>      <span style=color:#000>m0</span> <span style=color:#000>=</span> <span style=color:#000>Class</span>.<span style=color:#836c28>forName</span>(<span style=color:#c41a16>&#34;java.lang.Object&#34;</span>).<span style=color:#836c28>getMethod</span>(<span style=color:#c41a16>&#34;hashCode&#34;</span>, <span style=color:#a90d91>new</span> <span style=color:#000>Class</span><span style=color:#000>[</span><span style=color:#000>0</span><span style=color:#000>]</span>);
</span></span><span style=display:flex><span>      <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>NoSuchMethodException</span> <span style=color:#000>localNoSuchMethodException</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NoSuchMethodError</span>(<span style=color:#000>localNoSuchMethodException</span>.<span style=color:#836c28>getMessage</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a90d91>catch</span> (<span style=color:#000>ClassNotFoundException</span> <span style=color:#000>localClassNotFoundException</span>)
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>NoClassDefFoundError</span>(<span style=color:#000>localClassNotFoundException</span>.<span style=color:#836c28>getMessage</span>());
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java-concurrency-3-threadlocal/>Java 并发 3-ThreadLocal</a></span>
<span class=post-nav-next><a href=../../post/java-annotation-processing/>Java 注解和注解处理器</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
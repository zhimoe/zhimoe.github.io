<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Java 注解和注解处理器 - 新街记事</title>
<meta property="og:title" content="Java 注解和注解处理器 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="注解是 jdk1.5 出现的，但是自定义处理注解的功能是 1.6 才有的。Element 等关于注解源码抽象的支持类都是 1.6 出现的。
[&amp;hellip;] annotation processing integrated into javac compiler since Java 6.0, known as pluggable annotation processing. compiler &amp;hellip;"><meta property="og:description" content="注解是 jdk1.5 出现的，但是自定义处理注解的功能是 1.6 才有的。Element 等关于注解源码抽象的支持类都是 1.6 出现的。
[&amp;hellip;] annotation processing integrated into javac compiler since Java 6.0, known as pluggable annotation processing. compiler &amp;hellip;"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css><link rel=icon type=image/png href=../../img/logo.png><link rel=apple-touch-icon href=../../img/logo.png><link rel=apple-touch-icon-precomposed href=../../img/logo.png></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Java 注解和注解处理器</h1><h3 class=meta-line><span><span class=date>2016-01-01</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/java/ class=term-tag>#java </a><a href=../../tags/code/ class=term-tag>#code</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#注解处理>注解处理</a></li><li><a href=#基本知识>基本知识</a></li><li><a href=#实战>实战</a></li><li><a href=#测试处理器>测试处理器</a></li><li><a href=#代码生成工具>代码生成工具</a></li><li><a href=#参考>参考</a></li></ul></nav><h3 id=注解处理>注解处理</h3><p>注解是 jdk1.5 出现的，但是自定义处理注解的功能是 1.6 才有的。Element 等关于注解源码抽象的支持类都是 1.6 出现的。</p><h3 id=基本知识>基本知识</h3><blockquote><p>annotation processing integrated into javac compiler since Java 6.0, known as <code>pluggable annotation processing</code>. compiler automatically searches for annotation processors unless disabled with <code>-proc:none </code>option for javac. processors can be specified explicitly with <code>-processor </code>option for javac or <code>-cp processor.jar</code>, <code>processor.jar</code> must include the <code>/META-INF/service/javax.annotation.processing.Processor</code> file and your processor decalared in file;</p></blockquote><p>implement a processor class:<br>– must implement <code>Processor</code> interface<br>– typically derived from <code>AbstractProcessor</code><br>– new package javax.annotation.processing</p><p>同时自定义注解处理器需要指定注解选项：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-fallback data-lang=fallback><span style=display:flex><span>– by means of annotations:
</span></span><span style=display:flex><span>@SupportedAnnotationTypes
</span></span><span style=display:flex><span>@SupportedOptions
</span></span><span style=display:flex><span>@SupportedSourceVersion
</span></span></code></pre></div><p>编译器编译源码是会有很多轮 (round)：</p><p>第一轮编译器得到所有的注解 - 获取所有的注解处理器 - 进行 match 并 process，如果匹配的处理器中 process 方法的返回值是<code>true</code>，表示该注解被 claim，不再查询其他处理器。如果是<code>false</code>，接着查询匹配处理器处理，所以注解处理器在 META-INF/services/javax.annotation.processing.Processor 声明顺序是有关系的&ndash; 所有的注解都被 claim 后，注解处理完成。</p><p>如果注解处理器产生新的 java 文件，那么新的一轮处理开始，前面被调用的那些处理器又被调用，直到没有 java 文件产生。</p><p>最后一轮又要调用一遍所有处理器，完成他们的各自工作。</p><p>最最后，编译器编译源码和注解处理器生成的源码。</p><p>还有一个很重要的类 AbstractProcessor：有一个引用 processingEnv<br>提供了两个重要工具类：<br>– <code>Filer</code> for creation of new source, class, or auxiliary files<br>– <code>Messager </code>to report errors, warnings, and other notices</p><p>此外，一个生成 java 文件的重要方法：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>FileObject</span> <span style=color:#000>sourceFile</span> <span style=color:#000>=</span> <span style=color:#000>processingEnv</span>.<span style=color:#836c28>getFiler</span>().<span style=color:#836c28>createSourceFile</span>(<span style=color:#000>beanClassName</span>);
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text><span style=display:flex><span>// process() method takes 2 arguments:
</span></span><span style=display:flex><span>Set&lt;? extends TypeElement&gt; annotations  
</span></span><span style=display:flex><span>– the annotation types requested to be processed  
</span></span><span style=display:flex><span>– subset of the supported annotations  
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>RoundEnvironment roundenv  
</span></span><span style=display:flex><span>– environment for information about the current and prior round  
</span></span><span style=display:flex><span>– supplies elements annotated with a given annotation or all root elements in the source  
</span></span></code></pre></div><p>一个自定义的注解处理器格式如下：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>@SupportedAnnotationTypes</span>({<span style=color:#c41a16>&#34;Property&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#000>@SupportedSourceVersion</span>(<span style=color:#000>SourceVersion</span>.<span style=color:#836c28>RELEASE_6</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>PropertyAnnotationProcessor</span> 
</span></span><span style=display:flex><span><span style=color:#a90d91>extends</span> <span style=color:#000>AbstractProcessor</span> {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>process</span>(
</span></span><span style=display:flex><span>		<span style=color:#000>Set</span><span style=color:#000>&lt;?</span> <span style=color:#a90d91>extends</span> <span style=color:#000>TypeElement</span><span style=color:#000>&gt;</span> <span style=color:#000>annotations</span>,
</span></span><span style=display:flex><span>	    <span style=color:#000>RoundEnvironment</span> <span style=color:#000>env</span>) {
</span></span><span style=display:flex><span>        <span style=color:#177500>// process the source file elements using the mirror API</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>jdk1.6 对注解的处理支持建立在对源码的抽象，Element 是<code>javax.lang.model.*</code>中定义的，各种 Element 是对源码抽象数据结构，如：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>com.example</span>;	    <span style=color:#177500>// PackageElement</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Foo</span> {		    <span style=color:#177500>// TypeElement</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>int</span> <span style=color:#000>a</span>;          <span style=color:#177500>// VariableElement</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#000>Foo</span> <span style=color:#000>other</span>;      <span style=color:#177500>// VariableElement</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#000>Foo</span> () {}        <span style=color:#177500>// ExecuteableElement</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>TypeElement 不能提供父类的信息，如果需要这些信息，需要从 Element 中得到 <code>TypeMirror.TypeMirror::element.asType()</code></p><h3 id=实战>实战</h3><p>动手写注解处理器：定义一个注解<code>@Comparator</code>，使用在方法上。通过一个注解处理器，解析所有被注释的方法，为每一个方法产生一个 Comparator 类。<br>一共三个类，注解定义，注解使用，注解处理器。</p><p>给出注解定义前看看注解怎么使用：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>moe.zhi</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>Name</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>first</span>;
</span></span><span style=display:flex><span>	<span style=color:#a90d91>private</span> <span style=color:#a90d91>final</span> <span style=color:#000>String</span> <span style=color:#000>last</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#000>Name</span>(<span style=color:#000>String</span> <span style=color:#000>f</span>, <span style=color:#000>String</span> <span style=color:#000>l</span>) {
</span></span><span style=display:flex><span>		<span style=color:#000>first</span> <span style=color:#000>=</span> <span style=color:#000>f</span>;
</span></span><span style=display:flex><span>		<span style=color:#000>last</span> <span style=color:#000>=</span> <span style=color:#000>l</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>@Comparator</span>(<span style=color:#c41a16>&#34;NameByFirstNameComparator&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>int</span> <span style=color:#000>compareToByFirstName</span>(<span style=color:#000>Name</span> <span style=color:#000>other</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> (<span style=color:#a90d91>this</span> <span style=color:#000>==</span> <span style=color:#000>other</span>)
</span></span><span style=display:flex><span>			<span style=color:#a90d91>return</span> <span style=color:#000>0</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>int</span> <span style=color:#000>result</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>if</span> ((<span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#a90d91>this</span>.<span style=color:#836c28>first</span>.<span style=color:#836c28>compareTo</span>(<span style=color:#000>other</span>.<span style=color:#836c28>first</span>)) <span style=color:#000>!=</span> <span style=color:#000>0</span>)
</span></span><span style=display:flex><span>			<span style=color:#a90d91>return</span> <span style=color:#000>result</span>;
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>this</span>.<span style=color:#836c28>last</span>.<span style=color:#836c28>compareTo</span>(<span style=color:#000>other</span>.<span style=color:#836c28>last</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>其中被注解注释的方法将产生一个 NameByFirstNameComparator.java 文件：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>moe.zhi</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>NameByFirstNameComparator</span> 
</span></span><span style=display:flex><span>  <span style=color:#a90d91>implements</span> <span style=color:#000>java</span>.<span style=color:#836c28>util</span>.<span style=color:#836c28>Comparator</span><span style=color:#000>&lt;</span><span style=color:#000>Name</span><span style=color:#000>&gt;</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>int</span> <span style=color:#000>compare</span>(<span style=color:#000>Name</span> <span style=color:#000>o1</span>, <span style=color:#000>Name</span> <span style=color:#000>o2</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#000>o1</span>.<span style=color:#836c28>compareToByFirstName</span>(<span style=color:#000>o2</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>equals</span>(<span style=color:#000>Object</span> <span style=color:#000>other</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a90d91>return</span> <span style=color:#a90d91>this</span>.<span style=color:#836c28>getClass</span>() <span style=color:#000>==</span> <span style=color:#000>other</span>.<span style=color:#836c28>getClass</span>();
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>定义注解：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>moe.zhi</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.annotation.Documented</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.annotation.ElementType</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.annotation.Retention</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.annotation.RetentionPolicy</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.lang.annotation.Target</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@Documented</span>
</span></span><span style=display:flex><span><span style=color:#000>@Target</span>(<span style=color:#000>ElementType</span>.<span style=color:#836c28>METHOD</span>)
</span></span><span style=display:flex><span><span style=color:#000>@Retention</span>(<span style=color:#000>RetentionPolicy</span>.<span style=color:#836c28>SOURCE</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#000>@interface</span> <span style=color:#000>Comparator</span> {
</span></span><span style=display:flex><span>	<span style=color:#000>String</span> <span style=color:#000>value</span>();
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来定义注解处理器，有详细注解，特别注意 generate 源码中的空格和分号不要弄丢了：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#a90d91>package</span> <span style=color:#000>moe.zhi</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.io.IOException</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.io.PrintWriter</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.util.Set</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.annotation.processing.AbstractProcessor</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.annotation.processing.RoundEnvironment</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.annotation.processing.SupportedAnnotationTypes</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.annotation.processing.SupportedSourceVersion</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.SourceVersion</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.element.Element</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.element.ExecutableElement</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.element.TypeElement</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.type.PrimitiveType</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.type.TypeKind</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.lang.model.type.TypeMirror</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.tools.Diagnostic</span>;
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>javax.tools.FileObject</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import static</span> <span style=color:#000>java.lang.StringTemplate.STR</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>@SupportedAnnotationTypes</span>({<span style=color:#c41a16>&#34;moe.zhi.Comparator&#34;</span>})
</span></span><span style=display:flex><span><span style=color:#000>@SupportedSourceVersion</span>(<span style=color:#000>SourceVersion</span>.<span style=color:#836c28>RELEASE_8</span>)
</span></span><span style=display:flex><span><span style=color:#a90d91>public</span> <span style=color:#a90d91>class</span> <span style=color:#3f6e75>MyProcessor</span> <span style=color:#a90d91>extends</span> <span style=color:#000>AbstractProcessor</span> {
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#000>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>public</span> <span style=color:#a90d91>boolean</span> <span style=color:#000>process</span>(<span style=color:#000>Set</span><span style=color:#000>&lt;?</span> <span style=color:#a90d91>extends</span> <span style=color:#000>TypeElement</span><span style=color:#000>&gt;</span> <span style=color:#000>annotations</span>, <span style=color:#000>RoundEnvironment</span> <span style=color:#000>roundEnv</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>for</span> (<span style=color:#a90d91>final</span> <span style=color:#000>Element</span> <span style=color:#000>element</span> : <span style=color:#000>roundEnv</span>.<span style=color:#836c28>getElementsAnnotatedWith</span>(<span style=color:#000>Comparator</span>.<span style=color:#836c28>class</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>element</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>ExecutableElement</span> <span style=color:#000>m</span>) {
</span></span><span style=display:flex><span>                <span style=color:#000>TypeElement</span> <span style=color:#000>className</span> <span style=color:#000>=</span> (<span style=color:#000>TypeElement</span>) <span style=color:#000>m</span>.<span style=color:#836c28>getEnclosingElement</span>();
</span></span><span style=display:flex><span>                <span style=color:#000>Comparator</span> <span style=color:#000>annotation</span> <span style=color:#000>=</span> <span style=color:#000>m</span>.<span style=color:#836c28>getAnnotation</span>(<span style=color:#000>Comparator</span>.<span style=color:#836c28>class</span>);
</span></span><span style=display:flex><span>                <span style=color:#a90d91>if</span> (<span style=color:#000>annotation</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#000>TypeMirror</span> <span style=color:#000>returnType</span> <span style=color:#000>=</span> <span style=color:#000>m</span>.<span style=color:#836c28>getReturnType</span>();
</span></span><span style=display:flex><span>                <span style=color:#a90d91>if</span> (<span style=color:#000>!</span>(<span style=color:#000>returnType</span> <span style=color:#a90d91>instanceof</span> <span style=color:#000>PrimitiveType</span>)
</span></span><span style=display:flex><span>                        <span style=color:#000>||</span> <span style=color:#000>returnType</span>.<span style=color:#836c28>getKind</span>() <span style=color:#000>!=</span> <span style=color:#000>TypeKind</span>.<span style=color:#836c28>INT</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#000>processingEnv</span>.<span style=color:#836c28>getMessager</span>().<span style=color:#836c28>printMessage</span>(<span style=color:#000>Diagnostic</span>.<span style=color:#836c28>Kind</span>.<span style=color:#836c28>ERROR</span>,
</span></span><span style=display:flex><span>                            <span style=color:#c41a16>&#34;@Comparator can only be applied to methods that return int&#34;</span>);
</span></span><span style=display:flex><span>                    <span style=color:#a90d91>continue</span>;
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>                <span style=color:#177500>// prepare for java file generation</span>
</span></span><span style=display:flex><span>                <span style=color:#000>String</span> <span style=color:#000>theProcessedClassesName</span> <span style=color:#000>=</span> <span style=color:#000>className</span>.<span style=color:#836c28>getQualifiedName</span>().<span style=color:#836c28>toString</span>();
</span></span><span style=display:flex><span>                <span style=color:#000>String</span> <span style=color:#000>comparatorClassName</span> <span style=color:#000>=</span> <span style=color:#000>annotation</span>.<span style=color:#836c28>value</span>();
</span></span><span style=display:flex><span>                <span style=color:#000>String</span> <span style=color:#000>compareToMethodName</span> <span style=color:#000>=</span> <span style=color:#000>m</span>.<span style=color:#836c28>getSimpleName</span>().<span style=color:#836c28>toString</span>();
</span></span><span style=display:flex><span>                <span style=color:#a90d91>try</span> {
</span></span><span style=display:flex><span>                    <span style=color:#000>writeComparatorFile</span>(<span style=color:#000>theProcessedClassesName</span>, <span style=color:#000>comparatorClassName</span>, <span style=color:#000>compareToMethodName</span>);
</span></span><span style=display:flex><span>                } <span style=color:#a90d91>catch</span> (<span style=color:#000>IOException</span> <span style=color:#000>e</span>) {
</span></span><span style=display:flex><span>                    <span style=color:#000>e</span>.<span style=color:#836c28>printStackTrace</span>();
</span></span><span style=display:flex><span>                }
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        } <span style=color:#177500>// end for</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>return</span> <span style=color:#a90d91>true</span>; <span style=color:#177500>// claimed now,no need next processor</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#177500>// be careful with spaces and &#34;;&#34; in content</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>private</span> <span style=color:#a90d91>void</span> <span style=color:#000>writeComparatorFile</span>(<span style=color:#000>String</span> <span style=color:#000>fullClassName</span>, <span style=color:#000>String</span> <span style=color:#000>comparatorClassName</span>, <span style=color:#000>String</span> <span style=color:#000>compareToMethodName</span>)
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throws</span> <span style=color:#000>IOException</span> {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>int</span> <span style=color:#000>lastIndexOfDot</span> <span style=color:#000>=</span> <span style=color:#000>fullClassName</span>.<span style=color:#836c28>lastIndexOf</span>(<span style=color:#c41a16>&#34;.&#34;</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>packageName</span> <span style=color:#000>=</span> <span style=color:#000>fullClassName</span>.<span style=color:#836c28>substring</span>(<span style=color:#000>0</span>, <span style=color:#000>lastIndexOfDot</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>FileObject</span> <span style=color:#000>sourceFile</span> <span style=color:#000>=</span> <span style=color:#000>processingEnv</span>.<span style=color:#836c28>getFiler</span>().<span style=color:#836c28>createSourceFile</span>(<span style=color:#000>packageName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;.&#34;</span> <span style=color:#000>+</span> <span style=color:#000>comparatorClassName</span>);
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>sourceFile</span> <span style=color:#000>==</span> <span style=color:#a90d91>null</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>System</span>.<span style=color:#836c28>out</span>.<span style=color:#836c28>println</span>(<span style=color:#c41a16>&#34;create source file failed&#34;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#000>IOException</span>(<span style=color:#c41a16>&#34;create source file failed:&#34;</span> <span style=color:#000>+</span> <span style=color:#000>packageName</span> <span style=color:#000>+</span> <span style=color:#c41a16>&#34;.&#34;</span> <span style=color:#000>+</span> <span style=color:#000>comparatorClassName</span>);
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#000>PrintWriter</span> <span style=color:#000>out</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>PrintWriter</span>(<span style=color:#000>sourceFile</span>.<span style=color:#836c28>openWriter</span>());
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#000>String</span> <span style=color:#000>parametrizedType</span> <span style=color:#000>=</span> <span style=color:#000>fullClassName</span>.<span style=color:#836c28>substring</span>(<span style=color:#000>lastIndexOfDot</span> <span style=color:#000>+</span> <span style=color:#000>1</span>); <span style=color:#177500>//!! careful the index</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>packageLine</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#34;&#34;</span>;
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>lastIndexOfDot</span> <span style=color:#000>&gt;</span> <span style=color:#000>0</span>) {
</span></span><span style=display:flex><span>            <span style=color:#000>packageLine</span> <span style=color:#000>=</span> <span style=color:#000>STR</span>.<span style=color:#c41a16>&#34;package \{ packageName };&#34;</span> ;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#177500>// 下面使用了 Java 21 的 STR 模板</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>var</span> <span style=color:#000>content</span> <span style=color:#000>=</span> <span style=color:#000>STR</span>.<span style=color:#c41a16>&#34;&#34;&#34;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                \{ packageLine }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                public class \{ comparatorClassName }  
</span></span></span><span style=display:flex><span><span style=color:#c41a16>				  implements java.util.Comparator&lt;\{ parametrizedType }&gt; {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                    public int compare( \{ parametrizedType } o1, 
</span></span></span><span style=display:flex><span><span style=color:#c41a16>					  \{ parametrizedType } o2 ){
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                        return o1.\{ compareToMethodName }(o2);
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                    }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                    public boolean equals(Object other) {
</span></span></span><span style=display:flex><span><span style=color:#c41a16>		                return this.getClass() == other.getClass();
</span></span></span><span style=display:flex><span><span style=color:#c41a16>	                }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                }
</span></span></span><span style=display:flex><span><span style=color:#c41a16>                &#34;&#34;&#34;</span> ;
</span></span><span style=display:flex><span>        <span style=color:#000>out</span>.<span style=color:#836c28>println</span>(<span style=color:#000>content</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>out</span>.<span style=color:#836c28>close</span>();
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h3 id=测试处理器>测试处理器</h3><h3 id=代码生成工具>代码生成工具</h3><p>方法 1：使用 <a href=https://github.com/square/javapoet>javapoet</a></p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#000>MethodSpec</span> <span style=color:#000>main</span> <span style=color:#000>=</span> <span style=color:#000>MethodSpec</span>.<span style=color:#836c28>methodBuilder</span>(<span style=color:#c41a16>&#34;main&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>addModifiers</span>(<span style=color:#000>Modifier</span>.<span style=color:#836c28>PUBLIC</span>, <span style=color:#000>Modifier</span>.<span style=color:#836c28>STATIC</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>returns</span>(<span style=color:#a90d91>void</span>.<span style=color:#836c28>class</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>addParameter</span>(<span style=color:#000>String</span><span style=color:#000>[]</span>.<span style=color:#836c28>class</span>, <span style=color:#c41a16>&#34;args&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>addStatement</span>(<span style=color:#c41a16>&#34;$T.out.println($S)&#34;</span>, <span style=color:#000>System</span>.<span style=color:#836c28>class</span>, <span style=color:#c41a16>&#34;Hello, JavaPoet!&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>TypeSpec</span> <span style=color:#000>helloWorld</span> <span style=color:#000>=</span> <span style=color:#000>TypeSpec</span>.<span style=color:#836c28>classBuilder</span>(<span style=color:#c41a16>&#34;HelloWorld&#34;</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>addModifiers</span>(<span style=color:#000>Modifier</span>.<span style=color:#836c28>PUBLIC</span>, <span style=color:#000>Modifier</span>.<span style=color:#836c28>FINAL</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>addMethod</span>(<span style=color:#000>main</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>JavaFile</span> <span style=color:#000>javaFile</span> <span style=color:#000>=</span> <span style=color:#000>JavaFile</span>.<span style=color:#836c28>builder</span>(<span style=color:#c41a16>&#34;com.example.helloworld&#34;</span>, <span style=color:#000>helloWorld</span>)
</span></span><span style=display:flex><span>    .<span style=color:#836c28>build</span>();
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>javaFile</span>.<span style=color:#836c28>writeTo</span>(<span style=color:#000>System</span>.<span style=color:#836c28>out</span>);
</span></span></code></pre></div><p>方法 2：使用 STR</p><p>参考上面的例子</p><h3 id=参考>参考</h3><p><a href=https://lotabout.me/2017/Notes-on-Java-Annotation-Processor/>java 注解</a></p><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86/>Java 动态代理</a></span>
<span class=post-nav-next><a href=../../post/java--and-equal/>Java-==-and-equals</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>
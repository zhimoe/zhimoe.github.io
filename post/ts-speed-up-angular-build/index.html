<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>使用 Happypack 优化 webpack 打包速度 - zhimoe</title>
<meta property="og:title" content="使用 Happypack 优化 webpack 打包速度 - zhimoe"><meta name=twitter:card content="summary"><meta property="description" content="一个 ionic app 本地编译需要 8 分钟，提交到流水线编译耗时需要近 40 分钟，从日志看到 webpack 打包步骤耗时最严重。
[&amp;hellip;] 初步判断是流水线使用的容器 CPU 性能较弱或者存储 mount 性能导致的。找流水线同事支持配置了一个纯内存编译流水线，发现还是很慢。接下来使用 webpack 的插件speed-measure-webpack-plugin监控性能。 &amp;hellip;"><meta property="og:description" content="一个 ionic app 本地编译需要 8 分钟，提交到流水线编译耗时需要近 40 分钟，从日志看到 webpack 打包步骤耗时最严重。
[&amp;hellip;] 初步判断是流水线使用的容器 CPU 性能较弱或者存储 mount 性能导致的。找流水线同事支持配置了一个纯内存编译流水线，发现还是很慢。接下来使用 webpack 的插件speed-measure-webpack-plugin监控性能。 &amp;hellip;"><meta name=twitter:image content="https://jsd.cdn.zzko.cn/gh/zhimoe/zhimoe.pic@main/pic/happypack.1p8mivl0t3k0.webp"><link rel=stylesheet href=https://zhimoe.github.io/css/style.css><link rel=stylesheet href=https://zhimoe.github.io/css/fonts.css><link rel=stylesheet href=https://zhimoe.github.io/css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=https://zhimoe.github.io/>新街记事</a></div><div class=menu><span class=active><a href=https://zhimoe.github.io/post/>博客</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=https://zhimoe.github.io/categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=https://zhimoe.github.io/search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>使用 Happypack 优化 webpack 打包速度</h1><h3 class=meta-line><span><span class=date>2021-09-12</span>
</span><span class=term><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=https://zhimoe.github.io/tags/code/ class=term-tag>#code </a><a href=https://zhimoe.github.io/tags/js/ class=term-tag>#JS </a><a href=https://zhimoe.github.io/tags/webpack/ class=term-tag>#webpack</a></span></h3></div><div class=main><h3 id=问题>问题</h3><p>一个 ionic app 本地编译需要 8 分钟，提交到流水线编译耗时需要近 40 分钟，从日志看到 webpack 打包步骤耗时最严重。</p><h3 id=排查与解决>排查与解决</h3><p>初步判断是流水线使用的容器 CPU 性能较弱或者存储 mount 性能导致的。找流水线同事支持配置了一个纯内存编译流水线，发现还是很慢。接下来使用 webpack 的插件<a href=https://www.npmjs.com/package/speed-measure-webpack-plugin>speed-measure-webpack-plugin</a>监控性能。</p><p>在 webpack.config.js 配置：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#177500>// webpack.config.js
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span><span style=color:#177500>// npm i --save-dev speed-measure-webpack-plugin
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>const</span> <span style=color:#000>SpeedMeasurePlugin</span> <span style=color:#000>=</span> <span style=color:#000>require</span>(<span style=color:#c41a16>&#34;speed-measure-webpack-plugin&#34;</span>);
</span></span><span style=display:flex><span><span style=color:#a90d91>const</span> <span style=color:#000>smp</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>SpeedMeasurePlugin</span>();
</span></span><span style=display:flex><span><span style=color:#177500>// ...the webpack configuration
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>const</span> <span style=color:#000>prodConfig</span> <span style=color:#000>=</span> {<span style=color:#177500>/*...*/</span>}
</span></span><span style=display:flex><span><span style=color:#000>module</span>.<span style=color:#000>exports</span> <span style=color:#000>=</span> {
</span></span><span style=display:flex><span>    <span style=color:#000>prod</span><span style=color:#000>:</span> <span style=color:#000>smp</span>.<span style=color:#000>wrap</span>(<span style=color:#000>prodConfig</span>)
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>得到下图左侧的结果，可以看到主要耗时都在 angular 的 PurifyPlugin 上。搜索了一番后找到 HappPack 这个多核执行的插件。<br><img src=https://jsd.cdn.zzko.cn/gh/zhimoe/zhimoe.pic@main/pic/happypack.1p8mivl0t3k0.webp alt=smp-result-before-and-after-happypack><br>配置 happypack，由于主要耗时都在<code>const PurifyPlugin = require('@angular-devkit/build-optimizer').PurifyPlugin;</code>插件上，这里只需要针对这一个插件配置 happypack 即可。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=display:flex><span><span style=color:#177500>// webpack.config.js
</span></span></span><span style=display:flex><span><span style=color:#177500>// 
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>const</span> <span style=color:#000>HappyPack</span> <span style=color:#000>=</span> <span style=color:#000>require</span>(<span style=color:#c41a16>&#39;happypack&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a90d91>const</span> <span style=color:#000>os</span> <span style=color:#000>=</span> <span style=color:#000>require</span>(<span style=color:#c41a16>&#39;os&#39;</span>);<span style=color:#177500>//获取 cpu core 数量
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span><span style=color:#177500>//loaders 配置
</span></span></span><span style=display:flex><span><span style=color:#177500></span>{
</span></span><span style=display:flex><span>    <span style=color:#000>test</span><span style=color:#000>:</span> <span style=color:#c41a16>/\.ts$/</span>, 
</span></span><span style=display:flex><span>    <span style=color:#000>use</span><span style=color:#000>:</span> [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#000>loader</span><span style=color:#000>:</span> <span style=color:#c41a16>&#39;happypack/loader?id=ts&#39;</span>, <span style=color:#177500>// 在所有 loader 之前加上 happypack/loader,id 是 plugins 中定义的
</span></span></span><span style=display:flex><span><span style=color:#177500></span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#000>loader</span><span style=color:#000>:</span> <span style=color:#000>process</span>.<span style=color:#000>env</span>.<span style=color:#000>IONIC_CACHE_LOADER</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#000>loader</span><span style=color:#000>:</span> <span style=color:#c41a16>&#39;@angular-devkit/build-optimizer/webpack-loader&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>options</span><span style=color:#000>:</span> {
</span></span><span style=display:flex><span>            <span style=color:#000>sourceMap</span><span style=color:#000>:</span> <span style=color:#a90d91>true</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>        <span style=color:#000>loader</span><span style=color:#000>:</span> <span style=color:#000>process</span>.<span style=color:#000>env</span>.<span style=color:#000>IONIC_WEBPACK_LOADER</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    ]
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// 在 plugins 中配置 happypack 插件
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#000>plugins</span><span style=color:#000>:</span> [
</span></span><span style=display:flex><span>    <span style=color:#000>ionicWebpackFactory</span>.<span style=color:#000>getIonicEnvironmentPlugin</span>(),
</span></span><span style=display:flex><span>    <span style=color:#000>ionicWebpackFactory</span>.<span style=color:#000>getCommonChunksPlugin</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>ModuleConcatPlugin</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>PurifyPlugin</span>(),
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>HappyPack</span>({
</span></span><span style=display:flex><span>        <span style=color:#000>id</span><span style=color:#000>:</span> <span style=color:#c41a16>&#39;js&#39;</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>threads</span><span style=color:#000>:</span> <span style=color:#000>os</span>.<span style=color:#000>cpus</span>().<span style=color:#000>length</span>,
</span></span><span style=display:flex><span>        <span style=color:#000>loaders</span><span style=color:#000>:</span> [<span style=color:#c41a16>&#39;@angular-devkit/build-optimizer/webpack-loader&#39;</span>]
</span></span><span style=display:flex><span>    }),
</span></span><span style=display:flex><span>    <span style=color:#a90d91>new</span> <span style=color:#000>HappyPack</span>({
</span></span><span style=display:flex><span>        <span style=color:#000>id</span><span style=color:#000>:</span> <span style=color:#c41a16>&#39;ts&#39;</span>, <span style=color:#177500>// 在 loader 中使用
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>threads</span><span style=color:#000>:</span> <span style=color:#000>os</span>.<span style=color:#000>cpus</span>().<span style=color:#000>length</span>, <span style=color:#177500>// 开启操作系统 cpu 的最大核心数
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#000>loaders</span><span style=color:#000>:</span> [<span style=color:#c41a16>&#39;@angular-devkit/build-optimizer/webpack-loader&#39;</span>]
</span></span><span style=display:flex><span>    })
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>]
</span></span></code></pre></div><p>再次本地执行，性能提升巨大。在流水线上测试，两次 build 都在 15 分钟左右。</p><nav class="post-nav fullwidth"><span>&larr; <a href=https://zhimoe.github.io/post/python-tips-for-impatient-dev/>Python Tips for Impatient Dev</a></span>
<span><a href=https://zhimoe.github.io/post/nodejs-as-githook/>在 githook 中调用 nodejs 脚本</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/center-img.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/alt-title.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/external-link.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=https://zhimoe.github.io/categories/>Categories</a> <a href=https://zhimoe.github.io/tags/>Tags</a>
<a href=https://zhimoe.github.io/post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
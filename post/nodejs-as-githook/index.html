<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>在 githook 中调用 nodejs 脚本 - zhimoe</title>
<meta property="og:title" content="在 githook 中调用 nodejs 脚本 - zhimoe"><meta name=twitter:card content="summary"><meta property="description" content="如何在 git hook 中调用 nodejs 脚本。主要踩坑在于不知道如何在 bash 中获取 node 脚本返回值，搜了好大一圈。
[&amp;hellip;] 微服务模式开发中，每个小组维护自己的应用，通过一个 nginx 入口反向代理所有的子应用，向用户开放一个站点.nginx 应用中需要维护各个子应用的代理，即 ng.conf 中的 location.
此外， &amp;hellip;"><meta property="og:description" content="如何在 git hook 中调用 nodejs 脚本。主要踩坑在于不知道如何在 bash 中获取 node 脚本返回值，搜了好大一圈。
[&amp;hellip;] 微服务模式开发中，每个小组维护自己的应用，通过一个 nginx 入口反向代理所有的子应用，向用户开放一个站点.nginx 应用中需要维护各个子应用的代理，即 ng.conf 中的 location.
此外， &amp;hellip;"><link rel=stylesheet href=https://zhimoe.github.io/css/style.css><link rel=stylesheet href=https://zhimoe.github.io/css/fonts.css><link rel=stylesheet href=https://zhimoe.github.io/css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=https://zhimoe.github.io/>新街记事</a></div><div class=menu><span class=active><a href=https://zhimoe.github.io/post/>博客</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=https://zhimoe.github.io/categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=https://zhimoe.github.io/search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>在 githook 中调用 nodejs 脚本</h1><h3 class=meta-line><span><span class=date>2021-08-22</span>
</span><span class=term><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=https://zhimoe.github.io/tags/code/ class=term-tag>#code </a><a href=https://zhimoe.github.io/tags/nodejs/ class=term-tag>#nodejs</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#背景>背景</a></li><li><a href=#需求>需求</a></li><li><a href=#实现>实现</a></li></ul></nav><p>如何在 git hook 中调用 nodejs 脚本。主要踩坑在于不知道如何在 bash 中获取 node 脚本返回值，搜了好大一圈。</p><h2 id=背景>背景</h2><p>微服务模式开发中，每个小组维护自己的应用，通过一个 nginx 入口反向代理所有的子应用，向用户开放一个站点.nginx 应用中需要维护各个子应用的代理，即 ng.conf 中的 location.<br>此外，一个应用需要配置 DEV,ST,UAT,PRD 四个环境的 location.目前的做法是 www/ngconf/目录下面分为 dev、st、uat、prd 四个文件夹，在文件夹内部每个小组各自维护一个 conf 文件。<br>每增加一个应用，需要在四个文件夹中自己小组的配置文件添加配置。随着应用越来越多，以及人员流动，会发生不同文件配置相同的 location entry.<br>例如 A 应用上线一个功能需要依赖 B 应用，但是新人不知道 B 已经配置过了，所以又重复添加了一个，导致启动报错。</p><h2 id=需求>需求</h2><p>入口应用是一个 nodejs 应用，自然选择了 js 脚本检查 conf 文件 location path 配置是否重复。</p><h2 id=实现>实现</h2><p>在 git hook 目录下，新增一个<code>pre-commit</code>文件，添加内容：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#633820>#!/usr/bin/sh
</span></span></span><span style=display:flex><span><span style=color:#633820></span><span style=color:#177500># 检查项目中同一个目录下面的nginx conf 所有location是否重复</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>[</span> -e ./ngconf_check.js <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    node ngconf_check.js
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>[[</span> <span style=color:#000>$?</span> !<span style=color:#000>=</span> <span style=color:#1c01ce>0</span> <span style=color:#000>]]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>echo</span> &gt;&amp;<span style=color:#1c01ce>2</span> fix duplicate location entry in nginx conf
</span></span><span style=display:flex><span>        <span style=color:#a90d91>exit</span> <span style=color:#1c01ce>1</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500># 如果项目有自定义pre-commit,执行</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span> <span style=color:#000>[</span> -e ./.git/hooks/pre-commit <span style=color:#000>]</span>; <span style=color:#a90d91>then</span>
</span></span><span style=display:flex><span>    ./.git/hooks/pre-commit <span style=color:#c41a16>&#34;</span><span style=color:#000>$@</span><span style=color:#c41a16>&#34;</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>fi</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>exit</span> <span style=color:#1c01ce>0</span>
</span></span></code></pre></div><p>要点：bash 中<code>$?</code>表示获取上命令的返回值。这里获得的是 js 脚本的 process.exit(code) 返回的 code. 默认返回是 0.</p><p>ngconf_check.js:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#177500>// 检查 ng conf 是否有重复的 location entry
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>const</span> <span style=color:#000>fs</span> <span style=color:#000>=</span> <span style=color:#000>require</span>(<span style=color:#c41a16>&#39;fs&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a90d91>const</span> <span style=color:#000>path</span> <span style=color:#000>=</span> <span style=color:#000>require</span>(<span style=color:#c41a16>&#39;path&#39;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>const</span> <span style=color:#000>ConfEnvDirs</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Set</span>();
</span></span><span style=display:flex><span><span style=color:#000>ConfEnvDirs</span>.<span style=color:#000>add</span>(<span style=color:#c41a16>&#39;dev&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#000>ConfEnvDirs</span>.<span style=color:#000>add</span>(<span style=color:#c41a16>&#39;st&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#000>ConfEnvDirs</span>.<span style=color:#000>add</span>(<span style=color:#c41a16>&#39;uat&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#000>ConfEnvDirs</span>.<span style=color:#000>add</span>(<span style=color:#c41a16>&#39;prd&#39;</span>);
</span></span><span style=display:flex><span><span style=color:#a90d91>const</span> <span style=color:#000>NgconfPath</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#39;www/ngconf&#39;</span>;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>let</span> <span style=color:#000>result</span> <span style=color:#000>=</span> <span style=color:#c41a16>&#39;pass&#39;</span>;
</span></span><span style=display:flex><span><span style=color:#000>countLocationInDir</span>(<span style=color:#000>NgconfPath</span>);
</span></span><span style=display:flex><span><span style=color:#a90d91>if</span>(<span style=color:#000>result</span> <span style=color:#000>!==</span> <span style=color:#c41a16>&#39;pass&#39;</span>){
</span></span><span style=display:flex><span>    <span style=color:#000>process</span>.<span style=color:#000>exit</span>(<span style=color:#1c01ce>1</span>);<span style=color:#177500>//向 bash 返回 1
</span></span></span><span style=display:flex><span><span style=color:#177500></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>/**
</span></span></span><span style=display:flex><span><span style=color:#177500> *
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param rootPath
</span></span></span><span style=display:flex><span><span style=color:#177500> */</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>function</span> <span style=color:#000>countLocationInDir</span>(<span style=color:#000>rootPath</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> (<span style=color:#000>!</span><span style=color:#000>fs</span>.<span style=color:#000>existsSync</span>(<span style=color:#000>rootPath</span>)) <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>dirs</span> <span style=color:#000>=</span> <span style=color:#000>fs</span>.<span style=color:#000>readdirSync</span>(<span style=color:#000>rootPath</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>dirs</span>.<span style=color:#000>forEach</span>(<span style=color:#000>dir</span> =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>let</span> <span style=color:#000>envDir</span> <span style=color:#000>=</span> <span style=color:#000>path</span>.<span style=color:#000>join</span>(<span style=color:#000>rootPath</span>, <span style=color:#000>dir</span>);
</span></span><span style=display:flex><span>        <span style=color:#177500>//只处理四个环境目录下的 conf 文件，每个目录用一个 map 记录
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>const</span> <span style=color:#000>LocationEntryMap</span> <span style=color:#000>=</span> <span style=color:#a90d91>new</span> <span style=color:#000>Map</span>();<span style=color:#177500>//location entry -&gt; file,line
</span></span></span><span style=display:flex><span><span style=color:#177500></span>        <span style=color:#a90d91>if</span> (<span style=color:#000>!</span>(<span style=color:#000>fs</span>.<span style=color:#000>statSync</span>(<span style=color:#000>envDir</span>).<span style=color:#000>isDirectory</span>() <span style=color:#000>&amp;&amp;</span> <span style=color:#000>ConfEnvDirs</span>.<span style=color:#000>has</span>(<span style=color:#000>dir</span>))) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>return</span>;
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#a90d91>let</span> <span style=color:#000>confFiles</span> <span style=color:#000>=</span> <span style=color:#000>fs</span>.<span style=color:#000>readdirSync</span>(<span style=color:#000>envDir</span>);
</span></span><span style=display:flex><span>        <span style=color:#000>confFiles</span>.<span style=color:#000>forEach</span>(<span style=color:#000>filename</span> =&gt; {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>let</span> <span style=color:#000>fullPath</span> <span style=color:#000>=</span> <span style=color:#000>path</span>.<span style=color:#000>join</span>(<span style=color:#000>envDir</span>, <span style=color:#000>filename</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>fs</span>.<span style=color:#000>lstatSync</span>(<span style=color:#000>fullPath</span>).<span style=color:#000>isFile</span>() <span style=color:#000>&amp;&amp;</span> <span style=color:#c41a16>/[\w\W.].conf$/</span>.<span style=color:#000>test</span>(<span style=color:#000>filename</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#000>countLocationsInFile</span>(<span style=color:#000>fullPath</span>, <span style=color:#000>LocationEntryMap</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        });
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>/**
</span></span></span><span style=display:flex><span><span style=color:#177500> *
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param confFile
</span></span></span><span style=display:flex><span><span style=color:#177500> * @param countMap
</span></span></span><span style=display:flex><span><span style=color:#177500> */</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>function</span> <span style=color:#000>countLocationsInFile</span>(<span style=color:#000>confFile</span>, <span style=color:#000>countMap</span>) {
</span></span><span style=display:flex><span>    <span style=color:#a90d91>let</span> <span style=color:#000>lines</span> <span style=color:#000>=</span> <span style=color:#000>fs</span>.<span style=color:#000>readFileSync</span>(<span style=color:#000>confFile</span>, <span style=color:#c41a16>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#000>split</span>(<span style=color:#c41a16>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>        .<span style=color:#000>filter</span>(<span style=color:#a90d91>Boolean</span>);
</span></span><span style=display:flex><span>    <span style=color:#000>lines</span>.<span style=color:#000>forEach</span>((<span style=color:#000>line</span>, <span style=color:#000>lineNumber</span>) =&gt; {
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> (<span style=color:#000>line</span>.<span style=color:#000>trim</span>().<span style=color:#000>startsWith</span>(<span style=color:#c41a16>&#34;location&#34;</span>)) {
</span></span><span style=display:flex><span>            <span style=color:#a90d91>const</span> <span style=color:#000>arr</span> <span style=color:#000>=</span> <span style=color:#000>line</span>.<span style=color:#000>trim</span>().<span style=color:#000>split</span>(<span style=color:#c41a16>&#39; &#39;</span>);
</span></span><span style=display:flex><span>            <span style=color:#a90d91>const</span> <span style=color:#000>locationEntry</span> <span style=color:#000>=</span> <span style=color:#000>arr</span>[<span style=color:#1c01ce>1</span>];
</span></span><span style=display:flex><span>            <span style=color:#a90d91>const</span> <span style=color:#000>entryInfo</span> <span style=color:#000>=</span> <span style=color:#c41a16>`</span><span style=color:#c41a16>${</span><span style=color:#000>confFile</span><span style=color:#c41a16>}</span><span style=color:#c41a16>, at line:</span><span style=color:#c41a16>${</span><span style=color:#000>lineNumber</span><span style=color:#c41a16>}</span><span style=color:#c41a16>`</span>;
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> (<span style=color:#000>countMap</span>.<span style=color:#000>has</span>(<span style=color:#000>locationEntry</span>)) {
</span></span><span style=display:flex><span>                <span style=color:#000>console</span>.<span style=color:#000>log</span>(<span style=color:#c41a16>`ERROR: duplicate location entry: </span><span style=color:#c41a16>${</span><span style=color:#000>locationEntry</span><span style=color:#c41a16>}</span><span style=color:#c41a16>`</span>);
</span></span><span style=display:flex><span>                <span style=color:#000>console</span>.<span style=color:#000>log</span>(<span style=color:#c41a16>`location 1:</span><span style=color:#c41a16>${</span><span style=color:#000>countMap</span>.<span style=color:#000>get</span>(<span style=color:#000>locationEntry</span>)<span style=color:#c41a16>}</span><span style=color:#c41a16>`</span>);
</span></span><span style=display:flex><span>                <span style=color:#000>console</span>.<span style=color:#000>log</span>(<span style=color:#c41a16>`location 2:</span><span style=color:#c41a16>${</span><span style=color:#000>entryInfo</span><span style=color:#c41a16>}</span><span style=color:#c41a16>`</span>);                
</span></span><span style=display:flex><span>                <span style=color:#177500>//修改 result 变量
</span></span></span><span style=display:flex><span><span style=color:#177500></span>                <span style=color:#000>result</span><span style=color:#000>=</span><span style=color:#c41a16>&#39;error&#39;</span>;
</span></span><span style=display:flex><span>            } <span style=color:#a90d91>else</span> {
</span></span><span style=display:flex><span>                <span style=color:#000>countMap</span>.<span style=color:#000>set</span>(<span style=color:#000>locationEntry</span>, <span style=color:#000>entryInfo</span>);
</span></span><span style=display:flex><span>            }
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>    });
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=https://zhimoe.github.io/post/ts-speed-up-angular-build/>使用 Happypack 优化 webpack 打包速度</a></span>
<span><a href=https://zhimoe.github.io/post/ts-comprehensive-notes/>Typescript Comprehensive Cheatsheet</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/katex/dist/katex.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/math-code.min.js defer></script><script src=//cdn.jsdelivr.net/combine/npm/katex/dist/katex.min.js,npm/katex/dist/contrib/auto-render.min.js,npm/@xiee/utils/js/render-katex.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=https://zhimoe.github.io/categories/>Categories</a> <a href=https://zhimoe.github.io/tags/>Tags</a>
<a href=https://zhimoe.github.io/post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
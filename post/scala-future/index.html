<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Scala Future - zhimoe</title>
<meta property="og:title" content="Scala Future - zhimoe"><meta name=twitter:card content="summary"><meta property="description" content="some notes on scala future, includes:
[&amp;hellip;] import java.time._ import scala.concurrent._ import ExecutionContext.Implicits.global Future { Thread.sleep(10000) println(s&amp;#34;This is the future at &amp;hellip;"><meta property="og:description" content="some notes on scala future, includes:
[&amp;hellip;] import java.time._ import scala.concurrent._ import ExecutionContext.Implicits.global Future { Thread.sleep(10000) println(s&amp;#34;This is the future at &amp;hellip;"><link rel=stylesheet href=https://zhimoe.github.io/css/style.css><link rel=stylesheet href=https://zhimoe.github.io/css/fonts.css><link rel=stylesheet href=https://zhimoe.github.io/css/custom.css><link rel=stylesheet href=https://indestructibletype.com/fonts/Jost.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=https://zhimoe.github.io/>新街记事</a></div><div class=menu><span class=active><a href=https://zhimoe.github.io/post/>博客</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=https://zhimoe.github.io/categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=https://zhimoe.github.io/categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=https://zhimoe.github.io/search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Scala Future</h1><h3 class=meta-line><span><span class=date>2019-04-21</span>
</span><span class=term><a href=https://zhimoe.github.io/categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=https://zhimoe.github.io/tags/code/ class=term-tag>#code </a><a href=https://zhimoe.github.io/tags/scala/ class=term-tag>#scala</a></span></h3></div><div class=main><nav id=TableOfContents><ul><li><a href=#future>future</a></li><li><a href=#executor-context>executor context</a></li><li><a href=#await-for-future-result>await for future result</a></li><li><a href=#callback>callback</a></li><li><a href=#callback-hell>callback hell</a></li></ul></nav><p>some notes on scala future, includes:</p><ul><li><input checked disabled type=checkbox> future</li><li><input checked disabled type=checkbox> executor context</li><li><input checked disabled type=checkbox> await future result</li><li><input checked disabled type=checkbox> callback</li><li><input disabled type=checkbox> recover</li></ul><h2 id=future>future</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>java.time._</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>scala.concurrent._</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>import</span> <span style=color:#000>ExecutionContext.Implicits.global</span>
</span></span><span style=display:flex><span><span style=color:#3f6e75>Future</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#3f6e75>Thread</span><span style=color:#000>.</span><span style=color:#000>sleep</span><span style=color:#000>(</span><span style=color:#1c01ce>10000</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;This is the future at </span><span style=color:#c41a16>${</span><span style=color:#3f6e75>LocalTime</span><span style=color:#000>.</span><span style=color:#000>now</span><span style=color:#c41a16>}</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;This is the present at </span><span style=color:#c41a16>${</span><span style=color:#3f6e75>LocalTime</span><span style=color:#000>.</span><span style=color:#000>now</span><span style=color:#c41a16>}</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span></code></pre></div><h2 id=executor-context>executor context</h2><p>future need a new thread to execute it task. <code>import ExecutionContext.Implicits.global</code> is a implicit threadpool.</p><h2 id=await-for-future-result>await for future result</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#177500>// for 10.seconds conversion
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>import</span> <span style=color:#000>scala.concurrent.duration._</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>f</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#3f6e75>Thread</span><span style=color:#000>.</span><span style=color:#000>sleep</span><span style=color:#000>(</span><span style=color:#1c01ce>10000</span><span style=color:#000>);</span> <span style=color:#1c01ce>42</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>result</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Await</span><span style=color:#000>.</span><span style=color:#000>result</span><span style=color:#000>(</span><span style=color:#000>f</span><span style=color:#000>,</span> <span style=color:#3f6e75>Duration</span><span style=color:#000>.</span><span style=color:#3f6e75>Inf</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// if f throw exception, it will rethrow to Await.result
</span></span></span><span style=display:flex><span><span style=color:#177500>// use ready() solve this
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>val</span> <span style=color:#000>f</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>...</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#3f6e75>Await</span><span style=color:#000>.</span><span style=color:#000>ready</span><span style=color:#000>(</span><span style=color:#000>f</span><span style=color:#000>,</span> <span style=color:#1c01ce>10.</span><span style=color:#000>seconds</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#3f6e75>Some</span><span style=color:#000>(</span><span style=color:#000>t</span><span style=color:#000>)</span> <span style=color:#a90d91>=</span> <span style=color:#000>f</span><span style=color:#000>.</span><span style=color:#000>value</span>
</span></span><span style=display:flex><span><span style=color:#177500>// The f.value method returns an Option[Try[T]], 
</span></span></span><span style=display:flex><span><span style=color:#177500>// which is None when the future is not completed
</span></span></span><span style=display:flex><span><span style=color:#177500>// and Some(t) when it is is
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span><span style=color:#177500>// t is Try type instance
</span></span></span><span style=display:flex><span><span style=color:#177500>// A Try[T] instance is either a Success(v), where v is a value of type T or a Failure(ex)
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>val</span> <span style=color:#000>t</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Some</span><span style=color:#000>(</span><span style=color:#000>t</span><span style=color:#000>).</span><span style=color:#000>get</span>
</span></span><span style=display:flex><span><span style=color:#000>t</span> <span style=color:#a90d91>match</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>case</span> <span style=color:#3f6e75>Success</span><span style=color:#000>(</span><span style=color:#000>v</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;The answer is </span><span style=color:#c41a16>$v</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>case</span> <span style=color:#3f6e75>Failure</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#000>getMessage</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#177500>// or
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>t</span><span style=color:#000>.</span><span style=color:#000>isSuccess</span><span style=color:#000>)</span> <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;The answer is </span><span style=color:#c41a16>${</span><span style=color:#000>t</span><span style=color:#000>.</span><span style=color:#000>get</span><span style=color:#c41a16>}</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span></code></pre></div><h2 id=callback>callback</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>f</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#3f6e75>Thread</span><span style=color:#000>.</span><span style=color:#000>sleep</span><span style=color:#000>(</span><span style=color:#1c01ce>10000</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>if</span> <span style=color:#000>(</span><span style=color:#000>random</span><span style=color:#000>()</span> <span style=color:#000>&lt;</span> <span style=color:#1c01ce>0.5</span><span style=color:#000>)</span> <span style=color:#a90d91>throw</span> <span style=color:#a90d91>new</span> <span style=color:#3f6e75>Exception</span>
</span></span><span style=display:flex><span>  <span style=color:#1c01ce>42</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#000>f</span><span style=color:#000>.</span><span style=color:#000>onComplete</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Success</span><span style=color:#000>(</span><span style=color:#000>v</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;The answer is </span><span style=color:#c41a16>$v</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Failure</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>.</span><span style=color:#000>getMessage</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span></code></pre></div><h2 id=callback-hell>callback hell</h2><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-scala data-lang=scala><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>future1</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>getData1</span><span style=color:#000>()</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>future2</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>getData2</span><span style=color:#000>()</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>future1</span> <span style=color:#000>onComplete</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Success</span><span style=color:#000>(</span><span style=color:#000>n1</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>future2</span> <span style=color:#000>onComplete</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Success</span><span style=color:#000>(</span><span style=color:#000>n2</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>{</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>val</span> <span style=color:#000>n</span> <span style=color:#a90d91>=</span> <span style=color:#000>n1</span> <span style=color:#000>+</span> <span style=color:#000>n2</span>
</span></span><span style=display:flex><span>        <span style=color:#000>println</span><span style=color:#000>(</span><span style=color:#c41a16>s&#34;Result: </span><span style=color:#c41a16>$n</span><span style=color:#c41a16>&#34;</span><span style=color:#000>)</span>
</span></span><span style=display:flex><span>      <span style=color:#000>}</span>
</span></span><span style=display:flex><span>      <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Failure</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>...</span>
</span></span><span style=display:flex><span>    <span style=color:#000>}</span>
</span></span><span style=display:flex><span>  <span style=color:#a90d91>case</span> <span style=color:#3f6e75>Failure</span><span style=color:#000>(</span><span style=color:#000>ex</span><span style=color:#000>)</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#000>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// improve
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>val</span> <span style=color:#000>future1</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>getData1</span><span style=color:#000>()</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>combined</span> <span style=color:#a90d91>=</span> <span style=color:#000>future1</span><span style=color:#000>.</span><span style=color:#000>map</span><span style=color:#000>(</span><span style=color:#000>n1</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>n1</span> <span style=color:#000>+</span> <span style=color:#000>getData2</span><span style=color:#000>())</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// 
</span></span></span><span style=display:flex><span><span style=color:#177500></span><span style=color:#a90d91>val</span> <span style=color:#000>future1</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>getData1</span><span style=color:#000>()</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>future2</span> <span style=color:#a90d91>=</span> <span style=color:#3f6e75>Future</span> <span style=color:#000>{</span> <span style=color:#000>getData2</span><span style=color:#000>()</span> <span style=color:#000>}</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>val</span> <span style=color:#000>combined</span> <span style=color:#a90d91>=</span> <span style=color:#000>future1</span><span style=color:#000>.</span><span style=color:#000>map</span><span style=color:#000>(</span><span style=color:#000>n1</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>future2</span><span style=color:#000>.</span><span style=color:#000>map</span><span style=color:#000>(</span><span style=color:#000>n2</span> <span style=color:#a90d91>=&gt;</span> <span style=color:#000>n1</span> <span style=color:#000>+</span> <span style=color:#000>n2</span><span style=color:#000>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#177500>// use for-yield
</span></span></span><span style=display:flex><span><span style=color:#177500></span>
</span></span><span style=display:flex><span><span style=color:#a90d91>for</span> <span style=color:#000>(</span>
</span></span><span style=display:flex><span>  <span style=color:#000>n1</span> <span style=color:#a90d91>&lt;-</span> <span style=color:#000>future1</span>
</span></span><span style=display:flex><span>  <span style=color:#000>n2</span> <span style=color:#a90d91>&lt;-</span> <span style=color:#000>future2</span>
</span></span><span style=display:flex><span><span style=color:#000>)</span> <span style=color:#a90d91>yield</span> <span style=color:#000>n1</span><span style=color:#000>+</span><span style=color:#000>n2</span>
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=https://zhimoe.github.io/post/scala-useful-snippets/>Useful Scala Code Snippets</a></span>
<span><a href=https://zhimoe.github.io/post/draft/spring-cache-notes/>Spring Cache Notes</a> &rarr;</span></nav></div><footer class=small><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fix-toc.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/key-buttons.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/key-buttons.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>ZhiMoe</a> © 2024</span>
<span class=menu-bottom><a href=https://zhimoe.github.io/categories/>Categories</a> <a href=https://zhimoe.github.io/tags/>Tags</a>
<a href=https://zhimoe.github.io/post/index.xml type=application/rss+xml title="RSS feed">Subscribe</a>
<a href=#>Back to Top</a></span></p></footer></body></html>
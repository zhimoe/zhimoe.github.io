<!doctype html><html lang=zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Python @contextlib.contextmanager 的使用 - 新街记事</title>
<meta property="og:title" content="Python @contextlib.contextmanager 的使用 - 新街记事"><meta name=twitter:card content="summary"><meta property="description" content="日常开发中使用这个注解的情况比较少，今天发现其实有一个临时环境变量设置的使用方式。"><meta property="og:description" content="日常开发中使用这个注解的情况比较少，今天发现其实有一个临时环境变量设置的使用方式。"><link rel=stylesheet href=../../css/style.css><link rel=stylesheet href=../../css/fonts.css><link rel=stylesheet href=../../css/custom.css></head><body class="single post"><div class=crop-h></div><div class=crop-v></div><div class=crop-c></div><nav class="nav-top small"><div class=logo><a href=../../>新街记事</a></div><div class=menu><span class=active><a href=../../post/>博客</a></span>
<span><a href=../../categories/%E7%BC%96%E7%A8%8B/>编程</a></span>
<span><a href=../../categories/%E7%BF%BB%E8%AF%91/>翻译</a></span>
<span><a href=../../categories/%E9%9A%8F%E6%83%B3/>随想</a></span>
<span><a href=../../search/>搜索</a></span></div></nav><div class=article-meta><h1 class=title>Python @contextlib.contextmanager 的使用</h1><h3 class=meta-line><span><span class=date>2023-11-05</span>
</span><span class=term><a href=../../categories/%E7%BC%96%E7%A8%8B/ class=term-cat>编程</a>
<a href=../../tags/code/ class=term-tag>#code </a><a href=../../tags/python/ class=term-tag>#python</a></span></h3></div><div class=main><p>日常开发中使用这个注解的情况比较少，今天发现其实有一个临时环境变量设置的使用方式。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#000>set_environ</span>(<span style=color:#000>env_name</span>, <span style=color:#000>value</span>):
</span></span><span style=display:flex><span>    <span style=color:#177500># 使用后自动清除 env_name 变量</span>
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#177500># env_name 已失效</span>
</span></span></code></pre></div><h3 id=可关闭资源的管理>可关闭资源的管理</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#5b269a>self</span><span style=color:#000>.</span><span style=color:#000>_operation_context</span>() <span style=color:#a90d91>as</span> <span style=color:#000>conn</span>:
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span><span style=display:flex><span>    <span style=color:#177500># 使用数据库 connection</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>def</span> <span style=color:#000>_operation_context</span>(<span style=color:#5b269a>self</span>) <span style=color:#000>-&gt;</span> <span style=color:#000>Generator</span>[<span style=color:#000>Connection</span>, <span style=color:#a90d91>None</span>, <span style=color:#a90d91>None</span>]:
</span></span><span style=display:flex><span>    <span style=color:#c41a16>&#34;&#34;&#34;Return a context that optimizes for multiple operations on a single
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    transaction.
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    This essentially allows connect()/close() to be called if we detected
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    that we&#39;re against an :class:`_engine.Engine` and not a
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    :class:`_engine.Connection`.
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>conn</span>: <span style=color:#000>Connection</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#5b269a>self</span><span style=color:#000>.</span><span style=color:#000>_op_context_requires_connect</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>conn</span> <span style=color:#000>=</span> <span style=color:#5b269a>self</span><span style=color:#000>.</span><span style=color:#000>bind</span><span style=color:#000>.</span><span style=color:#000>connect</span>()  <span style=color:#177500># type: ignore[union-attr]</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>else</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>conn</span> <span style=color:#000>=</span> <span style=color:#5b269a>self</span><span style=color:#000>.</span><span style=color:#000>bind</span>  <span style=color:#177500># type: ignore[assignment]</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#a90d91>yield</span> <span style=color:#000>conn</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>finally</span>:
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#5b269a>self</span><span style=color:#000>.</span><span style=color:#000>_op_context_requires_connect</span>:
</span></span><span style=display:flex><span>            <span style=color:#000>conn</span><span style=color:#000>.</span><span style=color:#000>close</span>()
</span></span></code></pre></div><h3 id=临时环境变量的设置与清除>临时环境变量的设置与清除</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#a90d91>with</span> <span style=color:#000>set_environ</span>(<span style=color:#c41a16>&#39;LOCAL_PROXY&#39;</span>, <span style=color:#000>value</span>):
</span></span><span style=display:flex><span>    <span style=color:#177500># LOCAL_PROXY  now is value</span>
</span></span><span style=display:flex><span>    <span style=color:#000>...</span>
</span></span><span style=display:flex><span><span style=color:#177500># 环境变量中 LOCAL_PROXY 已恢复（删除或者前值）</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#000>@contextlib.contextmanager</span>
</span></span><span style=display:flex><span><span style=color:#a90d91>def</span> <span style=color:#000>set_environ</span>(<span style=color:#000>env_name</span>, <span style=color:#000>value</span>):
</span></span><span style=display:flex><span>    <span style=color:#c41a16>&#34;&#34;&#34;Set the environment variable &#39;env_name&#39; to &#39;value&#39;
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    Save previous value, yield, and then restore the previous value stored in
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    the environment variable &#39;env_name&#39;.
</span></span></span><span style=display:flex><span><span style=color:#c41a16>
</span></span></span><span style=display:flex><span><span style=color:#c41a16>    If &#39;value&#39; is None, do nothing&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    <span style=color:#000>value_changed</span> <span style=color:#000>=</span> <span style=color:#000>value</span> <span style=color:#000>is</span> <span style=color:#000>not</span> <span style=color:#a90d91>None</span>
</span></span><span style=display:flex><span>    <span style=color:#000>old_value</span> <span style=color:#000>=</span> <span style=color:#000>os</span><span style=color:#000>.</span><span style=color:#000>environ</span><span style=color:#000>.</span><span style=color:#000>get</span>(<span style=color:#000>env_name</span>)
</span></span><span style=display:flex><span>    <span style=color:#a90d91>if</span> <span style=color:#000>value_changed</span>:
</span></span><span style=display:flex><span>        <span style=color:#000>os</span><span style=color:#000>.</span><span style=color:#000>environ</span>[<span style=color:#000>env_name</span>] <span style=color:#000>=</span> <span style=color:#000>value</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>try</span>:
</span></span><span style=display:flex><span>        <span style=color:#a90d91>yield</span> <span style=color:#177500># 这里无需 yield 具体值，只是利用副作用</span>
</span></span><span style=display:flex><span>    <span style=color:#a90d91>finally</span>:
</span></span><span style=display:flex><span>    <span style=color:#177500># 需要恢复原来的变量</span>
</span></span><span style=display:flex><span>        <span style=color:#a90d91>if</span> <span style=color:#000>value_changed</span>:
</span></span><span style=display:flex><span>            <span style=color:#a90d91>if</span> <span style=color:#000>old_value</span> <span style=color:#000>is</span> <span style=color:#a90d91>None</span>:
</span></span><span style=display:flex><span>                <span style=color:#a90d91>del</span> <span style=color:#000>os</span><span style=color:#000>.</span><span style=color:#000>environ</span>[<span style=color:#000>env_name</span>] 
</span></span><span style=display:flex><span>            <span style=color:#a90d91>else</span>:
</span></span><span style=display:flex><span>                <span style=color:#000>os</span><span style=color:#000>.</span><span style=color:#000>environ</span>[<span style=color:#000>env_name</span>] <span style=color:#000>=</span> <span style=color:#000>old_value</span>
</span></span></code></pre></div><nav class="post-nav fullwidth"><span>&larr; <a href=../../post/java-vector-api-with-es/>Java Vector Api 和 Elasticsearch 性能提升</a></span>
<span><a href=../../post/programming-font-fangsongcode/>支持中文的等宽编程字体：FangSongCode</a> &rarr;</span></nav></div><footer class=small><link rel=stylesheet href=//cdn.jsdelivr.net/gh/rstudio/markdown/inst/resources/prism-xcode.css><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-core.min.js defer></script><script src=//cdn.jsdelivr.net/npm/prismjs@1.29.0/plugins/autoloader/prism-autoloader.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/copy-button.min.js defer></script><link rel=stylesheet href=//cdn.jsdelivr.net/npm/@xiee/utils/css/copy-button.min.css><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/heading-anchor.min.js defer></script><script src=//cdn.jsdelivr.net/npm/@xiee/utils/js/fullwidth.min.js defer></script><hr><p class=nav-bottom><span><a href=https://zhi.moe>xdh</a> © 2024</span>
<span class=menu-bottom><a href=../../categories/>分类</a> <a href=../../tags/>标签</a>
<a href=../../post/index.xml type=application/rss+xml title="RSS feed">订阅</a>
<a href=#>回到顶部</a></span></p></footer></body></html>